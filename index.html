<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="接下来自己能够坚持写博客，记录是一个好习惯">
<meta property="og:type" content="website">
<meta property="og:title" content="YoferZhang 的博客">
<meta property="og:url" content="http://yoferzhang.com/index.html">
<meta property="og:site_name" content="YoferZhang 的博客">
<meta property="og:description" content="接下来自己能够坚持写博客，记录是一个好习惯">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="YoferZhang 的博客">
<meta name="twitter:description" content="接下来自己能够坚持写博客，记录是一个好习惯">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '6264833925474944000',
      author: 'Yofer'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoferzhang.com/"/>





  <title> YoferZhang 的博客 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">YoferZhang 的博客</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle">数学出身，功底扎实，热爱编程，虽然编程起步晚，但是冲劲十足。</p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoferzhang.com/post/20170116ViewControllerProgrammingGuide/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Yofer Zhang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="http://ww2.sinaimg.cn/mw690/a9c4d5f6jw1e3siexaeopj.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="YoferZhang 的博客">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="YoferZhang 的博客" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/20170116ViewControllerProgrammingGuide/" itemprop="url">
                  为什么要在viewDidLoad 中加载view，在viewWillAppear:中对view进行layout？
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-16T09:50:48+08:00">
                2017-01-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/post/20170116ViewControllerProgrammingGuide/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="post/20170116ViewControllerProgrammingGuide/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="为什么要在viewDidLoad-中加载view，在viewWillAppear-中对view进行layout？"><a href="#为什么要在viewDidLoad-中加载view，在viewWillAppear-中对view进行layout？" class="headerlink" title="为什么要在viewDidLoad 中加载view，在viewWillAppear:中对view进行layout？"></a>为什么要在<code>viewDidLoad</code> 中加载view，在<code>viewWillAppear:</code>中对view进行layout？</h2><p>记得前辈以前说过他的习惯是在<code>viewDidLoad</code>中对子view进行初始化，并添加到<code>self.view</code>中；然后在<code>viewWillAppear:</code>中对子view进行layout。具体原因不太理解，最近看到iOS官方推荐的的确是这种做法。</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/post/20170116ViewControllerProgrammingGuide/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoferzhang.com/post/20161130DataManager/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Yofer Zhang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="http://ww2.sinaimg.cn/mw690/a9c4d5f6jw1e3siexaeopj.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="YoferZhang 的博客">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="YoferZhang 的博客" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/20161130DataManager/" itemprop="url">
                  【iOS】iOS数据存储,应用沙盒,XML,Preference,NSKeyedArchiver归档,SQLite3
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-30T21:02:30+08:00">
                2016-11-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/post/20161130DataManager/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="post/20161130DataManager/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>版权声明：本文为博主原创，如需转载请注明出处。</p>
</blockquote>
<h2 id="应用沙盒"><a href="#应用沙盒" class="headerlink" title="应用沙盒"></a>应用沙盒</h2><p>每个iOS应用都有自己的应用沙盒(应用沙盒就是文件系统目录)，与其他文件系统隔离。应用必须待在自己的沙盒里，其他应用不能访问该沙盒</p>
<p>应用沙盒的文件系统目录，如下图所示（假设应用的名称叫Layer）</p>
<p><img src="http://ww3.sinaimg.cn/mw690/a9c4d5f6gw1f74k2pntm4j20ck08v0uc.jpg" alt=""></p>
<p>模拟器应用沙盒的根路径在: (apple是用户名, 6.0是模拟器版本)<br>/Users/apple/Library/Application Support/iPhone Simulator/6.0/Applications</p>
<p>在使用Xcode5的时候，模拟器中的app可以在电脑如下路径找到：</p>
<p>/Users/用户名/Library/Application Support/iPhone Simulator/系统版本号/Applications</p>
<p>而在Xcode6环境下，存放位置已经发生了变化。</p>
<p>调查发现，新的路径变成了/Users/{YOUR NAME}/Library/Developer/CoreSimulator/Devices/设备型号/data/Containers</p>
<p>其中设备型号是用uuid表示的，可以用如下命令获取它们之间的对应关系(stackoverflow)：<code>xcrun simctl list</code><br>再往下，app和本地文件已经分开放了：app在Bundle/Application下；本地文件在Data/Application下<br>每个目录下都是一堆uuid命名的文件夹，很难区分。</p>
<p>找的时候可以通过在app运行时打印bundle路径和NSHomeDirectory()发现具体路径。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">➜  Devices xcrun simctl list</span><br><span class="line">== Device Types ==</span><br><span class="line">iPhone 4s (com.apple.CoreSimulator.SimDeviceType.iPhone-4s)</span><br><span class="line">iPhone 5 (com.apple.CoreSimulator.SimDeviceType.iPhone-5)</span><br><span class="line">iPhone 5s (com.apple.CoreSimulator.SimDeviceType.iPhone-5s)</span><br><span class="line">iPhone 6 (com.apple.CoreSimulator.SimDeviceType.iPhone-6)</span><br><span class="line">iPhone 6 Plus (com.apple.CoreSimulator.SimDeviceType.iPhone-6-Plus)</span><br><span class="line">iPhone 6s (com.apple.CoreSimulator.SimDeviceType.iPhone-6s)</span><br><span class="line">iPhone 6s Plus (com.apple.CoreSimulator.SimDeviceType.iPhone-6s-Plus)</span><br><span class="line">iPad 2 (com.apple.CoreSimulator.SimDeviceType.iPad-2)</span><br><span class="line">iPad Retina (com.apple.CoreSimulator.SimDeviceType.iPad-Retina)</span><br><span class="line">iPad Air (com.apple.CoreSimulator.SimDeviceType.iPad-Air)</span><br><span class="line">iPad Air 2 (com.apple.CoreSimulator.SimDeviceType.iPad-Air-2)</span><br><span class="line">iPad Pro (com.apple.CoreSimulator.SimDeviceType.iPad-Pro)</span><br><span class="line">Apple TV 1080p (com.apple.CoreSimulator.SimDeviceType.Apple-TV-1080p)</span><br><span class="line">Apple Watch - 38mm (com.apple.CoreSimulator.SimDeviceType.Apple-Watch-38mm)</span><br><span class="line">Apple Watch - 42mm (com.apple.CoreSimulator.SimDeviceType.Apple-Watch-42mm)</span><br><span class="line">== Runtimes ==</span><br><span class="line">iOS 9.0 (9.0 - 13A344) (com.apple.CoreSimulator.SimRuntime.iOS-9-0)</span><br><span class="line">iOS 9.1 (9.1 - 13B143) (com.apple.CoreSimulator.SimRuntime.iOS-9-1)</span><br><span class="line">iOS 9.2 (9.2 - 13C75) (com.apple.CoreSimulator.SimRuntime.iOS-9-2)</span><br><span class="line">iOS 9.3 (9.3 - 13E230) (com.apple.CoreSimulator.SimRuntime.iOS-9-3)</span><br><span class="line">tvOS 9.2 (9.2 - 13Y227) (com.apple.CoreSimulator.SimRuntime.tvOS-9-2)</span><br><span class="line">watchOS 2.2 (2.2 - 13V143) (com.apple.CoreSimulator.SimRuntime.watchOS-2-2)</span><br><span class="line">== Devices ==</span><br><span class="line">-- iOS 9.0 --</span><br><span class="line">    iPhone 4s (41931634-624C-4AB8-8652-9EFA6E816379) (Shutdown)</span><br><span class="line">    iPhone 5 (3A03D3D9-35BC-4AFC-8D3A-AA729DFA4417) (Shutdown)</span><br><span class="line">    iPhone 5s (9091604E-CB39-4089-B594-336212024A21) (Shutdown)</span><br><span class="line">    iPhone 6 (CB81F1ED-3B3F-407A-BF58-E5E932D253E2) (Shutdown)</span><br><span class="line">    iPhone 6 Plus (F166EB11-39BB-4EFA-87E3-0ADD79849409) (Shutdown)</span><br><span class="line">    iPhone 6s (F6487BC7-400C-4A91-A950-2A18B9558DC3) (Shutdown)</span><br><span class="line">    iPhone 6s Plus (1E17B5B9-9765-4306-A646-3253620178AE) (Shutdown)</span><br><span class="line">    iPad 2 (5C4751E6-1CA2-418C-891F-3C450C91DCE7) (Shutdown)</span><br><span class="line">    iPad Retina (14F984F6-3E7E-4BB3-A6F8-3EF337058DCF) (Shutdown)</span><br><span class="line">    iPad Air (C492DDAF-7CE3-45D3-9734-9EB221DF8EC3) (Shutdown)</span><br><span class="line">    iPad Air 2 (4136305D-8F47-4CD4-BED3-B274162E4223) (Shutdown)</span><br><span class="line">-- iOS 9.1 --</span><br><span class="line">    iPhone 4s (20F804F4-3551-4975-8FAD-99B387FA7101) (Shutdown)</span><br><span class="line">    iPhone 5 (DF220FF8-4AD7-486D-9701-3DC532BF3190) (Shutdown)</span><br><span class="line">    iPhone 5s (89EC0AF7-2799-47C5-8CA6-26D978153FAE) (Shutdown)</span><br><span class="line">    iPhone 6 (873A48E8-DF55-46AA-9895-D723BFD65262) (Shutdown)</span><br><span class="line">    iPhone 6 Plus (2AC4B279-5B83-4EB3-BB6F-511FFBE8602E) (Shutdown)</span><br><span class="line">    iPhone 6s (86F1DE4C-B407-457C-B170-82FEE1FBA1DD) (Shutdown)</span><br><span class="line">    iPhone 6s Plus (AFA83ACE-0FE5-4814-81EB-189100A2D8B3) (Shutdown)</span><br><span class="line">    iPad 2 (33CE0EA4-F9AF-43FA-A5AE-8784ABB6DBB8) (Shutdown)</span><br><span class="line">    iPad Retina (EFA3EEE6-DBBB-424C-A1EB-988FE40C6E01) (Shutdown)</span><br><span class="line">    iPad Air (05398825-A9A4-41F2-8E91-DD1651E27C4C) (Shutdown)</span><br><span class="line">    iPad Air 2 (2F805563-E2E5-4708-A846-CBFB8F23BB98) (Shutdown)</span><br><span class="line">    iPad Pro (D2A724F2-BDEB-4D2E-AF83-3CD1A2DF929A) (Shutdown)</span><br><span class="line">-- iOS 9.2 --</span><br><span class="line">    iPhone 4s (FFB2BDB2-B759-4F40-A396-A38A43D946E5) (Shutdown)</span><br><span class="line">    iPhone 5 (A60C4213-F011-4DBA-8E94-CCD8214E7B04) (Shutdown)</span><br><span class="line">    iPhone 5s (6A6F57A5-1057-4187-B034-AB085349DF6B) (Shutdown)</span><br><span class="line">    iPhone 6 (F9B18CA1-0D31-4077-9F4B-B94C195E0E67) (Shutdown)</span><br><span class="line">    iPhone 6 Plus (B9D38A37-C004-485B-83A9-C442AA92D644) (Shutdown)</span><br><span class="line">    iPhone 6s (9F8EB146-B2A2-4F1F-84CC-32D33E0A7187) (Shutdown)</span><br><span class="line">    iPhone 6s Plus (E09E8DE5-F60C-4F30-9144-B45A7DF9ED98) (Shutdown)</span><br><span class="line">    iPad 2 (92EE4298-E5FD-4408-93EF-554AF18EE12D) (Shutdown)</span><br><span class="line">    iPad Retina (B1DD1D12-F67A-4EC4-9833-1B6989BB8A45) (Shutdown)</span><br><span class="line">    iPad Air (3F1980FD-3C5B-43CF-834C-B4869B9A89C8) (Shutdown)</span><br><span class="line">    iPad Air 2 (42802305-9282-4A19-9B3B-5EBA3163B6EF) (Shutdown)</span><br><span class="line">    iPad Pro (02A937DA-694D-40DE-B1EE-604D8F46AD8F) (Shutdown)</span><br><span class="line">-- iOS 9.3 --</span><br><span class="line">    iPhone 4s (BDE69A93-B858-4B5A-AB3F-CAD796FCC045) (Shutdown)</span><br><span class="line">    iPhone 5 (A95F5000-7E2A-455E-B847-9212722A4136) (Shutdown)</span><br><span class="line">    iPhone 5s (E5D555C0-C723-4338-BFCF-B5E2E669FE54) (Shutdown)</span><br><span class="line">    iPhone 6 (9226B68B-5702-4953-947B-0E655FADDE12) (Shutdown)</span><br><span class="line">    iPhone 6 Plus (C4E60731-2679-4237-8E24-AC9512DF9E9E) (Shutdown)</span><br><span class="line">    iPhone 6s (6F7F28DE-CE2A-40DE-B91B-203EA774B275) (Booted)</span><br><span class="line">    iPhone 6s Plus (115B2F18-065F-490B-9EAB-9C63B0BDE1CF) (Shutdown)</span><br><span class="line">    iPad 2 (EF2F1963-B398-45E8-A609-170F0F09E6AA) (Shutdown)</span><br><span class="line">    iPad Retina (0F830533-9A66-46EE-B0F8-388E12E41FCF) (Shutdown)</span><br><span class="line">    iPad Air (04ED9886-705E-4E63-9322-6EF1E04D2578) (Shutdown)</span><br><span class="line">    iPad Air 2 (816C1B6D-6F7F-4A41-A952-A84BFECE6230) (Shutdown)</span><br><span class="line">    iPad Pro (ECD0C28F-28CE-4CAB-A7C3-F31F7D4A3146) (Shutdown)</span><br><span class="line">-- tvOS 9.2 --</span><br><span class="line">    Apple TV 1080p (8129655F-4134-4998-A2C9-0461C28FDF00) (Shutdown)</span><br><span class="line">-- watchOS 2.2 --</span><br><span class="line">    Apple Watch - 42mm (2B69FD3C-1DBC-41AC-82BA-B8A4215E09C4) (Shutdown)</span><br><span class="line">-- Unavailable: com.apple.CoreSimulator.SimRuntime.iOS-10-0 --</span><br><span class="line">    iPhone 5 (DF66161D-F762-44FB-BF8B-EE8FDECFD203) (Shutdown) (unavailable, runtime profile not found)</span><br><span class="line">    iPhone 5s (00F328A8-5704-4C88-A128-5D310C51B476) (Shutdown) (unavailable, runtime profile not found)</span><br><span class="line">    iPhone 6 (A83359F2-41E9-4FDB-971A-1022811451BE) (Shutdown) (unavailable, runtime profile not found)</span><br><span class="line">    iPhone 6 Plus (A824AD89-D1CE-4E04-AD73-0E0C333238C2) (Shutdown) (unavailable, runtime profile not found)</span><br><span class="line">    iPhone 6s (14B59EAE-E267-4CF9-90CF-65F1153E8B51) (Shutdown) (unavailable, runtime profile not found)</span><br><span class="line">    iPhone 6s Plus (CC3124B7-500A-470D-B5DB-F330F5B173E1) (Shutdown) (unavailable, runtime profile not found)</span><br><span class="line">    iPad Retina (2550E4C9-54B2-4AC1-BD64-8C21595B2FFA) (Shutdown) (unavailable, runtime profile not found)</span><br><span class="line">    iPad Air (B8CD31CA-1690-4F7E-BABA-087AC4C1E894) (Shutdown) (unavailable, runtime profile not found)</span><br><span class="line">    iPad Air 2 (7F6E412B-CC71-4E92-A542-10AB7CEE0440) (Shutdown) (unavailable, runtime profile not found)</span><br><span class="line">    iPad Pro (12.9 inch) (693C487D-BBDC-4ED6-A0B5-43832111CA89) (Shutdown) (unavailable, runtime profile not found)</span><br><span class="line">    iPad Pro (9.7 inch) (580B7423-99CD-411A-AD11-8C7906C44279) (Shutdown) (unavailable, runtime profile not found)</span><br><span class="line">    iPhone SE (7482B157-12B7-4713-9BF7-F4C7083EC1B5) (Shutdown) (unavailable, runtime profile not found)</span><br><span class="line">-- Unavailable: com.apple.CoreSimulator.SimRuntime.tvOS-10-0 --</span><br><span class="line">    Apple TV 1080p (F9A62967-74C3-49DE-8A35-979531501889) (Shutdown) (unavailable, runtime profile not found)</span><br><span class="line">-- Unavailable: com.apple.CoreSimulator.SimRuntime.watchOS-3-0 --</span><br><span class="line">    Apple Watch - 38mm (CFD06DDD-5ED7-4C2E-AD2D-180959274F4E) (Shutdown) (unavailable, runtime profile not found)</span><br><span class="line">    Apple Watch - 42mm (835B5691-599C-4A5E-919F-04F68991042F) (Shutdown) (unavailable, runtime profile not found)</span><br><span class="line">== Device Pairs ==</span><br><span class="line">B136137E-9B10-4427-9706-59FBD01359E1 (active, disconnected)</span><br><span class="line">    Watch: Apple Watch - 42mm (2B69FD3C-1DBC-41AC-82BA-B8A4215E09C4) (Shutdown)</span><br><span class="line">    Phone: iPhone 6s Plus (115B2F18-065F-490B-9EAB-9C63B0BDE1CF) (Shutdown)</span><br><span class="line">07105DA6-F4F3-4FF4-8945-4A1E0A1B97AE (unavailable)</span><br><span class="line">    Watch: Apple Watch - 38mm (CFD06DDD-5ED7-4C2E-AD2D-180959274F4E) (Shutdown)</span><br><span class="line">    Phone: iPhone 6 (A83359F2-41E9-4FDB-971A-1022811451BE) (Shutdown)</span><br><span class="line">E142260B-6DF1-4B45-8389-E108F0F79652 (unavailable)</span><br><span class="line">    Watch: Apple Watch - 42mm (835B5691-599C-4A5E-919F-04F68991042F) (Shutdown)</span><br><span class="line">    Phone: iPhone 6 Plus (A824AD89-D1CE-4E04-AD73-0E0C333238C2) (Shutdown)</span><br></pre></td></tr></table></figure>
<h3 id="应用沙盒结构分析"><a href="#应用沙盒结构分析" class="headerlink" title="应用沙盒结构分析"></a>应用沙盒结构分析</h3><ul>
<li>应用程序包：(上图中的Layer)包含了所有的资源文件和可执行文件</li>
<li>Documents：保存应用运行时生成的需要持久化的数据，iTunes同步设备时会备份该目录。例如，游戏应用可将游戏存档保存在该目录</li>
<li>tmp：保存应用运行时所需的临时数据，使用完毕后再将相应的文件从该目录删除。应用没有运行时，系统也可能会清除该目录下的文件。iTunes同步设备时不会备份该目录</li>
<li>Library/Caches：保存应用运行时生成的需要持久化的数据，iTunes同步设备时不会备份该目录。一般存储体积大、不需要备份的非重要数据</li>
<li>Library/Preference：保存应用的所有偏好设置，iOS的Settings(设置)应用会在该目录中查找应用的设置信息。iTunes同步设备时会备份该目录</li>
</ul>
<h3 id="应用沙盒目录的常见获取方式"><a href="#应用沙盒目录的常见获取方式" class="headerlink" title="应用沙盒目录的常见获取方式"></a>应用沙盒目录的常见获取方式</h3><ul>
<li>沙盒根目录</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSString</span> *home = <span class="built_in">NSHomeDirectory</span>();</span><br></pre></td></tr></table></figure>
<ul>
<li><p>Documents：(2种方式)</p>
</li>
<li><p>利用沙盒根目录拼接”Documents”字符串</p>
</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSString</span> *home = <span class="built_in">NSHomeDirectory</span>();</span><br><span class="line"><span class="built_in">NSString</span> *documents = [home stringByAppendingPathComponent:<span class="string">@"Documents"</span>];</span><br><span class="line"><span class="comment">// 不建议采用，因为新版本的操作系统可能会修改目录名</span></span><br></pre></td></tr></table></figure>
<ul>
<li>利用NSSearchPathForDirectoriesInDomains函数</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NSUserDomainMask 代表从用户文件夹下找</span></span><br><span class="line"><span class="comment">// YES 代表展开路径中的波浪字符“~”</span></span><br><span class="line"><span class="built_in">NSArray</span> *array =  <span class="built_in">NSSearchPathForDirectoriesInDomains</span>(<span class="built_in">NSDocumentDirectory</span>, <span class="built_in">NSUserDomainMask</span>, <span class="literal">NO</span>);</span><br><span class="line"><span class="comment">// 在iOS中，只有一个目录跟传入的参数匹配，所以这个集合里面只有一个元素</span></span><br><span class="line"><span class="built_in">NSString</span> *documents = [array objectAtIndex:<span class="number">0</span>];</span><br></pre></td></tr></table></figure>
<p>tem 目录</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSString</span> *tmp = <span class="built_in">NSTemporaryDirectory</span>();</span><br></pre></td></tr></table></figure>
<p>Library/Caches：(跟Documents类似的2种方法)</p>
<ul>
<li>利用沙盒根目录拼接”Caches”字符串</li>
<li>利用NSSearchPathForDirectoriesInDomains函数(将函数的第2个参数改为：NSCachesDirectory即可)</li>
</ul>
<p>Library/Preference：通过NSUserDefaults类存取该目录下的设置信息</p>
<h2 id="属性列表"><a href="#属性列表" class="headerlink" title="属性列表"></a>属性列表</h2><ul>
<li>属性列表是一种XML格式的文件，拓展名为plist</li>
<li>如果对象是NSString、NSDictionary、NSArray、NSData、NSNumber等类型，就可以使用<code>writeToFile:atomically:</code>方法直接将对象写到属性列表文件中</li>
</ul>
<h3 id="属性列表-归档NSDictionary"><a href="#属性列表-归档NSDictionary" class="headerlink" title="属性列表-归档NSDictionary"></a>属性列表-归档NSDictionary</h3><p>将一个NSDictionary对象归档到一个plist属性列表中</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将数据封装成字典</span></span><br><span class="line"><span class="built_in">NSMutableDictionary</span> *dict = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">[dict setObject:<span class="string">@"小明"</span> forKey:<span class="string">@"name"</span>];</span><br><span class="line">[dict setObject:<span class="string">@"15013141314"</span> forKey:<span class="string">@"phone"</span>];</span><br><span class="line">[dict setObject:<span class="string">@"27"</span> forKey:<span class="string">@"age"</span>];</span><br><span class="line"><span class="comment">// 将字典持久化到Documents/stu.plist文件中</span></span><br><span class="line">[dict writeToFile:path atomically:<span class="literal">YES</span>];</span><br></pre></td></tr></table></figure>
<p>写入结果</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="meta">&lt;!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plist</span> <span class="attr">version</span>=<span class="string">"1.0"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">key</span>&gt;</span>age<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">string</span>&gt;</span>27<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">key</span>&gt;</span>name<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">string</span>&gt;</span>小明<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">key</span>&gt;</span>phone<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">string</span>&gt;</span>15013141314<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plist</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="读取属性列表，恢复NSDictionary对象"><a href="#读取属性列表，恢复NSDictionary对象" class="headerlink" title="读取属性列表，恢复NSDictionary对象"></a>读取属性列表，恢复NSDictionary对象</h3><p>读取属性列表，恢复NSDictionary对象</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 读取Documents/stu.plist的内容，实例化NSDictionary</span></span><br><span class="line"><span class="built_in">NSDictionary</span> *dict = [<span class="built_in">NSDictionary</span> dictionaryWithContentsOfFile:path];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"name:%@"</span>, [dict objectForKey:<span class="string">@"name"</span>]);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"phone:%@"</span>, [dict objectForKey:<span class="string">@"phone"</span>]);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"age:%@"</span>, [dict objectForKey:<span class="string">@"age"</span>]);</span><br></pre></td></tr></table></figure>
<p>打印结果：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2016</span><span class="number">-08</span><span class="number">-24</span> <span class="number">09</span>:<span class="number">47</span>:<span class="number">42.626</span> PersonalContacts02[<span class="number">2225</span>:<span class="number">169033</span>] name:小明</span><br><span class="line"><span class="number">2016</span><span class="number">-08</span><span class="number">-24</span> <span class="number">09</span>:<span class="number">47</span>:<span class="number">42.626</span> PersonalContacts02[<span class="number">2225</span>:<span class="number">169033</span>] phone:<span class="number">15013141314</span></span><br><span class="line"><span class="number">2016</span><span class="number">-08</span><span class="number">-24</span> <span class="number">09</span>:<span class="number">47</span>:<span class="number">42.626</span> PersonalContacts02[<span class="number">2225</span>:<span class="number">169033</span>] age:<span class="number">27</span></span><br></pre></td></tr></table></figure>
<h3 id="属性列表-NSDictionary的存储和读取过程"><a href="#属性列表-NSDictionary的存储和读取过程" class="headerlink" title="属性列表-NSDictionary的存储和读取过程"></a>属性列表-NSDictionary的存储和读取过程</h3><p><img src="http://ww2.sinaimg.cn/large/a9c4d5f6gw1f74okr7dclj21wq0jwdpa.jpg" alt=""></p>
<h2 id="偏好设置"><a href="#偏好设置" class="headerlink" title="偏好设置"></a>偏好设置</h2><ul>
<li>很多iOS应用都支持偏好设置，比如保存用户名、密码、字体大小等设置，iOS提供了一套标准的解决方案来为应用加入偏好设置功能</li>
<li>每个应用都有个NSUserDefaults实例，通过它来存取偏好设置</li>
<li>比如，保存用户名、字体大小、是否自动登录</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSUserDefaults</span> *defaults = [<span class="built_in">NSUserDefaults</span> standardUserDefaults];</span><br><span class="line">[defaults setObject:<span class="string">@"yoferzhang"</span> forKey:<span class="string">@"username"</span>];</span><br><span class="line">[defaults setFloat:<span class="number">18.0</span>f forKey:<span class="string">@"text_size"</span>];</span><br><span class="line">[defaults setBool:<span class="literal">YES</span> forKey:<span class="string">@"auto_login"</span>];</span><br></pre></td></tr></table></figure>
<p>读取上次保存的设置</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSUserDefaults</span> *defaults = [<span class="built_in">NSUserDefaults</span> standardUserDefaults];</span><br><span class="line"><span class="built_in">NSString</span> *username = [defaults stringForKey:<span class="string">@"username"</span>];</span><br><span class="line"><span class="keyword">float</span> textSize = [defaults floatForKey:<span class="string">@"text_size"</span>];</span><br><span class="line"><span class="built_in">BOOL</span> autoLogin = [defaults boolForKey:<span class="string">@"auto_login"</span>];</span><br></pre></td></tr></table></figure>
<p>注意：UserDefaults设置数据时，不是立即写入，而是根据时间戳定时地把缓存中的数据写入本地磁盘。所以调用了set方法之后数据有可能还没有写入磁盘应用程序就终止了。出现以上问题，可以通过调用synchornize方法强制写入</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[defaults synchornize];</span><br></pre></td></tr></table></figure>
<h2 id="NSKeyedArchiver"><a href="#NSKeyedArchiver" class="headerlink" title="NSKeyedArchiver"></a>NSKeyedArchiver</h2><p>如果对象是NSString、NSDictionary、NSArray、NSData、NSNumber等类型，可以直接用NSKeyedArchiver进行归档和恢复</p>
<p>不是所有的对象都可以直接用这种方法进行归档，只有遵守了NSCoding协议的对象才可以<br>NSCoding协议有2个方法：</p>
<ul>
<li><code>encodeWithCoder:</code></li>
</ul>
<p>每次归档对象时，都会调用这个方法。一般在这个方法里面指定如何归档对象中的每个实例变量，可以使用encodeObject:forKey:方法归档实例变量</p>
<ul>
<li><code>initWithCoder:</code></li>
</ul>
<p>每次从文件中恢复(解码)对象时，都会调用这个方法。一般在这个方法里面指定如何解码文件中的数据为对象的实例变量，可以使用decodeObject:forKey方法解码实例变量</p>
<h3 id="NSKeyedArchiver-归档NSArray"><a href="#NSKeyedArchiver-归档NSArray" class="headerlink" title="NSKeyedArchiver-归档NSArray"></a>NSKeyedArchiver-归档NSArray</h3><p>归档一个NSArray对象到Documents/array.archive</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSArray</span> *array = [<span class="built_in">NSArray</span> arrayWithObjects:<span class="string">@"a"</span>,<span class="string">@"b"</span>,<span class="literal">nil</span>];</span><br><span class="line">[<span class="built_in">NSKeyedArchiver</span> archiveRootObject:array toFile:path];</span><br></pre></td></tr></table></figure>
<p>恢复(解码)NSArray对象</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSArray</span> *array = [<span class="built_in">NSKeyedUnarchiver</span> unarchiveObjectWithFile:path];</span><br></pre></td></tr></table></figure>
<p><img src="http://ww2.sinaimg.cn/mw690/a9c4d5f6gw1f74okr7dclj21wq0jwdpa.jpg" alt=""></p>
<h3 id="NSKeyedArchiver-归档Person对象（Person-h）"><a href="#NSKeyedArchiver-归档Person对象（Person-h）" class="headerlink" title="NSKeyedArchiver-归档Person对象（Person.h）"></a>NSKeyedArchiver-归档Person对象（Person.h）</h3><p>Person对象（Person.h）</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span> &lt;<span class="title">NSCoding</span>&gt;</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">int</span> age;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">float</span> height;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>Person对象（Person.m）</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)encodeWithCoder:(<span class="built_in">NSCoder</span> *)encoder &#123;</span><br><span class="line">    [encoder encodeObject:<span class="keyword">self</span>.name forKey:<span class="string">@"name"</span>];</span><br><span class="line">    [encoder encodeInt:<span class="keyword">self</span>.age forKey:<span class="string">@"age"</span>];</span><br><span class="line">    [encoder encodeFloat:<span class="keyword">self</span>.height forKey:<span class="string">@"height"</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)initWithCoder:(<span class="built_in">NSCoder</span> *)decoder &#123;</span><br><span class="line">    <span class="keyword">self</span>.name = [decoder decodeObjectForKey:<span class="string">@"name"</span>];</span><br><span class="line">    <span class="keyword">self</span>.age = [decoder decodeIntForKey:<span class="string">@"age"</span>];</span><br><span class="line">    <span class="keyword">self</span>.height = [decoder decodeFloatForKey:<span class="string">@"height"</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>归档Person对象（编码和解码）</p>
<ul>
<li>归档(编码)</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSArray</span> *array =  <span class="built_in">NSSearchPathForDirectoriesInDomains</span>(<span class="built_in">NSDocumentDirectory</span>, <span class="built_in">NSUserDomainMask</span>, <span class="literal">YES</span>);</span><br><span class="line"><span class="built_in">NSString</span> *documents = [array objectAtIndex:<span class="number">0</span>];</span><br><span class="line"><span class="built_in">NSString</span> *filePath = [documents stringByAppendingPathComponent:<span class="string">@"data.plist"</span>];</span><br><span class="line">Person *person = [[Person alloc] init];</span><br><span class="line">person.name = <span class="string">@"yoferzhang"</span>;</span><br><span class="line">person.age = <span class="number">27</span>;</span><br><span class="line">person.height = <span class="number">1.83</span>f;</span><br><span class="line">[<span class="built_in">NSKeyedArchiver</span> archiveRootObject:person toFile:filePath];</span><br></pre></td></tr></table></figure>
<p>data.plist</p>
<p><img src="http://ww4.sinaimg.cn/large/a9c4d5f6gw1f74owj17vsj21380hsq5y.jpg" alt=""></p>
<p><img src="http://ww1.sinaimg.cn/mw690/a9c4d5f6gw1f74oxc6bmuj20qg10079r.jpg" alt=""></p>
<ul>
<li>恢复(解码)</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Person *person = [<span class="built_in">NSKeyedUnarchiver</span> unarchiveObjectWithFile:path];</span><br></pre></td></tr></table></figure>
<h3 id="归档对象的注意"><a href="#归档对象的注意" class="headerlink" title="归档对象的注意"></a>归档对象的注意</h3><p>如果父类也遵守了NSCoding协议，请注意：</p>
<p>应该在encodeWithCoder:方法中加上一句</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">super</span> encodeWithCode:encode];</span><br></pre></td></tr></table></figure>
<p>确保继承的实例变量也能被编码，即也能被归档</p>
<p>应该在initWithCoder:方法中加上一句</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self</span> = [<span class="keyword">super</span> initWithCoder:decoder];</span><br></pre></td></tr></table></figure>
<p>确保继承的实例变量也能被解码，即也能被恢复</p>
<h3 id="NSData"><a href="#NSData" class="headerlink" title="NSData"></a>NSData</h3><ul>
<li>使用<code>archiveRootObject:toFile:</code>方法可以将一个对象直接写入到一个文件中，但有时候可能想将多个对象写入到同一个文件中，那么就要使用<code>NSData</code>来进行归档对象</li>
<li>NSData可以为一些数据提供临时存储空间，以便随后写入文件，或者存放从磁盘读取的文件内容。可以使用<code>[NSMutableData data]</code>创建可变数据空间</li>
</ul>
<p><img src="http://ww4.sinaimg.cn/large/a9c4d5f6gw1faae0jjuq4j210v0aegob.jpg" alt=""></p>
<h3 id="NSData-归档2个Person对象到同一文件中"><a href="#NSData-归档2个Person对象到同一文件中" class="headerlink" title="NSData-归档2个Person对象到同一文件中"></a>NSData-归档2个Person对象到同一文件中</h3><ul>
<li>归档（编码）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// 新建一块可变数据区</span><br><span class="line">NSMutableData *data = [NSMutableData data];</span><br><span class="line">// 将数据区连接到一个NSKeyedArchiver对象</span><br><span class="line">NSKeyedArchiver *archiver = [[[NSKeyedArchiver alloc] initForWritingWithMutableData:data] autorelease];</span><br><span class="line">// 开始存档对象，存档的数据都会存储到NSMutableData中</span><br><span class="line">[archiver encodeObject:person1 forKey:@&quot;person1&quot;];</span><br><span class="line">[archiver encodeObject:person2 forKey:@&quot;person2&quot;];</span><br><span class="line">// 存档完毕(一定要调用这个方法)</span><br><span class="line">[archiver finishEncoding];</span><br><span class="line">// 将存档的数据写入文件</span><br><span class="line">[data writeToFile:path atomically:YES];</span><br></pre></td></tr></table></figure>
<ul>
<li>恢复（解码）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// 从文件中读取数据</span><br><span class="line">NSData *data = [NSData dataWithContentsOfFile:path];</span><br><span class="line">// 根据数据，解析成一个NSKeyedUnarchiver对象</span><br><span class="line">NSKeyedUnarchiver *unarchiver = [[NSKeyedUnarchiver alloc] initForReadingWithData:data];</span><br><span class="line">Person *person1 = [unarchiver decodeObjectForKey:@&quot;person1&quot;];</span><br><span class="line">Person *person2 = [unarchiver decodeObjectForKey:@&quot;person2&quot;];</span><br><span class="line">// 恢复完毕</span><br><span class="line">[unarchiver finishDecoding];</span><br></pre></td></tr></table></figure>
<h3 id="利用归档实现深复制"><a href="#利用归档实现深复制" class="headerlink" title="利用归档实现深复制"></a>利用归档实现深复制</h3><p>比如对一个Person对象进行深复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// 临时存储person1的数据</span><br><span class="line">NSData *data = [NSKeyedArchiver archivedDataWithRootObject:person1];</span><br><span class="line">// 解析data，生成一个新的Person对象</span><br><span class="line">Student *person2 = [NSKeyedUnarchiver unarchiveObjectWithData:data];</span><br><span class="line">// 分别打印内存地址</span><br><span class="line">NSLog(@&quot;person1:0x%x&quot;, person1); // person1:0x7177a60</span><br><span class="line">NSLog(@&quot;person2:0x%x&quot;, person2); // person2:0x7177cf0</span><br></pre></td></tr></table></figure>
<p><img src="http://ww4.sinaimg.cn/large/a9c4d5f6gw1faaeyb9e4gj213i03bmxw.jpg" alt=""></p>
<h2 id="SQLite3"><a href="#SQLite3" class="headerlink" title="SQLite3"></a>SQLite3</h2><ul>
<li>SQLite3是一款开源的嵌入式关系型数据库，可移植性好、易使用、内存开销小</li>
<li>SQLite3是无类型的，意味着你可以保存任何类型的数据到任意表的任意字段中。比如下列的创表语句是合法的：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">create table t_person(name, age);</span><br><span class="line">为了保证可读性，建议还是把字段类型加上：</span><br><span class="line">create table t_person(name text, age integer);</span><br></pre></td></tr></table></figure>
<ul>
<li>SQLite3常用的5种数据类型：text、integer、float、boolean、blob</li>
<li>在iOS中使用SQLite3，首先要添加库文件libsqlite3.dylib和导入主头文件</li>
</ul>
<h3 id="创建、打开、关闭数据库"><a href="#创建、打开、关闭数据库" class="headerlink" title="创建、打开、关闭数据库"></a>创建、打开、关闭数据库</h3><ul>
<li>创建或打开数据库</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// path为：~/Documents/person.db</span><br><span class="line">sqlite3 *db;</span><br><span class="line">int result = sqlite3_open([path UTF8String], &amp;db);</span><br></pre></td></tr></table></figure>
<p>代码解析：</p>
<ul>
<li>sqlite3_open()将根据文件路径打开数据库，如果不存在，则会创建一个新的数据库。如果result等于常量SQLITE_OK，则表示成功打开数据库</li>
<li>sqlite3 *db：一个打开的数据库实例</li>
<li>数据库文件的路径必须以C字符串(而非NSString)传入</li>
</ul>
<p>关闭数据库：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlite3_close(db);</span><br></pre></td></tr></table></figure>
<h3 id="执行不返回数据的SQL语句"><a href="#执行不返回数据的SQL语句" class="headerlink" title="执行不返回数据的SQL语句"></a>执行不返回数据的SQL语句</h3><p>执行创表语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">char *errorMsg;  // 用来存储错误信息</span><br><span class="line">char *sql = &quot;create table if not exists t_person(id integer primary key autoincrement, name text, age integer);&quot;;</span><br><span class="line">int result = sqlite3_exec(db, sql, NULL, NULL, &amp;errorMsg);</span><br></pre></td></tr></table></figure>
<p>代码解析：</p>
<ul>
<li><code>sqlite3_exec()</code>可以执行任何SQL语句，比如创表、更新、插入和删除操作。但是一般不用它执行查询语句，因为它不会返回查询到的数据</li>
<li><code>sqlite3_exec()</code>还可以执行的语句：</li>
</ul>
<ol>
<li>开启事务：begin transaction;</li>
<li>回滚事务：rollback;</li>
<li>提交事务：commit;</li>
</ol>
<h3 id="带占位符插入数据"><a href="#带占位符插入数据" class="headerlink" title="带占位符插入数据"></a>带占位符插入数据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">char *sql = &quot;insert into t_person(name, age) values(?, ?);&quot;;</span><br><span class="line">sqlite3_stmt *stmt;</span><br><span class="line">if (sqlite3_prepare_v2(db, sql, -1, &amp;stmt, NULL) == SQLITE_OK) &#123;</span><br><span class="line">    sqlite3_bind_text(stmt, 1, &quot;母鸡&quot;, -1, NULL);</span><br><span class="line">    sqlite3_bind_int(stmt, 2, 27);</span><br><span class="line">&#125;</span><br><span class="line">if (sqlite3_step(stmt) != SQLITE_DONE) &#123;</span><br><span class="line">    NSLog(@&quot;插入数据错误&quot;);</span><br><span class="line">&#125;</span><br><span class="line">sqlite3_finalize(stmt);</span><br></pre></td></tr></table></figure>
<p><code>sqlite3_prepare_v2()</code>返回值等于<code>SQLITE_OK</code>，说明SQL语句已经准备成功，没有语法问题</p>
<p><code>sqlite3_bind_text():</code>大部分绑定函数都只有3个参数</p>
<ol>
<li>第1个参数是sqlite3_stmt *类型</li>
<li>第2个参数指占位符的位置，第一个占位符的位置是1，不是0</li>
<li>第3个参数指占位符要绑定的值</li>
<li>第4个参数指在第3个参数中所传递数据的长度，对于C字符串，可以传递-1代替字符串的长度</li>
<li>第5个参数是一个可选的函数回调，一般用于在语句执行后完成内存清理工作</li>
</ol>
<p><code>sqlite_step():</code>执行SQL语句，返回<code>SQLITE_DONE</code>代表成功执行完毕</p>
<p>sqlite_finalize():销毁sqlite3_stmt *对象</p>
<h3 id="查询数据"><a href="#查询数据" class="headerlink" title="查询数据"></a>查询数据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">char *sql = &quot;select id,name,age from t_person;&quot;;</span><br><span class="line">sqlite3_stmt *stmt;</span><br><span class="line">if (sqlite3_prepare_v2(db, sql, -1, &amp;stmt, NULL) == SQLITE_OK) &#123;</span><br><span class="line">    while (sqlite3_step(stmt) == SQLITE_ROW) &#123;</span><br><span class="line">        int _id = sqlite3_column_int(stmt, 0);</span><br><span class="line">        char *_name = (char *)sqlite3_column_text(stmt, 1);</span><br><span class="line">        NSString *name = [NSString stringWithUTF8String:_name];</span><br><span class="line">        int _age = sqlite3_column_int(stmt, 2);</span><br><span class="line">        NSLog(@&quot;id=%i, name=%@, age=%i&quot;, _id, name, _age);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">sqlite3_finalize(stmt)</span><br></pre></td></tr></table></figure>
<p><code>sqlite3_step()</code>返回<code>SQLITE_ROW</code>代表遍历到一条新记录</p>
<p><code>sqlite3_column_*()</code>用于获取每个字段对应的值，第2个参数是字段的索引，从0开始</p>
<blockquote>
<p>新博客文章地址：<a href="http://yoferzhang.com/post/20161130DataManager/">【iOS】iOS数据存储,应用沙盒,XML,Preference,NSKeyedArchiver归档,SQLite3</a><br>CSDN文章地址：<a href="http://blog.csdn.net/zyq522376829/article/details/53414136" target="_blank" rel="external">【iOS】iOS数据存储,应用沙盒,XML,Preference,NSKeyedArchiver归档,SQLite3</a></p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoferzhang.com/post/20161109TableViewPG/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Yofer Zhang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="http://ww2.sinaimg.cn/mw690/a9c4d5f6jw1e3siexaeopj.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="YoferZhang 的博客">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="YoferZhang 的博客" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/20161109TableViewPG/" itemprop="url">
                  Table View Programming Guide for iOS
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-09T09:06:19+08:00">
                2016-11-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/post/20161109TableViewPG/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="post/20161109TableViewPG/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>table view分为两种：plain 和 grouped</p>
<h2 id="Plain-Table-Views"><a href="#Plain-Table-Views" class="headerlink" title="Plain Table Views"></a>Plain Table Views</h2><p>A table view configured as an indexed list</p>
<p><img src="http://ww1.sinaimg.cn/mw690/a9c4d5f6gw1f9mq3u9im0j207k0bcq3o.jpg" alt=""></p>
<p>A table view configured as a selection list</p>
<p><img src="http://ww3.sinaimg.cn/mw690/a9c4d5f6gw1f9mq69bg4wj207l0bdaah.jpg" alt=""></p>
<h2 id="Grouped-Table-Views"><a href="#Grouped-Table-Views" class="headerlink" title="Grouped Table Views"></a>Grouped Table Views</h2><p>A table view in the grouped style</p>
<p><img src="http://ww3.sinaimg.cn/mw690/a9c4d5f6gw1f9mq7cwbwkj207m0bc74z.jpg" alt=""></p>
<p>Header and footer of a section</p>
<p><img src="http://ww2.sinaimg.cn/mw690/a9c4d5f6gw1f9mq88td6fj208a09ejso.jpg" alt=""></p>
<h2 id="Standard-Styles-for-Table-View-Cells"><a href="#Standard-Styles-for-Table-View-Cells" class="headerlink" title="Standard Styles for Table View Cells"></a>Standard Styles for Table View Cells</h2><table>
<thead>
<tr>
<th style="text-align:center">Style</th>
<th style="text-align:center">Demo</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">UITableViewCellStyleDefault</td>
<td style="text-align:center"><img src="http://ww1.sinaimg.cn/mw690/a9c4d5f6gw1f9mqag1q32j208y0dejtd.jpg" alt=""></td>
</tr>
<tr>
<td style="text-align:center">UITableViewCellStyleSubtitle</td>
<td style="text-align:center"><img src="http://ww3.sinaimg.cn/mw690/a9c4d5f6gw1f9mqbwk4l3j208y0de40v.jpg" alt=""></td>
</tr>
<tr>
<td style="text-align:center">UITableViewCellStyleValue1</td>
<td style="text-align:center"><img src="http://ww4.sinaimg.cn/mw690/a9c4d5f6gw1f9mqcq0vytj208y0demz4.jpg" alt=""></td>
</tr>
<tr>
<td style="text-align:center">UITableViewCellStyleValue2</td>
<td style="text-align:center"><img src="http://ww2.sinaimg.cn/mw690/a9c4d5f6gw1f9mqp4geiej208y0dewga.jpg" alt=""></td>
</tr>
</tbody>
</table>
<h1 id="Overview-of-the-Table-View-API"><a href="#Overview-of-the-Table-View-API" class="headerlink" title="Overview of the Table View API"></a>Overview of the Table View API</h1><h2 id="Table-View"><a href="#Table-View" class="headerlink" title="Table View"></a>Table View</h2><p>UITableView 继承自 <a href="https://developer.apple.com/reference/uikit/uiscrollview" target="_blank" rel="external">UIScrollView</a>，但是重新定义了 scrolling behavior ，只允许竖直方向的滚动。</p>
<h2 id="Data-Source-and-Delegate"><a href="#Data-Source-and-Delegate" class="headerlink" title="Data Source and Delegate"></a>Data Source and Delegate</h2><p><a href="https://developer.apple.com/reference/uikit/uitableviewdatasource" target="_blank" rel="external">UITableViewDataSource</a>有两个required methods，<a href="https://developer.apple.com/reference/uikit/uitableviewdatasource/1614931-tableview" target="_blank" rel="external">tableView:numberOfRowsInSection:</a> 和 <a href="https://developer.apple.com/reference/uikit/uitableviewdatasource/1614861-tableview" target="_blank" rel="external">tableView:cellForRowAtIndexPath:</a>。<a href="https://developer.apple.com/reference/uikit/uitableviewdelegate" target="_blank" rel="external">UITableViewDelegate</a> 协议就没有required methods。It declares methods that allow the delegate to modify visible aspects of the table view, manage selections, support an accessory view, and support editing of individual rows in a table.</p>
<h1 id="Navigating-a-Data-Hierarchy-with-Table-Views"><a href="#Navigating-a-Data-Hierarchy-with-Table-Views" class="headerlink" title="Navigating a Data Hierarchy with Table Views"></a>Navigating a Data Hierarchy with Table Views</h1><p>可以使用<a href="https://developer.apple.com/reference/uikit/uitableviewcontroller/1614754-init" target="_blank" rel="external">initWithStyle:</a>方法来创建一个table view，传递参数 <a href="https://developer.apple.com/reference/uikit/uitableviewstyle/1614968-plain" target="_blank" rel="external">UITableViewStylePlain</a> 或 <a href="https://developer.apple.com/reference/uikit/uitableviewstyle/1614942-grouped" target="_blank" rel="external">UITableViewStyleGrouped</a> 。</p>
<p>尽量使用UIViewController的子类，而不要直接只用UITableViewController，因为UITableViewController会直接创建一个全屏的table view，如果只是想把table view作为一部分使用，就不好处理了，所以用UIViewController自定义table view 的大小，自由度更高。</p>
<h3 id="Managing-Table-Views-in-a-Navigation-Based-App"><a href="#Managing-Table-Views-in-a-Navigation-Based-App" class="headerlink" title="Managing Table Views in a Navigation-Based App"></a>Managing Table Views in a Navigation-Based App</h3><p>当用户点击table view 的某一行时，table view 调用了 <a href="https://developer.apple.com/reference/uikit/uitableviewdelegate/1614877-tableview" target="_blank" rel="external">tableView:didSelectRowAtIndexPath:</a> 或者 <a href="https://developer.apple.com/reference/uikit/uitableviewdelegate/1614996-tableview" target="_blank" rel="external">tableView:accessoryButtonTappedForRowWithIndexPath:</a> 方法，都是由delegate实现的。后一个方法是当用户点击某一行的detail disclosure button时被调用的。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoferzhang.com/post/20161024LLDBQuickStartGuide/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Yofer Zhang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="http://ww2.sinaimg.cn/mw690/a9c4d5f6jw1e3siexaeopj.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="YoferZhang 的博客">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="YoferZhang 的博客" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/20161024LLDBQuickStartGuide/" itemprop="url">
                  【iOS】LLDB调试指南
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-10-24T08:56:09+08:00">
                2016-10-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/post/20161024LLDBQuickStartGuide/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="post/20161024LLDBQuickStartGuide/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="LLDB命令结构"><a href="#LLDB命令结构" class="headerlink" title="LLDB命令结构"></a>LLDB命令结构</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;command&gt; [&lt;subcommand&gt; [&lt;subcommand&gt;...]] &lt;action&gt; [-options [option-value]] [argument [argument...]]</span><br></pre></td></tr></table></figure>
<p>to set a breakpoint in file <code>test.c</code> at line 12 you enter:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) breakpoint set --file test.c --line 12</span><br></pre></td></tr></table></figure>
<p>here is a partial listing of the command options for the <code>breakpoint set</code> command, listing the canonical form in parentheses:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">breakpoint set</span><br><span class="line">       -M &lt;method&gt; ( --method &lt;method&gt; )</span><br><span class="line">       -S &lt;selector&gt; ( --selector &lt;selector&gt; )</span><br><span class="line">       -b &lt;function-name&gt; ( --basename &lt;function-name&gt; )</span><br><span class="line">       -f &lt;filename&gt; ( --file &lt;filename&gt; )</span><br><span class="line">       -l &lt;linenum&gt; ( --line &lt;linenum&gt; )</span><br><span class="line">       -n &lt;function-name&gt; ( --name &lt;function-name&gt; )</span><br><span class="line">…</span><br></pre></td></tr></table></figure>
<p>To set the same file and line breakpoint in LLDB, enter:</p>
<p><code>(lldb) breakpoint set --file foo.c --line 12</code></p>
<p>To set a breakpoint on a function named <code>foo</code> in LLDB, enter:</p>
<p><code>(lldb) breakpoint set --name foo</code></p>
<p>Setting breakpoints by name is even more powerful in LLDB than in GDB because you can specify that you want to set a breakpoint at a function by method name. To set a breakpoint on all C++ methods named <code>foo</code>, enter:</p>
<p><code>(lldb) breakpoint set --method foo</code></p>
<p>To set a breakpoint on Objective-C selectors named <code>alignLeftEdges:</code>, enter:</p>
<p><code>(lldb) breakpoint set --selector alignLeftEdges:</code></p>
<p>You can limit any breakpoints to a specific executable image by using the <code>--shlib</code> expression.</p>
<p><code>(lldb) breakpoint set --shlib foo.dylib --name foo</code></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoferzhang.com/post/20160926Cocos2dxViewAnimation/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Yofer Zhang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="http://ww2.sinaimg.cn/mw690/a9c4d5f6jw1e3siexaeopj.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="YoferZhang 的博客">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="YoferZhang 的博客" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/20160926Cocos2dxViewAnimation/" itemprop="url">
                  【iOS】Cocos2dx封装为view方便做3D动画效果
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-22T11:45:36+08:00">
                2016-09-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/post/20160926Cocos2dxViewAnimation/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="post/20160926Cocos2dxViewAnimation/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>版权声明：本文为博主原创，如需转载请注明出处。</p>
</blockquote>
<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>本文件只是将Cocos2dx 封装为一个 UIView，方便直接添加使用</p>
<p>使用的 coco2d-x 版本为 3.13.1</p>
<h2 id="添加过程"><a href="#添加过程" class="headerlink" title="添加过程"></a>添加过程</h2><p>首先将 ~/cocos2d/build/cocos2d_lib.xcodeproj 添加到工程中</p>
<p><img src="http://ww1.sinaimg.cn/mw690/a9c4d5f6gw1f76afsxwnij21gk0420ua.jpg" alt=""></p>
<p>然后对照new出来的工程，修改配置：</p>
<p><img src="http://ww1.sinaimg.cn/large/a9c4d5f6gw1f76bi7i162j21wq0x20yo.jpg" alt=""></p>
<p>然后添加两个 Header Search Paths，同样对照样本工程</p>
<p>设置TARGETS中Header Search Paths</p>
<p><img src="http://ww2.sinaimg.cn/large/a9c4d5f6gw1f76bt2m3ggj221g0uy4a9.jpg" alt=""><br>PROJECT中设置Header Search Paths，相对路径</p>
<p><img src="http://ww1.sinaimg.cn/large/a9c4d5f6gw1f76bt3ay8xj21yc0s811s.jpg" alt=""><br>设置预处理的宏定义，Debug和Release</p>
<p><img src="http://ww4.sinaimg.cn/large/a9c4d5f6gw1f76bz3loh5j21kq0ncwku.jpg" alt=""></p>
<p><img src="http://ww3.sinaimg.cn/large/a9c4d5f6gw1f76c2o03l5j21mw0l6n37.jpg" alt=""></p>
<p>修改Custom Compiler Flags</p>
<p><img src="http://ww4.sinaimg.cn/large/a9c4d5f6gw1f76c4w3r94j21jk0iudk3.jpg" alt=""></p>
<p>至此，不出意外编译可以成功了。</p>
<h2 id="设置view"><a href="#设置view" class="headerlink" title="设置view"></a>设置view</h2><p>然后在CocosViewController（我自己建立的测试界面）中设置弹出HelloWorld界面，HelloWorld界面的两个类 <code>AppDelegate</code> 和 <code>HelloWorldScene</code>要添加到工程中。</p>
<blockquote>
<p>注意这个文件是C++混编，所以 <code>CocosViewController.m</code> 文件要改后缀为 <code>CocosViewController.mm</code></p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">"CocosViewController.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">"CocosAppDelegate.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"platform/ios/CCEAGLView-ios.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"platform/ios/CCDirectorCaller-ios.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// cocos2d application instance</span></span><br><span class="line"><span class="keyword">static</span> CocosAppDelegate s_sharedApplication;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">CocosViewController</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">weak</span>, <span class="keyword">nonatomic</span>) <span class="built_in">UIView</span> *blackView;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">weak</span>, <span class="keyword">nonatomic</span>) CCEAGLView *eaglView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">CocosViewController</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    <span class="comment">// Do any additional setup after loading the view.</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.view.backgroundColor = [<span class="built_in">UIColor</span> whiteColor];</span><br><span class="line">    [<span class="keyword">self</span> drawButton];</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - 绘制按钮</span></span><br><span class="line">- (<span class="keyword">void</span>)drawButton</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">UIButton</span> *cocoaButton = [[<span class="built_in">UIButton</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">70</span>, <span class="number">80</span>, <span class="number">50</span>)];</span><br><span class="line">    [cocoaButton setTitle:<span class="string">@"动画开关"</span> forState:<span class="built_in">UIControlStateNormal</span>];</span><br><span class="line">    [cocoaButton setTitleColor:[<span class="built_in">UIColor</span> blueColor] forState:<span class="built_in">UIControlStateNormal</span>];</span><br><span class="line">    [cocoaButton addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(presentCocosView) forControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>];</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:cocoaButton];</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)presentView</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.blackView) &#123;</span><br><span class="line">        [<span class="keyword">self</span>.blackView removeFromSuperview];</span><br><span class="line">        <span class="keyword">self</span>.blackView = <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">UIView</span> *view = [[<span class="built_in">UIView</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(<span class="number">50</span>, <span class="number">120</span>, [<span class="built_in">UIScreen</span> mainScreen].bounds.size.width / <span class="number">2.0</span>, [<span class="built_in">UIScreen</span> mainScreen].bounds.size.height / <span class="number">2.0</span>)];</span><br><span class="line">        [view setBackgroundColor:[<span class="built_in">UIColor</span> blackColor]];</span><br><span class="line">        [<span class="keyword">self</span>.view addSubview:view];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">self</span>.blackView = view;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)presentCocosView</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.eaglView) &#123;</span><br><span class="line">        [<span class="keyword">self</span> destroyCocosView];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [<span class="keyword">self</span> addCocosView];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)addCocosView</span><br><span class="line">&#123;</span><br><span class="line">    cocos2d::Application *app = cocos2d::Application::getInstance();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Initialize the GLView attributes</span></span><br><span class="line">    app-&gt;initGLContextAttrs();</span><br><span class="line">    cocos2d::GLViewImpl::convertAttrs();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Initialize the CCEAGLView</span></span><br><span class="line">    CCEAGLView *eaglView = [CCEAGLView viewWithFrame: <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">120</span>, [<span class="built_in">UIScreen</span> mainScreen].bounds.size.width, [<span class="built_in">UIScreen</span> mainScreen].bounds.size.height * <span class="number">0.8</span>)</span><br><span class="line">                                         pixelFormat: (__bridge <span class="built_in">NSString</span> *)cocos2d::GLViewImpl::_pixelFormat</span><br><span class="line">                                         depthFormat: cocos2d::GLViewImpl::_depthFormat</span><br><span class="line">                                  preserveBackbuffer: <span class="literal">NO</span></span><br><span class="line">                                          sharegroup: <span class="literal">nil</span></span><br><span class="line">                                       multiSampling: <span class="literal">NO</span></span><br><span class="line">                                     numberOfSamples: <span class="number">0</span> ];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Enable or disable multiple touches</span></span><br><span class="line">    [eaglView setMultipleTouchEnabled:<span class="literal">NO</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Set EAGLView as view of RootViewController</span></span><br><span class="line">    <span class="comment">//    self.view = eaglView;</span></span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:eaglView];</span><br><span class="line">    <span class="keyword">self</span>.eaglView = eaglView;</span><br><span class="line">    </span><br><span class="line">    cocos2d::GLView *glview = cocos2d::GLViewImpl::createWithEAGLView((__bridge <span class="keyword">void</span> *)eaglView);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//set the GLView as OpenGLView of the Director</span></span><br><span class="line">    cocos2d::Director::getInstance()-&gt;setOpenGLView(glview);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//run the cocos2d-x game scene</span></span><br><span class="line">    app-&gt;run();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)destroyCocosView</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//    cocos2d::Director::getInstance()-&gt;getTextureCache()</span></span><br><span class="line">    cocos2d::PoolManager::destroyInstance();</span><br><span class="line">    cocos2d::Director::getInstance()-&gt;purgeCachedData();</span><br><span class="line">    cocos2d::Director::getInstance()-&gt;purgeDirector();</span><br><span class="line">    </span><br><span class="line">    [CCDirectorCaller destroy];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)didReceiveMemoryWarning &#123;</span><br><span class="line">    [<span class="keyword">super</span> didReceiveMemoryWarning];</span><br><span class="line">    <span class="comment">// Dispose of any resources that can be recreated.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>此时就可以重复开启关闭cocos动画界面了。</p>
<h2 id="释放cocos单例"><a href="#释放cocos单例" class="headerlink" title="释放cocos单例"></a>释放cocos单例</h2><h3 id="检查单例"><a href="#检查单例" class="headerlink" title="检查单例"></a>检查单例</h3><p>这里先对所有的cocos2dx中的单例进行检查，主要是想用Director销毁其他的单例，经过检查的结果也证明了王哲说的：用Director来管理项目中的单例，具体释放在上面的 <code>destroyCocosView</code> 方法中。即为：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)destroyCocosView</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//    cocos2d::Director::getInstance()-&gt;getTextureCache()</span></span><br><span class="line">    cocos2d::PoolManager::destroyInstance();</span><br><span class="line">    cocos2d::Director::getInstance()-&gt;purgeCachedData();</span><br><span class="line">    cocos2d::Director::getInstance()-&gt;purgeDirector();</span><br><span class="line">    </span><br><span class="line">    [CCDirectorCaller destroy];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面为检查结果表格：</p>
<table>
<thead>
<tr>
<th>单例</th>
<th>是否被cocostudio释放</th>
<th>启动时是否被实例化</th>
</tr>
</thead>
<tbody>
<tr>
<td>ArmatureNodeReader::destroyInstance()</td>
<td>是</td>
<td>否</td>
</tr>
<tr>
<td>ButtonReader::destroyInstance()</td>
<td>是</td>
<td>否</td>
</tr>
<tr>
<td>ActionManagerEx::destroyInstance()</td>
<td>是</td>
<td>CCActionNode 和 CCSGUIReader</td>
</tr>
<tr>
<td>BoneNodeReader::destroyInstance()</td>
<td>否</td>
<td>否</td>
</tr>
<tr>
<td>ActionTimelineCache::destroyInstance()</td>
<td>CSLoader销毁时会调用这个销毁</td>
<td>CSLoader</td>
</tr>
<tr>
<td>Animation3DCache::destroyInstance()</td>
<td>否</td>
<td>否</td>
</tr>
<tr>
<td>AnimationCache::destroyInstance()</td>
<td>是</td>
<td>CCNodelLoader 和 CCSprite</td>
</tr>
<tr>
<td>ScriptEngineManager::destroyInstance()</td>
<td>否</td>
<td>有一堆类用到这个实例，但没有被销毁，但可以用Application销毁</td>
</tr>
<tr>
<td>PoolManager::destroyInstance()</td>
<td>否</td>
<td>同上</td>
</tr>
<tr>
<td>ArmatureDataManager::destroyInstance()</td>
<td>是</td>
<td>否</td>
</tr>
<tr>
<td>AsyncTaskPool::destroyInstance()</td>
<td>是</td>
<td>其他3个类有用到</td>
</tr>
<tr>
<td>Configuration::destroyInstance()</td>
<td>是</td>
<td>二十几个类用到</td>
</tr>
<tr>
<td>FileUtils::destroyInstance()</td>
<td>是</td>
<td></td>
</tr>
<tr>
<td>GLProgramCache::destroyInstance()</td>
<td>是</td>
<td></td>
</tr>
<tr>
<td>GLProgramStateCache::destroyInstance()</td>
<td>是</td>
<td></td>
</tr>
<tr>
<td>NodeLoaderLibrary::destroyInstance()</td>
<td>否</td>
<td>否</td>
</tr>
<tr>
<td>__NotificationCenter::destroyInstance()</td>
<td>否</td>
<td>否</td>
</tr>
<tr>
<td>GUIReader::destroyInstance()</td>
<td>是</td>
<td>十几个类调用</td>
</tr>
<tr>
<td>Sprite3DCache::getInstance()</td>
<td>否</td>
<td>自己调用</td>
</tr>
<tr>
<td>Sprite3DMaterialCache::destroyInstance()</td>
<td>否</td>
<td></td>
</tr>
<tr>
<td>SpriteFrameCache::destroyInstance()</td>
<td>是</td>
<td></td>
</tr>
<tr>
<td>SceneReader::destroyInstance()</td>
<td>是</td>
<td></td>
</tr>
<tr>
<td>DictionaryHelper::destroyInstance()</td>
<td>是</td>
<td></td>
</tr>
<tr>
<td>UserDefault::destroyInstance()</td>
<td>是</td>
<td></td>
</tr>
<tr>
<td>CheckBoxReader::destroyInstance()</td>
<td>是</td>
<td></td>
</tr>
<tr>
<td>NodeReader::destroyInstance()</td>
<td>是</td>
<td></td>
</tr>
<tr>
<td>SingleNodeReader::destroyInstance()</td>
<td>是</td>
<td></td>
</tr>
<tr>
<td>SpriteReader::destroyInstance()</td>
<td>是</td>
<td></td>
</tr>
<tr>
<td>ParticleReader::destroyInstance()</td>
<td>是</td>
<td></td>
</tr>
<tr>
<td>GameMapReader::destroyInstance()</td>
<td>是</td>
<td></td>
</tr>
<tr>
<td>ProjectNodeReader::destroyInstance()</td>
<td>是</td>
<td></td>
</tr>
<tr>
<td>ComAudioReader::destroyInstance()</td>
<td>是</td>
<td></td>
</tr>
<tr>
<td>WidgetReader::destroyInstance()</td>
<td>是</td>
<td></td>
</tr>
<tr>
<td>CheckBoxReader::destroyInstance()</td>
<td>是</td>
<td></td>
</tr>
<tr>
<td>ImageViewReader::destroyInstance()</td>
<td>是</td>
<td></td>
</tr>
<tr>
<td>TextBMFontReader::destroyInstance()</td>
<td>是</td>
<td></td>
</tr>
<tr>
<td>TextReader::destroyInstance()</td>
<td>是</td>
<td></td>
</tr>
<tr>
<td>TextFieldReader::destroyInstance()</td>
<td>是</td>
<td></td>
</tr>
<tr>
<td>TextAtlasReader::destroyInstance()</td>
<td>是</td>
<td></td>
</tr>
<tr>
<td>LoadingBarReader::destroyInstance()</td>
<td>是</td>
<td></td>
</tr>
<tr>
<td>SliderReader::destroyInstance()</td>
<td>是</td>
<td></td>
</tr>
<tr>
<td>LayoutReader::destroyInstance()</td>
<td>是</td>
<td></td>
</tr>
<tr>
<td>ScrollViewReader::destroyInstance()</td>
<td>是</td>
<td></td>
</tr>
<tr>
<td>PageViewReader::destroyInstance()</td>
<td>是</td>
<td></td>
</tr>
<tr>
<td>ListViewReader::destroyInstance()</td>
<td>是</td>
<td></td>
</tr>
<tr>
<td>Node3DReader::destroyInstance()</td>
<td>是</td>
<td></td>
</tr>
<tr>
<td>Sprite3DReader::destroyInstance()</td>
<td>是</td>
<td></td>
</tr>
<tr>
<td>UserCameraReader::destroyInstance()</td>
<td>是</td>
<td></td>
</tr>
<tr>
<td>Particle3DReader::destroyInstance()</td>
<td>是</td>
<td></td>
</tr>
<tr>
<td>CSLoader::destroyInstance()</td>
<td>是</td>
<td></td>
</tr>
<tr>
<td>FlatBuffersSerialize::destroyInstance()</td>
<td>否</td>
<td>一堆调用这个</td>
</tr>
<tr>
<td>GameNode3DReader::destroyInstance()</td>
<td>否</td>
<td>否</td>
</tr>
<tr>
<td>HttpClient::destroyInstance()</td>
<td>否</td>
<td>否</td>
</tr>
<tr>
<td>Light3DReader::destroyInstance()</td>
<td>否</td>
<td>否</td>
</tr>
<tr>
<td>JsonLocalizationManager::destroyInstance()</td>
<td>否</td>
<td>否</td>
</tr>
<tr>
<td>BinLocalizationManager::destroyInstance()</td>
<td>否</td>
<td>否</td>
</tr>
<tr>
<td>ObjectFactory::destroyInstance()</td>
<td>否</td>
<td>是</td>
</tr>
<tr>
<td>SkeletonNodeReader::destroyInstance()</td>
<td>否</td>
<td>否</td>
</tr>
<tr>
<td>SocketIO::destroyInstance()</td>
<td>否</td>
<td>否</td>
</tr>
<tr>
<td>TabControlReader::destroyInstance()</td>
<td>否</td>
<td>否</td>
</tr>
<tr>
<td>TabHeaderReader::destroyInstance()</td>
<td>否</td>
<td>否</td>
</tr>
<tr>
<td>TabItemReader::destroyInstance()</td>
<td>否</td>
<td>否</td>
</tr>
<tr>
<td>TriggerMng::destroyInstance()</td>
<td>是</td>
</tr>
</tbody>
</table>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoferzhang.com/post/20160918ReplayKit/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Yofer Zhang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="http://ww2.sinaimg.cn/mw690/a9c4d5f6jw1e3siexaeopj.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="YoferZhang 的博客">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="YoferZhang 的博客" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/20160918ReplayKit/" itemprop="url">
                  【iOS】ReplayKit库，iOS原生直播神器
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-18T19:38:10+08:00">
                2016-09-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/post/20160918ReplayKit/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="post/20160918ReplayKit/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>版权声明：本文为博主原创，如需转载请注明出处。</p>
</blockquote>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>ReplayKit 是WWDC15推出的苹果原生录屏 API。在iOS9的时候主要提供的是录屏，录制完成后可以进行查看、编辑、通过指定方式分享出去。</p>
<p>在WWDC16上新版的 ReplayKit 提出了了 live 功能，简单说就是通过 ReplayKit 可以进行录屏直播。这对于苹果的手游直播行业有着很重要的意义。</p>
<p>首先给出视频地址和API文档</p>
<ul>
<li><a href="https://developer.apple.com/videos/play/wwdc2016/601/" target="_blank" rel="external">Go Live with ReplayKit - WWDC 2016</a></li>
<li><a href="https://developer.apple.com/reference/replaykit" target="_blank" rel="external">ReplayKit API Reference</a></li>
</ul>
<h2 id="简单测试"><a href="#简单测试" class="headerlink" title="简单测试"></a>简单测试</h2><h3 id="弹出可以接收广播的服务列表"><a href="#弹出可以接收广播的服务列表" class="headerlink" title="弹出可以接收广播的服务列表"></a>弹出可以接收广播的服务列表</h3><p>新建工程，然后加入ReplayKit.frameword</p>
<p>添加一个按钮，然后按钮点击事件弹出广播服务的列表：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">IBAction</span>)displayServiceViewController:(<span class="keyword">id</span>)sender &#123;</span><br><span class="line">    [RPBroadcastActivityViewController loadBroadcastActivityViewControllerWithHandler:^(RPBroadcastActivityViewController * _Nullable broadcastActivityViewController, <span class="built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line">        broadcastActivityViewController.delegate = <span class="keyword">self</span>;</span><br><span class="line">        [<span class="keyword">self</span> presentViewController:broadcastActivityViewController animated:<span class="literal">YES</span> completion:<span class="literal">nil</span>];</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center><br><img src="http://ww1.sinaimg.cn/mw690/a9c4d5f6gw1f805jduzhvj20ku112jsf.jpg" alt=""><br></center>

<h3 id="Mobcrush"><a href="#Mobcrush" class="headerlink" title="Mobcrush"></a>Mobcrush</h3><p>所以想要直播的游戏本身添加这样一个逻辑，弹出服务列表即可。而直播软件也只需要注册为直播服务，就可以直播任何支持的游戏，软件。国外最火最先支持的就是示例中左边的Mobcrush，<a href="https://www.mobcrush.com/WillyWhale/v/57e072ff55eb17c55ba1fee7" target="_blank" rel="external">官网</a>,里面有手机游戏Tower Dash的直播，就是使用这个技术实现的，Tower Dash游戏直播页面为 - <a href="https://www.mobcrush.com/game/TowerDash" target="_blank" rel="external">这里这里</a>，需要科学上网。</p>
<p>我录制了动态图展示：</p>
<center><br><img src="http://ww3.sinaimg.cn/mw690/a9c4d5f6gw1f8066cxc9eg20dc08uqv7.gif" alt=""><br></center>

<p>动态图中可以看出支持摄像头录制，当然还有麦克风，这些已经满足了日常主播的基本需求。</p>
<h3 id="国内"><a href="#国内" class="headerlink" title="国内"></a>国内</h3><p>国内现在映客直播安装就直接有注册为广播服务，所以截图中列表里就有。我还安装了熊猫TV，虎牙直播，虎牙助手，虎牙手游。熊猫TV的主播权限还没有申请下来。虎牙手游貌似使用的也是这个技术，但是实现不一样，虎牙手游直接是在虎牙手游APP内部打开直播，提示成功之后，直接就进入了录屏模式，然后退出返回到手游界面开始游戏就可以。查看了虎牙直播平台，已经有主播使用了iPhone7进行王者荣耀直播，熊猫TV暂时还没有看到用iPhone直播手游的。</p>
<h2 id="WWDC-2016"><a href="#WWDC-2016" class="headerlink" title="WWDC 2016"></a>WWDC 2016</h2><p>下面是观看WWDC16 记录的知识片段。</p>
<h3 id="ReplayKit"><a href="#ReplayKit" class="headerlink" title="ReplayKit"></a>ReplayKit</h3><p>新特性：</p>
<ul>
<li>Apple TV support</li>
<li>Live Broadcasting 直播广播，这个很有用，就是要研究的直播功能 </li>
<li>可以记录 Face Time摄像头的内容，增强了麦克风记录API</li>
</ul>
<center><br><img src="http://ww2.sinaimg.cn/mw690/a9c4d5f6gw1f7xzlp5yiij212i0j4q8w.jpg" alt=""><br></center>

<h2 id="录播功能"><a href="#录播功能" class="headerlink" title="录播功能"></a>录播功能</h2><p>对于录播功能之前就已经有了一个典型的demo，可以直接看下面代码，放进原始功能的第一个viewcontroller里面就Ok了。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">"ViewController.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;ReplayKit/ReplayKit.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> *StartRecord = <span class="string">@"开始"</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> *StopRecord = <span class="string">@"结束"</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#if TARGET_IPHONE_SIMULATOR</span></span><br><span class="line"><span class="meta">#define SIMULATOR 1</span></span><br><span class="line"><span class="meta">#elif TARGET_OS_IPHONE</span></span><br><span class="line"><span class="meta">#define SIMULATOR 0</span></span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#define AnimationDuration (0.3)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> () &lt;<span class="title">RPPreviewViewControllerDelegate</span>&gt;</span></span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>)<span class="built_in">UIButton</span> *btnStart;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>)<span class="built_in">UIButton</span> *btnStop;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>)<span class="built_in">NSTimer</span> *progressTimer;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>)<span class="built_in">UIProgressView</span> *progressView;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>)<span class="built_in">UIActivityIndicatorView</span> *activity;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>)<span class="built_in">UIView</span> *tipView;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>)<span class="built_in">UILabel</span> *lbTip;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>)<span class="built_in">UILabel</span> *lbTime;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    <span class="comment">// Do any additional setup after loading the view, typically from a nib.</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidAppear:(<span class="built_in">BOOL</span>)animated &#123;</span><br><span class="line">    <span class="built_in">BOOL</span> isVersionOk = [<span class="keyword">self</span> isSystemVersionOk];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!isVersionOk) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"系统版本需要是iOS9.0及以上才支持ReplayKit"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (SIMULATOR) &#123;</span><br><span class="line">        [<span class="keyword">self</span> showSimulatorWarning];</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">UILabel</span> *lb = <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">CGSize</span> screenSize = [<span class="built_in">UIScreen</span> mainScreen].bounds.size;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//标题</span></span><br><span class="line">    lb = [[<span class="built_in">UILabel</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">320</span>, <span class="number">140</span>)];</span><br><span class="line">    lb.font = [<span class="built_in">UIFont</span> boldSystemFontOfSize:<span class="number">32</span>];</span><br><span class="line">    lb.backgroundColor = [<span class="built_in">UIColor</span> clearColor];</span><br><span class="line">    lb.textColor = [<span class="built_in">UIColor</span> blackColor];</span><br><span class="line">    lb.textAlignment = <span class="built_in">NSTextAlignmentCenter</span>;</span><br><span class="line">    lb.numberOfLines = <span class="number">3</span>;</span><br><span class="line">    lb.text = <span class="string">@"苹果ReplayKit Demo"</span>;</span><br><span class="line">    lb.center =  <span class="built_in">CGPointMake</span>(screenSize.width/<span class="number">2</span>, <span class="number">80</span>);</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:lb];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//创建按钮</span></span><br><span class="line">    <span class="built_in">UIButton</span> *btn = [<span class="keyword">self</span> createButtonWithTitle:StartRecord andCenter:<span class="built_in">CGPointMake</span>(screenSize.width/<span class="number">2</span> - <span class="number">100</span>, <span class="number">200</span>)];</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:btn];</span><br><span class="line">    <span class="keyword">self</span>.btnStart = btn;</span><br><span class="line">    </span><br><span class="line">    btn = [<span class="keyword">self</span> createButtonWithTitle:StopRecord andCenter:<span class="built_in">CGPointMake</span>(screenSize.width/<span class="number">2</span> + <span class="number">100</span>, <span class="number">200</span>)];</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:btn];</span><br><span class="line">    <span class="keyword">self</span>.btnStop = btn;</span><br><span class="line">    [<span class="keyword">self</span> setButton:btn enabled:<span class="literal">NO</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//loading指示</span></span><br><span class="line">    <span class="built_in">UIActivityIndicatorView</span> *activity = [[<span class="built_in">UIActivityIndicatorView</span> alloc] initWithActivityIndicatorStyle:<span class="built_in">UIActivityIndicatorViewStyleWhiteLarge</span>];</span><br><span class="line">    <span class="built_in">UIView</span> *view = [[<span class="built_in">UIView</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">280</span>, <span class="number">80</span>)];</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:view];</span><br><span class="line">    view.backgroundColor = [<span class="built_in">UIColor</span> redColor];</span><br><span class="line">    view.layer.cornerRadius = <span class="number">8.0</span>f;</span><br><span class="line">    view.center = <span class="built_in">CGPointMake</span>(screenSize.width/<span class="number">2</span>, <span class="number">300</span>);</span><br><span class="line">    activity.center = <span class="built_in">CGPointMake</span>(<span class="number">30</span>, view.frame.size.height/<span class="number">2</span>);</span><br><span class="line">    [view addSubview:activity];</span><br><span class="line">    [activity startAnimating];</span><br><span class="line">    <span class="keyword">self</span>.activity = activity;</span><br><span class="line">    lb = [[<span class="built_in">UILabel</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">280</span>, <span class="number">80</span>)];</span><br><span class="line">    lb.font = [<span class="built_in">UIFont</span> boldSystemFontOfSize:<span class="number">20</span>];</span><br><span class="line">    lb.backgroundColor = [<span class="built_in">UIColor</span> clearColor];</span><br><span class="line">    lb.textColor = [<span class="built_in">UIColor</span> blackColor];</span><br><span class="line">    lb.layer.cornerRadius = <span class="number">4.0</span>;</span><br><span class="line">    lb.textAlignment = <span class="built_in">NSTextAlignmentCenter</span>;</span><br><span class="line">    [view addSubview:lb];</span><br><span class="line">    <span class="keyword">self</span>.lbTip = lb;</span><br><span class="line">    <span class="keyword">self</span>.tipView = view;</span><br><span class="line">    [<span class="keyword">self</span> hideTip];</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//显示时间（用于看录制结果时能知道时间）</span></span><br><span class="line">    lb = [[<span class="built_in">UILabel</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">320</span>, <span class="number">40</span>)];</span><br><span class="line">    lb.font = [<span class="built_in">UIFont</span> boldSystemFontOfSize:<span class="number">20</span>];</span><br><span class="line">    lb.backgroundColor = [<span class="built_in">UIColor</span> redColor];</span><br><span class="line">    lb.textColor = [<span class="built_in">UIColor</span> blackColor];</span><br><span class="line">    lb.layer.cornerRadius = <span class="number">4.0</span>;</span><br><span class="line">    <span class="built_in">NSDateFormatter</span> * dateFormat = [[<span class="built_in">NSDateFormatter</span> alloc] init] ;</span><br><span class="line">    [dateFormat setDateFormat: <span class="string">@"HH:mm:ss"</span>];</span><br><span class="line">    <span class="built_in">NSString</span> *dateString = [dateFormat stringFromDate:[<span class="built_in">NSDate</span> date]];</span><br><span class="line">    lb.text =  dateString;</span><br><span class="line">    lb.center = <span class="built_in">CGPointMake</span>(screenSize.width/<span class="number">2</span>, screenSize.height/<span class="number">2</span> + <span class="number">100</span>);</span><br><span class="line">    lb.textAlignment = <span class="built_in">NSTextAlignmentCenter</span>;</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:lb];</span><br><span class="line">    <span class="keyword">self</span>.lbTime = lb;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//进度条 （显示动画，不然看不出画面的变化）</span></span><br><span class="line">    <span class="built_in">UIProgressView</span> *progress = [[<span class="built_in">UIProgressView</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, screenSize.width*<span class="number">0.8</span>, <span class="number">10</span>)];</span><br><span class="line">    progress.center = <span class="built_in">CGPointMake</span>(screenSize.width/<span class="number">2</span>, screenSize.height/<span class="number">2</span> + <span class="number">150</span>);</span><br><span class="line">    progress.progressViewStyle = <span class="built_in">UIProgressViewStyleDefault</span>;</span><br><span class="line">    progress.progress = <span class="number">0.0</span>;</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:progress];</span><br><span class="line">    <span class="keyword">self</span>.progressView = progress;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//计时器</span></span><br><span class="line">    <span class="comment">//更新时间</span></span><br><span class="line">    [<span class="built_in">NSTimer</span> scheduledTimerWithTimeInterval:<span class="number">1.0</span>f</span><br><span class="line">                                     target:<span class="keyword">self</span></span><br><span class="line">                                   selector:<span class="keyword">@selector</span>(updateTimeString)</span><br><span class="line">                                   userInfo:<span class="literal">nil</span></span><br><span class="line">                                    repeats:<span class="literal">YES</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - UI控件</span></span><br><span class="line"><span class="comment">//显示 提示信息</span></span><br><span class="line">- (<span class="keyword">void</span>)showTipWithText:(<span class="built_in">NSString</span> *)tip activity:(<span class="built_in">BOOL</span>)activity&#123;</span><br><span class="line">    [<span class="keyword">self</span>.activity startAnimating];</span><br><span class="line">    <span class="keyword">self</span>.lbTip.text = tip;</span><br><span class="line">    <span class="keyword">self</span>.tipView.hidden = <span class="literal">NO</span>;</span><br><span class="line">    <span class="keyword">if</span> (activity) &#123;</span><br><span class="line">        <span class="keyword">self</span>.activity.hidden = <span class="literal">NO</span>;</span><br><span class="line">        [<span class="keyword">self</span>.activity startAnimating];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [<span class="keyword">self</span>.activity stopAnimating];</span><br><span class="line">        <span class="keyword">self</span>.activity.hidden = <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//隐藏 提示信息</span></span><br><span class="line">- (<span class="keyword">void</span>)hideTip &#123;</span><br><span class="line">    <span class="keyword">self</span>.tipView.hidden = <span class="literal">YES</span>;</span><br><span class="line">    [<span class="keyword">self</span>.activity stopAnimating];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建按钮</span></span><br><span class="line">- (<span class="built_in">UIButton</span> *)createButtonWithTitle:(<span class="built_in">NSString</span> *)title andCenter:(<span class="built_in">CGPoint</span>)center &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGRect</span> rect = <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">160</span>, <span class="number">60</span>);</span><br><span class="line">    <span class="built_in">UIButton</span> *btn = [[<span class="built_in">UIButton</span> alloc] initWithFrame:rect];</span><br><span class="line">    btn.layer.cornerRadius = <span class="number">5.0</span>;</span><br><span class="line">    btn.layer.borderWidth = <span class="number">2.0</span>;</span><br><span class="line">    btn.layer.borderColor = [[<span class="built_in">UIColor</span> blackColor] <span class="built_in">CGColor</span>];</span><br><span class="line">    btn.backgroundColor = [<span class="built_in">UIColor</span> lightGrayColor];</span><br><span class="line">    btn.center = center;</span><br><span class="line">    [btn setTitle:title forState:<span class="built_in">UIControlStateNormal</span>];</span><br><span class="line">    [btn setTitleColor:[<span class="built_in">UIColor</span> blackColor] forState:<span class="built_in">UIControlStateNormal</span>];</span><br><span class="line">    [btn addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(onBtnPressed:) forControlEvents:<span class="built_in">UIControlEventTouchDown</span>];</span><br><span class="line">    <span class="keyword">return</span> btn;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//设置按钮是否可点击</span></span><br><span class="line">- (<span class="keyword">void</span>)setButton:(<span class="built_in">UIButton</span> *)button enabled:(<span class="built_in">BOOL</span>)enabled &#123;</span><br><span class="line">    <span class="keyword">if</span> (enabled) &#123;</span><br><span class="line">        button.alpha = <span class="number">1.0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        button.alpha = <span class="number">0.2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    button.enabled = enabled;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//提示不支持模拟器</span></span><br><span class="line">- (<span class="keyword">void</span>)showSimulatorWarning &#123;</span><br><span class="line">    <span class="built_in">UIAlertAction</span> *actionOK = [<span class="built_in">UIAlertAction</span> actionWithTitle:<span class="string">@"好的"</span> style:<span class="built_in">UIAlertActionStyleDefault</span> handler:^(<span class="built_in">UIAlertAction</span> *action)&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;];</span><br><span class="line">    <span class="built_in">UIAlertAction</span> *actionCancel = [<span class="built_in">UIAlertAction</span> actionWithTitle:<span class="string">@"取消"</span> style:<span class="built_in">UIAlertActionStyleCancel</span> handler:^(<span class="built_in">UIAlertAction</span> *action)&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;];</span><br><span class="line">    <span class="built_in">UIAlertController</span> *alert = [<span class="built_in">UIAlertController</span> alertControllerWithTitle:<span class="string">@"ReplayKit不支持模拟器"</span> message:<span class="string">@"请使用真机运行这个Demo工程"</span> preferredStyle:<span class="built_in">UIAlertControllerStyleAlert</span>];</span><br><span class="line">    [alert addAction:actionCancel];</span><br><span class="line">    [alert addAction:actionOK];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span> presentViewController:alert animated:<span class="literal">NO</span> completion:<span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//显示弹框提示</span></span><br><span class="line">- (<span class="keyword">void</span>)showAlert:(<span class="built_in">NSString</span> *)title andMessage:(<span class="built_in">NSString</span> *)message &#123;</span><br><span class="line">    <span class="keyword">if</span> (!title) &#123;</span><br><span class="line">        title = <span class="string">@""</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!message) &#123;</span><br><span class="line">        message = <span class="string">@""</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">UIAlertAction</span> *actionCancel = [<span class="built_in">UIAlertAction</span> actionWithTitle:<span class="string">@"好的"</span> style:<span class="built_in">UIAlertActionStyleCancel</span> handler:<span class="literal">nil</span>];</span><br><span class="line">    <span class="built_in">UIAlertController</span> *alert = [<span class="built_in">UIAlertController</span> alertControllerWithTitle:title message:message preferredStyle:<span class="built_in">UIAlertControllerStyleAlert</span>];</span><br><span class="line">    [alert addAction:actionCancel];</span><br><span class="line">    [<span class="keyword">self</span> presentViewController:alert animated:<span class="literal">NO</span> completion:<span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//显示视频预览页面，animation=是否要动画显示</span></span><br><span class="line">- (<span class="keyword">void</span>)showVideoPreviewController:(RPPreviewViewController *)previewController withAnimation:(<span class="built_in">BOOL</span>)animation &#123;</span><br><span class="line">    </span><br><span class="line">    __<span class="keyword">weak</span> ViewController *weakSelf = <span class="keyword">self</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//UI需要放到主线程</span></span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">CGRect</span> rect = [<span class="built_in">UIScreen</span> mainScreen].bounds;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (animation) &#123;</span><br><span class="line">            </span><br><span class="line">            rect.origin.x += rect.size.width;</span><br><span class="line">            previewController.view.frame = rect;</span><br><span class="line">            rect.origin.x -= rect.size.width;</span><br><span class="line">            [<span class="built_in">UIView</span> animateWithDuration:AnimationDuration animations:^()&#123;</span><br><span class="line">                previewController.view.frame = rect;</span><br><span class="line">            &#125; completion:^(<span class="built_in">BOOL</span> finished)&#123;</span><br><span class="line">                </span><br><span class="line">            &#125;];</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            previewController.view.frame = rect;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        [weakSelf.view addSubview:previewController.view];</span><br><span class="line">        [weakSelf addChildViewController:previewController];</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//关闭视频预览页面，animation=是否要动画显示</span></span><br><span class="line">- (<span class="keyword">void</span>)hideVideoPreviewController:(RPPreviewViewController *)previewController withAnimation:(<span class="built_in">BOOL</span>)animation &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//UI需要放到主线程</span></span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">CGRect</span> rect = previewController.view.frame;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (animation) &#123;</span><br><span class="line">            </span><br><span class="line">            rect.origin.x += rect.size.width;</span><br><span class="line">            [<span class="built_in">UIView</span> animateWithDuration:AnimationDuration animations:^()&#123;</span><br><span class="line">                previewController.view.frame = rect;</span><br><span class="line">            &#125; completion:^(<span class="built_in">BOOL</span> finished)&#123;</span><br><span class="line">                <span class="comment">//移除页面</span></span><br><span class="line">                [previewController.view removeFromSuperview];</span><br><span class="line">                [previewController removeFromParentViewController];</span><br><span class="line">            &#125;];</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//移除页面</span></span><br><span class="line">            [previewController.view removeFromSuperview];</span><br><span class="line">            [previewController removeFromParentViewController];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - 按钮 回调</span></span><br><span class="line"><span class="comment">//按钮事件</span></span><br><span class="line">- (<span class="keyword">void</span>)onBtnPressed:(<span class="built_in">UIButton</span> *)sender &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//点击效果</span></span><br><span class="line">    sender.transform = <span class="built_in">CGAffineTransformMakeScale</span>(<span class="number">0.8</span>, <span class="number">0.8</span>);</span><br><span class="line">    <span class="keyword">float</span> duration = <span class="number">0.3</span>;</span><br><span class="line">    [<span class="built_in">UIView</span> animateWithDuration:duration</span><br><span class="line">                     animations:^&#123;</span><br><span class="line">                         sender.transform = <span class="built_in">CGAffineTransformMakeScale</span>(<span class="number">1.1</span>, <span class="number">1.1</span>);</span><br><span class="line">                     &#125;completion:^(<span class="built_in">BOOL</span> finish)&#123;</span><br><span class="line">                         [<span class="built_in">UIView</span> animateWithDuration:duration</span><br><span class="line">                                          animations:^&#123;</span><br><span class="line">                                              sender.transform = <span class="built_in">CGAffineTransformMakeScale</span>(<span class="number">1.0</span>, <span class="number">1.0</span>);</span><br><span class="line">                                          &#125;completion:^(<span class="built_in">BOOL</span> finish)&#123; &#125;];</span><br><span class="line">                     &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSString</span> *function = sender.titleLabel.text;</span><br><span class="line">    <span class="keyword">if</span> ([function isEqualToString:StartRecord]) &#123;</span><br><span class="line">        [<span class="keyword">self</span> startRecord];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ([function isEqualToString:StopRecord]) &#123;</span><br><span class="line">        [<span class="keyword">self</span> stopRecord];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)startRecord &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//    [self setButton:self.btnStart enabled:NO];</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"ReplayKit只支持真机录屏，支持游戏录屏，不支持录avplayer播放的视频"</span>);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"检查机器和版本是否支持ReplayKit录制..."</span>);</span><br><span class="line">    <span class="keyword">if</span> ([[RPScreenRecorder sharedRecorder] isAvailable]) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"支持ReplayKit录制"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"!!不支持支持ReplayKit录制!!"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    __<span class="keyword">weak</span> ViewController *weakSelf = <span class="keyword">self</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@ 录制"</span>, StartRecord);</span><br><span class="line">    [<span class="keyword">self</span> showTipWithText:<span class="string">@"录制初始化"</span> activity:<span class="literal">YES</span>];</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    [[RPScreenRecorder sharedRecorder] startRecordingWithHandler:^(<span class="built_in">NSError</span> *error)&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"录制开始..."</span>);</span><br><span class="line">        [weakSelf hideTip];</span><br><span class="line">        <span class="keyword">if</span> (error) &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"错误信息 %@"</span>, error);</span><br><span class="line">            [weakSelf showTipWithText:error.description activity:<span class="literal">NO</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//其他处理</span></span><br><span class="line">            [weakSelf setButton:<span class="keyword">self</span>.btnStop enabled:<span class="literal">YES</span>];</span><br><span class="line">            [weakSelf setButton:<span class="keyword">self</span>.btnStart enabled:<span class="literal">NO</span>];</span><br><span class="line">            </span><br><span class="line">            [weakSelf showTipWithText:<span class="string">@"正在录制"</span> activity:<span class="literal">NO</span>];</span><br><span class="line">            <span class="comment">//更新进度条</span></span><br><span class="line">            weakSelf.progressTimer = [<span class="built_in">NSTimer</span> scheduledTimerWithTimeInterval:<span class="number">0.05</span>f</span><br><span class="line">                                                                      target:<span class="keyword">self</span></span><br><span class="line">                                                                    selector:<span class="keyword">@selector</span>(changeProgressValue)</span><br><span class="line">                                                                    userInfo:<span class="literal">nil</span></span><br><span class="line">                                                                     repeats:<span class="literal">YES</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)stopRecord &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@ 录制"</span>, StopRecord);</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span> setButton:<span class="keyword">self</span>.btnStart enabled:<span class="literal">YES</span>];</span><br><span class="line">    [<span class="keyword">self</span> setButton:<span class="keyword">self</span>.btnStop enabled:<span class="literal">NO</span>];</span><br><span class="line">    </span><br><span class="line">    __<span class="keyword">weak</span> ViewController *weakSelf = <span class="keyword">self</span>;</span><br><span class="line">    [[RPScreenRecorder sharedRecorder] stopRecordingWithHandler:^(RPPreviewViewController *previewViewController, <span class="built_in">NSError</span> *  error)&#123;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (error) &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"失败消息:%@"</span>, error);</span><br><span class="line">            [weakSelf showTipWithText:error.description activity:<span class="literal">NO</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            </span><br><span class="line">            [weakSelf showTipWithText:<span class="string">@"录制完成"</span> activity:<span class="literal">NO</span>];</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//显示录制到的视频的预览页</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"显示预览页面"</span>);</span><br><span class="line">            previewViewController.previewControllerDelegate = weakSelf;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//去除计时器</span></span><br><span class="line">            [weakSelf.progressTimer invalidate];</span><br><span class="line">            weakSelf.progressTimer = <span class="literal">nil</span>;</span><br><span class="line">            </span><br><span class="line">            [<span class="keyword">self</span> showVideoPreviewController:previewViewController withAnimation:<span class="literal">YES</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - 视频预览页面 回调</span></span><br><span class="line"><span class="comment">//关闭的回调</span></span><br><span class="line">- (<span class="keyword">void</span>)previewControllerDidFinish:(RPPreviewViewController *)previewController &#123;</span><br><span class="line">    [<span class="keyword">self</span> hideVideoPreviewController:previewController withAnimation:<span class="literal">YES</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//选择了某些功能的回调（如分享和保存）</span></span><br><span class="line">- (<span class="keyword">void</span>)previewController:(RPPreviewViewController *)previewController didFinishWithActivityTypes:(<span class="built_in">NSSet</span> &lt;<span class="built_in">NSString</span> *&gt; *)activityTypes &#123;</span><br><span class="line">    </span><br><span class="line">    __<span class="keyword">weak</span> ViewController *weakSelf = <span class="keyword">self</span>;</span><br><span class="line">    <span class="keyword">if</span> ([activityTypes containsObject:<span class="string">@"com.apple.UIKit.activity.SaveToCameraRoll"</span>]) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">            [weakSelf showAlert:<span class="string">@"保存成功"</span> andMessage:<span class="string">@"已经保存到系统相册"</span>];</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ([activityTypes containsObject:<span class="string">@"com.apple.UIKit.activity.CopyToPasteboard"</span>]) &#123;</span><br><span class="line">        <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">            [weakSelf showAlert:<span class="string">@"复制成功"</span> andMessage:<span class="string">@"已经复制到粘贴板"</span>];</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - 计时器 回调</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//改变进度条的显示的进度</span></span><br><span class="line">- (<span class="keyword">void</span>)changeProgressValue &#123;</span><br><span class="line">    <span class="keyword">float</span> progress = <span class="keyword">self</span>.progressView.progress + <span class="number">0.01</span>;</span><br><span class="line">    [<span class="keyword">self</span>.progressView setProgress:progress animated:<span class="literal">NO</span>];</span><br><span class="line">    <span class="keyword">if</span> (progress &gt;= <span class="number">1.0</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.progressView.progress = <span class="number">0.0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//更新显示的时间</span></span><br><span class="line">- (<span class="keyword">void</span>)updateTimeString &#123;</span><br><span class="line">    <span class="built_in">NSDateFormatter</span> * dateFormat = [[<span class="built_in">NSDateFormatter</span> alloc] init] ;</span><br><span class="line">    [dateFormat setDateFormat: <span class="string">@"HH:mm:ss"</span>];</span><br><span class="line">    <span class="built_in">NSString</span> *dateString = [dateFormat stringFromDate:[<span class="built_in">NSDate</span> date]];</span><br><span class="line">    <span class="keyword">self</span>.lbTime.text =  dateString;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - 其他</span></span><br><span class="line">- (<span class="keyword">void</span>)didReceiveMemoryWarning &#123;</span><br><span class="line">    [<span class="keyword">super</span> didReceiveMemoryWarning];</span><br><span class="line">    <span class="comment">// Dispose of any resources that can be recreated.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//判断对应系统版本是否支持ReplayKit</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)isSystemVersionOk &#123;</span><br><span class="line">    <span class="keyword">if</span> ([[<span class="built_in">UIDevice</span> currentDevice].systemVersion floatValue] &lt; <span class="number">9.0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>新博客文章地址：<a href="http://yoferzhang.com/post/20160918ReplayKit/">ReplayKit库，iOS原生直播神器</a><br>CSDN文章地址：<a href="http://blog.csdn.net/zyq522376829/article/details/52605411" target="_blank" rel="external">ReplayKit库，iOS原生直播神器</a></p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoferzhang.com/post/20160909ErrorLibpngErrorUnhandledCritical/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Yofer Zhang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="http://ww2.sinaimg.cn/mw690/a9c4d5f6jw1e3siexaeopj.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="YoferZhang 的博客">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="YoferZhang 的博客" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/20160909ErrorLibpngErrorUnhandledCritical/" itemprop="url">
                  【iOS】cocos2dx在xcode8 GM版下的错误`libpng error:CgBI:unhandled critical chunk`
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-09T09:22:59+08:00">
                2016-09-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/post/20160909ErrorLibpngErrorUnhandledCritical/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="post/20160909ErrorLibpngErrorUnhandledCritical/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>版权声明：本文为博主原创，如需转载请注明出处。</p>
</blockquote>
<p>XCode 8 GM 版本编译 cocos2dx的代码，在加载 sprite 时，比如</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sprite-&gt;setPosition(Vec2(visibleSize.width/<span class="number">2</span> + origin.x, visibleSize.height/<span class="number">2</span> + origin.y));</span><br></pre></td></tr></table></figure>
<p>会弹出错误：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">libpng error: CgBI: unhandled critical chunk</span><br><span class="line">libpng error: CgBI: unhandled critical chunk</span><br><span class="line">libpng error: CgBI: unhandled critical chunk</span><br></pre></td></tr></table></figure>
<p>网上看了一下，xcode7.3 刚出来，升级上来的时候也会出现这个问题，最后彻底解决需要修改两个参数：</p>
<center><br><img src="http://ww4.sinaimg.cn/mw690/a9c4d5f6gw1f7n2v6sjblj21nm0em0vj.jpg" alt=""><br></center>

<p>就是把下面两个都设置为 NO 即可</p>
<ul>
<li>Compress PNG Images</li>
<li>Remove Text Metadata From PNG Files</li>
</ul>
<blockquote>
<p>新博客文章地址：<a href="">cocos2dx在xcode8 GM版下的错误<code>libpng error:CgBI:unhandled critical chunk</code></a><br>CSDN文章地址：<a href="http://blog.csdn.net/zyq522376829/article/details/52484182" target="_blank" rel="external">cocos2dx在xcode8 GM版下的错误<code>libpng error:CgBI:unhandled critical chunk</code></a></p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoferzhang.com/post/20160906OpenGLESPG/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Yofer Zhang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="http://ww2.sinaimg.cn/mw690/a9c4d5f6jw1e3siexaeopj.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="YoferZhang 的博客">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="YoferZhang 的博客" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/20160906OpenGLESPG/" itemprop="url">
                  【iOS】OpenGL ES Programming Guide for iOS
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-06T16:19:31+08:00">
                2016-09-06
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/post/20160906OpenGLESPG/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="post/20160906OpenGLESPG/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>版权声明：本文为博主原创，如需转载请注明出处。</p>
</blockquote>
<h1 id="关于-OpenGL-ES"><a href="#关于-OpenGL-ES" class="headerlink" title="关于 OpenGL ES"></a>关于 OpenGL ES</h1><center><br><img src="http://ww3.sinaimg.cn/mw690/a9c4d5f6gw1f7jxzm4u2dj211d06xjsk.jpg" alt=""><br></center>

<h2 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h2><h3 id="OpenGL-ES-Is-a-Platform-Neutral-API-Implemented-in-iOS"><a href="#OpenGL-ES-Is-a-Platform-Neutral-API-Implemented-in-iOS" class="headerlink" title="OpenGL ES Is a Platform-Neutral API Implemented in iOS"></a>OpenGL ES Is a Platform-Neutral API Implemented in iOS</h3><h3 id="GLKit-Provides-a-Drawing-Surface-and-Animation-Support"><a href="#GLKit-Provides-a-Drawing-Surface-and-Animation-Support" class="headerlink" title="GLKit Provides a Drawing Surface and Animation Support"></a>GLKit Provides a Drawing Surface and Animation Support</h3><p><a href="https://developer.apple.com/library/ios/documentation/GLkit/Reference/GLKView_ClassReference/index.html#//apple_ref/occ/cl/GLKView" target="_blank" rel="external">GLKView</a>, <a href="https://developer.apple.com/library/ios/documentation/GLkit/Reference/GLKViewController_ClassRef/index.html#//apple_ref/occ/cl/GLKViewController" target="_blank" rel="external">GLKViewController</a></p>
<h3 id="iOS-Supports-Alternative-Rendering-Targets"><a href="#iOS-Supports-Alternative-Rendering-Targets" class="headerlink" title="iOS Supports Alternative Rendering Targets"></a>iOS Supports Alternative Rendering Targets</h3><p><a href="https://developer.apple.com/library/ios/documentation/QuartzCore/Reference/CAEAGLLayer_Class/index.html#//apple_ref/occ/cl/CAEAGLLayer" target="_blank" rel="external">CAEAGLLayer</a></p>
<h3 id="应用程序可能需要额外的性能优化"><a href="#应用程序可能需要额外的性能优化" class="headerlink" title="应用程序可能需要额外的性能优化"></a>应用程序可能需要额外的性能优化</h3><h1 id="建立OpenGLES-应用需要完成的事"><a href="#建立OpenGLES-应用需要完成的事" class="headerlink" title="建立OpenGLES 应用需要完成的事"></a>建立OpenGLES 应用需要完成的事</h1><p><a href="https://developer.apple.com/reference/opengles/eaglcontext" target="_blank" rel="external">EAGLContext</a>类实现了渲染的内容。iOS只提供了帧缓存的一种类型，</p>
<blockquote>
<p>新博客文章地址：<a href=""></a><br>CSDN文章地址：<a href=""></a></p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoferzhang.com/post/20160905CoreAnimationProgrammingGuide/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Yofer Zhang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="http://ww2.sinaimg.cn/mw690/a9c4d5f6jw1e3siexaeopj.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="YoferZhang 的博客">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="YoferZhang 的博客" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/20160905CoreAnimationProgrammingGuide/" itemprop="url">
                  【iOS】Core Animation Programming Guide 核心动画编程指南
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-05T10:18:23+08:00">
                2016-09-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/post/20160905CoreAnimationProgrammingGuide/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="post/20160905CoreAnimationProgrammingGuide/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>版权声明：本文为博主原创，如需转载请注明出处。</p>
</blockquote>
<h1 id="1-有关核心动画"><a href="#1-有关核心动画" class="headerlink" title="1 有关核心动画"></a>1 有关核心动画</h1><center><br><img src="http://ww2.sinaimg.cn/mw690/a9c4d5f6gw1f7ihw01x5dj20eo0auaay.jpg" alt=""><br></center>

<h2 id="1-1-概览"><a href="#1-1-概览" class="headerlink" title="1.1 概览"></a>1.1 概览</h2><h3 id="1-1-1-Core-Animation-管理应用的内容"><a href="#1-1-1-Core-Animation-管理应用的内容" class="headerlink" title="1.1.1 Core Animation 管理应用的内容"></a>1.1.1 Core Animation 管理应用的内容</h3><p>核心是 layer objects，</p>
<h3 id="1-1-2-更改-layer-触发动画"><a href="#1-1-2-更改-layer-触发动画" class="headerlink" title="1.1.2 更改 layer 触发动画"></a>1.1.2 更改 layer 触发动画</h3><p>Like views, layer objects have a bounds rectangle, a position onscreen, an opacity, a transform, and many other visually-oriented properties that can be modified. 更改这些属性的时候有隐式动画，可以明确指定动画行为。</p>
<h3 id="1-1-3-layer可以组织成层级结构"><a href="#1-1-3-layer可以组织成层级结构" class="headerlink" title="1.1.3 layer可以组织成层级结构"></a>1.1.3 layer可以组织成层级结构</h3><h3 id="1-1-4-action-让你更改图层的默认行为"><a href="#1-1-4-action-让你更改图层的默认行为" class="headerlink" title="1.1.4 action 让你更改图层的默认行为"></a>1.1.4 action 让你更改图层的默认行为</h3><p>隐式layer动画是使用 action objects。可以创建自己的 action objects ，实现自定义动画，或者也能实现其他类型的行为。</p>
<h2 id="1-2-如果使用这个文档"><a href="#1-2-如果使用这个文档" class="headerlink" title="1.2 如果使用这个文档"></a>1.2 如果使用这个文档</h2><h2 id="1-3-预备工作"><a href="#1-3-预备工作" class="headerlink" title="1.3 预备工作"></a>1.3 预备工作</h2><p>先熟悉 <a href="https://developer.apple.com/library/ios/documentation/WindowsViews/Conceptual/ViewPG_iPhoneOS/Introduction/Introduction.html#//apple_ref/doc/uid/TP40009503" target="_blank" rel="external">View Programming Guide for iOS.</a></p>
<h1 id="核心动画基础"><a href="#核心动画基础" class="headerlink" title="核心动画基础"></a>核心动画基础</h1><h2 id="layer-提供绘图和动画的基础"><a href="#layer-提供绘图和动画的基础" class="headerlink" title="layer 提供绘图和动画的基础"></a>layer 提供绘图和动画的基础</h2><p>Layer objects 对核心。layer只是管理内容和可视化属性，所以可以将layer想成 model 对象</p>
<h3 id="基于-layer-的绘图模型"><a href="#基于-layer-的绘图模型" class="headerlink" title="基于 layer 的绘图模型"></a>基于 layer 的绘图模型</h3><center><br><img src="http://ww4.sinaimg.cn/large/a9c4d5f6gw1f7io9tnsp7j21430ezdk0.jpg" alt="核心动画如何绘制内容"><br></center>

<p>对于 view 中调用 <code>drawRect:</code> 方法，非常的损耗，因为这在线程上使用CPU。核心动画通过在硬件上缓存位图来达到同样或相似的效果。</p>
<h3 id="基于-layer-的动画"><a href="#基于-layer-的动画" class="headerlink" title="基于 layer 的动画"></a>基于 layer 的动画</h3><center><br><img src="http://ww1.sinaimg.cn/mw690/a9c4d5f6gw1f7iogy5x0zj20yu0mcjw1.jpg" alt="可以在 layer 上执行动画的例子"><br></center>

<h2 id="layer-对象定义自己的几何"><a href="#layer-对象定义自己的几何" class="headerlink" title="layer 对象定义自己的几何"></a>layer 对象定义自己的几何</h2><p>layer 也有像view 有的一些属性，frame bounds，并且也有类似 anchor poing(锚点)这种 view 没有的属性。</p>
<h3 id="layer-使用两种类型的坐标系"><a href="#layer-使用两种类型的坐标系" class="headerlink" title="layer 使用两种类型的坐标系"></a>layer 使用两种类型的坐标系</h3><p>point-based coordinate systems 和 unit coordinate systems</p>
<p>通常使用 point-based 坐标系指定 layer 的大小和位置，</p>
<center><br><img src="http://ww2.sinaimg.cn/mw690/a9c4d5f6gw1f7iorcrjg7j20ul0c4mzv.jpg" alt="iOS 和 OS X 的默认 layer geometries"><br></center>

<p>unit coordinate system (单位坐标系)是用来表示当 layer 的大小变化的时候哪些属性可能改变。可以认为单位坐标系指定所有可能变化值的百分比。</p>
<center><br><img src="http://ww4.sinaimg.cn/mw690/a9c4d5f6gw1f7iowm9t9wj20po0b93zi.jpg" alt="The default unit coordinate systems for iOS and OS X"><br></center>

<h3 id="锚点影响几何操作"><a href="#锚点影响几何操作" class="headerlink" title="锚点影响几何操作"></a>锚点影响几何操作</h3><center><br><img src="http://ww4.sinaimg.cn/large/a9c4d5f6gw1f7ip2b9d0nj210i14caew.jpg" alt="How the anchor point affects the layer’s position property"><br></center>

<center><br><img src="http://ww1.sinaimg.cn/large/a9c4d5f6gw1f7ip53pw8pj210i0ziwil.jpg" alt="How the anchor point affects layer transformations"><br></center>

<h3 id="layer-可以在三维空间中操作"><a href="#layer-可以在三维空间中操作" class="headerlink" title="layer 可以在三维空间中操作"></a>layer 可以在三维空间中操作</h3><center><br><img src="http://ww1.sinaimg.cn/mw690/a9c4d5f6gw1f7ipd2pvucj20fu0790t2.jpg" alt="Converting a coordinate using matrix math"><br></center>

<center><br><img src="http://ww1.sinaimg.cn/mw690/a9c4d5f6gw1f7iph2e6nmj20hl0kfdgk.jpg" alt="Matrix configurations for common transformations"><br></center>

<p><a href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/CoreAnimation_functions/index.html#//apple_ref/doc/uid/TP40004512" target="_blank" rel="external">Core Animation Functions Reference.</a></p>
<h2 id="layer-树反映了动画状态的不同方面"><a href="#layer-树反映了动画状态的不同方面" class="headerlink" title="layer 树反映了动画状态的不同方面"></a>layer 树反映了动画状态的不同方面</h2><p>有3个 layer 对象集合：</p>
<ul>
<li>model layer tree 中的对象是模型对象，存储动画的目标值</li>
<li>presentation tree包含动画运行中的值。你应该从来都不要去修改这个 tree 中的对象。使用这些对象读取当前动画的值，或者使用这些值开始新的动画。</li>
<li>render tree 中的对象执行实际的动画，这是核心动画私有的</li>
</ul>
<center><br><img src="http://ww2.sinaimg.cn/mw690/a9c4d5f6gw1f7ipqm15vej20ys0l3777.jpg" alt="Layers associated with a window"><br></center>

<center><br><img src="http://ww1.sinaimg.cn/mw690/a9c4d5f6gw1f7ipsmeoppj213l0v3acu.jpg" alt="The layer trees for a window"><br></center>

<h2 id="layer-和-view-之间的关系"><a href="#layer-和-view-之间的关系" class="headerlink" title="layer 和 view 之间的关系"></a>layer 和 view 之间的关系</h2><p>layer 不是 view 的替代品，不能单独靠layer 对象创建一个可视化的界面。layer 提供了 view 的基础。layer 使得view内容的绘制和动画更加有效，并且动画有较高的帧率，就是更流畅。layer不能处理事件，不能绘制内容，不能参与到响应链等等。所以应用必须有一个或多个 view 来处理这种交互</p>
<h1 id="设置-layer-对象"><a href="#设置-layer-对象" class="headerlink" title="设置 layer 对象"></a>设置 layer 对象</h1><h2 id="激活核心动画支持"><a href="#激活核心动画支持" class="headerlink" title="激活核心动画支持"></a>激活核心动画支持</h2><h2 id="更改与视图相关的-layer-对象"><a href="#更改与视图相关的-layer-对象" class="headerlink" title="更改与视图相关的 layer 对象"></a>更改与视图相关的 layer 对象</h2><h3 id="改变-UIView-使用的-layer-class"><a href="#改变-UIView-使用的-layer-class" class="headerlink" title="改变 UIView 使用的 layer class"></a>改变 UIView 使用的 layer class</h3><p>重写 layerClass 类方法 返回想要替换的 类对象。</p>
<p>指定 view 的 layer 类</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+ (Class) layerClass &#123;</span><br><span class="line">   <span class="keyword">return</span> [<span class="built_in">CAMetalLayer</span> class];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Changing-the-Layer-Class-Used-By-NSView"><a href="#Changing-the-Layer-Class-Used-By-NSView" class="headerlink" title="Changing the Layer Class Used By NSView"></a>Changing the Layer Class Used By NSView</h3><h3 id="不同的-layer-类提供专属行为"><a href="#不同的-layer-类提供专属行为" class="headerlink" title="不同的 layer 类提供专属行为"></a>不同的 layer 类提供专属行为</h3><p>CALayer子类及其用法</p>
<table>
<thead>
<tr>
<th>Class</th>
<th>Usage</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href=""></a></td>
<td></td>
</tr>
<tr>
<td><a href=""></a></td>
<td></td>
</tr>
<tr>
<td><a href=""></a></td>
<td></td>
</tr>
<tr>
<td><a href=""></a></td>
<td></td>
</tr>
<tr>
<td><a href=""></a></td>
<td></td>
</tr>
<tr>
<td><a href=""></a></td>
<td></td>
</tr>
<tr>
<td><a href=""></a></td>
<td></td>
</tr>
<tr>
<td><a href=""></a></td>
<td></td>
</tr>
<tr>
<td><a href=""></a></td>
<td></td>
</tr>
<tr>
<td><a href=""></a></td>
<td></td>
</tr>
<tr>
<td><a href=""></a></td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="给-layer-提供内容"><a href="#给-layer-提供内容" class="headerlink" title="给 layer 提供内容"></a>给 layer 提供内容</h2><p>3种方式给layer的位图提供数据：</p>
<ul>
<li>直接给layer对象的 <a href="https://developer.apple.com/library/ios/documentation/GraphicsImaging/Reference/CALayer_class/index.html#//apple_ref/occ/instp/CALayer/contents" target="_blank" rel="external">contents</a> 属性赋值一个 image 对象。这是最好的方法</li>
<li>给layer赋值一个代理对象，并让代理绘制 layer 的内容。（适合内容周期性的变化，比如随着 view变化）</li>
<li>定义一个 layer 子类，并重写一个它的绘制方法</li>
</ul>
<h3 id="给-layer-内容设置图像"><a href="#给-layer-内容设置图像" class="headerlink" title="给 layer 内容设置图像"></a>给 layer 内容设置图像</h3><p>将image 赋值给 layer必须是 <a href="https://developer.apple.com/library/ios/documentation/GraphicsImaging/Reference/CGImage/index.html#//apple_ref/c/tdef/CGImageRef" target="_blank" rel="external">CGImageRef</a> 类型。</p>
<h3 id="使用代理给layer提供内容"><a href="#使用代理给layer提供内容" class="headerlink" title="使用代理给layer提供内容"></a>使用代理给layer提供内容</h3><p>代理实现 <code>displayLayer:</code> 方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)displayLayer:(<span class="built_in">CALayer</span> *)theLayer &#123;</span><br><span class="line">    <span class="comment">// Check the value of some state property</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.displayYesImage) &#123;</span><br><span class="line">        <span class="comment">// Display the Yes image</span></span><br><span class="line">        theLayer.contents = [someHelperObject loadStateYesImage];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Display the No image</span></span><br><span class="line">        theLayer.contents = [someHelperObject loadStateNoImage];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代理实现 <code>drawLayer:inContext:</code> 方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)drawLayer:(<span class="built_in">CALayer</span> *)theLayer inContext:(<span class="built_in">CGContextRef</span>)theContext &#123;</span><br><span class="line">    <span class="built_in">CGMutablePathRef</span> thePath = <span class="built_in">CGPathCreateMutable</span>();</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">CGPathMoveToPoint</span>(thePath,<span class="literal">NULL</span>,<span class="number">15.0</span>f,<span class="number">15.</span>f);</span><br><span class="line">    <span class="built_in">CGPathAddCurveToPoint</span>(thePath,</span><br><span class="line">                          <span class="literal">NULL</span>,</span><br><span class="line">                          <span class="number">15.</span>f,<span class="number">250.0</span>f,</span><br><span class="line">                          <span class="number">295.0</span>f,<span class="number">250.0</span>f,</span><br><span class="line">                          <span class="number">295.0</span>f,<span class="number">15.0</span>f);</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">CGContextBeginPath</span>(theContext);</span><br><span class="line">    <span class="built_in">CGContextAddPath</span>(theContext, thePath);</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">CGContextSetLineWidth</span>(theContext, <span class="number">5</span>);</span><br><span class="line">    <span class="built_in">CGContextStrokePath</span>(theContext);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Release the path</span></span><br><span class="line">    <span class="built_in">CFRelease</span>(thePath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="通过子类给-layer-提供内容"><a href="#通过子类给-layer-提供内容" class="headerlink" title="通过子类给 layer 提供内容"></a>通过子类给 layer 提供内容</h3><ul>
<li>重写 layer 的 <a href="https://developer.apple.com/library/ios/documentation/GraphicsImaging/Reference/CALayer_class/index.html#//apple_ref/occ/instm/CALayer/display" target="_blank" rel="external">display</a> 方法，并使用它直接设置contents属性</li>
<li>重写 layer 的 <a href="https://developer.apple.com/library/ios/documentation/GraphicsImaging/Reference/CALayer_class/index.html#//apple_ref/occ/instm/CALayer/drawInContext:" target="_blank" rel="external">drawInContext:</a> 方法，并使用它来绘制图像内容</li>
</ul>
<h3 id="调整提供的内容"><a href="#调整提供的内容" class="headerlink" title="调整提供的内容"></a>调整提供的内容</h3><center><br><img src="http://ww1.sinaimg.cn/mw690/a9c4d5f6gw1f7iy72b827j20sz0i8wg6.jpg" alt="Position-based gravity constants for layers"><br></center>

<p>layer 的 contentsGravity 属性模式的设置是 <a href="https://developer.apple.com/library/ios/documentation/GraphicsImaging/Reference/CALayer_class/index.html#//apple_ref/c/data/kCAGravityResize" target="_blank" rel="external">kCAGravityResize</a> 常量。</p>
<center><br><img src="http://ww1.sinaimg.cn/large/a9c4d5f6gw1f7iybek8e7j20pe0djdkc.jpg" alt="Scaling-based gravity constants for layers"><br></center>

<h3 id="高分辨率图像"><a href="#高分辨率图像" class="headerlink" title="高分辨率图像"></a>高分辨率图像</h3><h2 id="调整图层的视觉风格和外观"><a href="#调整图层的视觉风格和外观" class="headerlink" title="调整图层的视觉风格和外观"></a>调整图层的视觉风格和外观</h2><h3 id="layer-有自己的背景和边界"><a href="#layer-有自己的背景和边界" class="headerlink" title="layer 有自己的背景和边界"></a>layer 有自己的背景和边界</h3><center><br><img src="http://ww1.sinaimg.cn/mw690/a9c4d5f6gw1f7iyns91knj20j30ff0uh.jpg" alt="Adding a border and background to a layer"><br></center>

<h3 id="layer-支持半径圆角"><a href="#layer-支持半径圆角" class="headerlink" title="layer 支持半径圆角"></a>layer 支持半径圆角</h3><center><br><img src="http://ww2.sinaimg.cn/mw690/a9c4d5f6gw1f7jmka87j0j20re0inmxu.jpg" alt=""><br></center>

<h3 id="layer-支持内建阴影"><a href="#layer-支持内建阴影" class="headerlink" title="layer 支持内建阴影"></a>layer 支持内建阴影</h3><center><br><img src="http://ww2.sinaimg.cn/mw690/a9c4d5f6gw1f7jn4qu1oxj20lx0bptay.jpg" alt=""><br></center>

<h3 id="OS-X-的view-添加过滤效果"><a href="#OS-X-的view-添加过滤效果" class="headerlink" title="OS X 的view 添加过滤效果"></a>OS X 的view 添加过滤效果</h3><p>iOS 不能给 layer 对象添加过滤器</p>
<h2 id="对于-OS-X-性能影响的-layer-重回策略"><a href="#对于-OS-X-性能影响的-layer-重回策略" class="headerlink" title="对于 OS X 性能影响的 layer 重回策略"></a>对于 OS X 性能影响的 layer 重回策略</h2><h2 id="给-layer-添加自定义属性"><a href="#给-layer-添加自定义属性" class="headerlink" title="给 layer 添加自定义属性"></a>给 layer 添加自定义属性</h2><h1 id="Animating-Layer-Content"><a href="#Animating-Layer-Content" class="headerlink" title="Animating Layer Content"></a>Animating Layer Content</h1><h2 id="修改-layer-属性，达到简单动画效果"><a href="#修改-layer-属性，达到简单动画效果" class="headerlink" title="修改 layer 属性，达到简单动画效果"></a>修改 layer 属性，达到简单动画效果</h2><p>精确的动画，需要创建一个 <a href="https://developer.apple.com/library/ios/documentation/GraphicsImaging/Reference/CABasicAnimation_class/index.html#//apple_ref/occ/cl/CABasicAnimation" target="_blank" rel="external">CABasicAnimation</a> 对象，使用这个对象来配置参数。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CABasicAnimation</span>* fadeAnim = [<span class="built_in">CABasicAnimation</span> animationWithKeyPath:<span class="string">@"opacity"</span>];</span><br><span class="line">fadeAnim.fromValue = [<span class="built_in">NSNumber</span> numberWithFloat:<span class="number">1.0</span>];</span><br><span class="line">fadeAnim.toValue = [<span class="built_in">NSNumber</span> numberWithFloat:<span class="number">0.0</span>];</span><br><span class="line">fadeAnim.duration = <span class="number">1.0</span>;</span><br><span class="line">[theLayer addAnimation:fadeAnim forKey:<span class="string">@"opacity"</span>];</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Change the actual data value in the layer to the final value.</span></span><br><span class="line">theLayer.opacity = <span class="number">0.0</span>;</span><br></pre></td></tr></table></figure>
<h2 id="使用关键帧动画来改变-layer-的属性"><a href="#使用关键帧动画来改变-layer-的属性" class="headerlink" title="使用关键帧动画来改变 layer 的属性"></a>使用关键帧动画来改变 layer 的属性</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// create a CGPath that implements two arcs (a bounce)</span></span><br><span class="line"><span class="built_in">CGMutablePathRef</span> thePath = <span class="built_in">CGPathCreateMutable</span>();</span><br><span class="line"><span class="built_in">CGPathMoveToPoint</span>(thePath,<span class="literal">NULL</span>,<span class="number">74.0</span>,<span class="number">74.0</span>);</span><br><span class="line"><span class="built_in">CGPathAddCurveToPoint</span>(thePath,<span class="literal">NULL</span>,<span class="number">74.0</span>,<span class="number">500.0</span>,</span><br><span class="line">                                   <span class="number">320.0</span>,<span class="number">500.0</span>,</span><br><span class="line">                                   <span class="number">320.0</span>,<span class="number">74.0</span>);</span><br><span class="line"><span class="built_in">CGPathAddCurveToPoint</span>(thePath,<span class="literal">NULL</span>,<span class="number">320.0</span>,<span class="number">500.0</span>,</span><br><span class="line">                                   <span class="number">566.0</span>,<span class="number">500.0</span>,</span><br><span class="line">                                   <span class="number">566.0</span>,<span class="number">74.0</span>);</span><br><span class="line"> </span><br><span class="line"><span class="built_in">CAKeyframeAnimation</span> * theAnimation;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Create the animation object, specifying the position property as the key path.</span></span><br><span class="line">theAnimation=[<span class="built_in">CAKeyframeAnimation</span> animationWithKeyPath:<span class="string">@"position"</span>];</span><br><span class="line">theAnimation.path=thePath;</span><br><span class="line">theAnimation.duration=<span class="number">5.0</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Add the animation to the layer.</span></span><br><span class="line">[theLayer addAnimation:theAnimation forKey:<span class="string">@"position"</span>];</span><br></pre></td></tr></table></figure>
<h3 id="指定-keyframe-的值"><a href="#指定-keyframe-的值" class="headerlink" title="指定 keyframe 的值"></a>指定 keyframe 的值</h3><h2 id="在动画运行的时候，停止动画"><a href="#在动画运行的时候，停止动画" class="headerlink" title="在动画运行的时候，停止动画"></a>在动画运行的时候，停止动画</h2><p><code>removeAnimationForKey:</code> <code>removeAllAnimations</code> </p>
<p>只能移除显示动画，不能移除隐式动画。</p>
<h2 id="多个动画一起变化"><a href="#多个动画一起变化" class="headerlink" title="多个动画一起变化"></a>多个动画一起变化</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Animation 1</span></span><br><span class="line"><span class="built_in">CAKeyframeAnimation</span>* widthAnim = [<span class="built_in">CAKeyframeAnimation</span> animationWithKeyPath:<span class="string">@"borderWidth"</span>];</span><br><span class="line"><span class="built_in">NSArray</span>* widthValues = [<span class="built_in">NSArray</span> arrayWithObjects:@<span class="number">1.0</span>, @<span class="number">10.0</span>, @<span class="number">5.0</span>, @<span class="number">30.0</span>, @<span class="number">0.5</span>, @<span class="number">15.0</span>, @<span class="number">2.0</span>, @<span class="number">50.0</span>, @<span class="number">0.0</span>, <span class="literal">nil</span>];</span><br><span class="line">widthAnim.values = widthValues;</span><br><span class="line">widthAnim.calculationMode = k<span class="built_in">CAAnimationPaced</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Animation 2</span></span><br><span class="line"><span class="built_in">CAKeyframeAnimation</span>* colorAnim = [<span class="built_in">CAKeyframeAnimation</span> animationWithKeyPath:<span class="string">@"borderColor"</span>];</span><br><span class="line"><span class="built_in">NSArray</span>* colorValues = [<span class="built_in">NSArray</span> arrayWithObjects:(<span class="keyword">id</span>)[<span class="built_in">UIColor</span> greenColor].CGColor,</span><br><span class="line">            (<span class="keyword">id</span>)[<span class="built_in">UIColor</span> redColor].CGColor, (<span class="keyword">id</span>)[<span class="built_in">UIColor</span> blueColor].CGColor,  <span class="literal">nil</span>];</span><br><span class="line">colorAnim.values = colorValues;</span><br><span class="line">colorAnim.calculationMode = k<span class="built_in">CAAnimationPaced</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Animation group</span></span><br><span class="line"><span class="built_in">CAAnimationGroup</span>* group = [<span class="built_in">CAAnimationGroup</span> animation];</span><br><span class="line">group.animations = [<span class="built_in">NSArray</span> arrayWithObjects:colorAnim, widthAnim, <span class="literal">nil</span>];</span><br><span class="line">group.duration = <span class="number">5.0</span>;</span><br><span class="line"> </span><br><span class="line">[myLayer addAnimation:group forKey:<span class="string">@"BorderChanges"</span>];</span><br></pre></td></tr></table></figure>
<h2 id="检测动画的结束"><a href="#检测动画的结束" class="headerlink" title="检测动画的结束"></a>检测动画的结束</h2><p>There are two different ways to be notified about the state of an animation:</p>
<ul>
<li>Add a completion block to the current transaction using the <a href="https://developer.apple.com/library/ios/documentation/GraphicsImaging/Reference/CATransaction_class/index.html#//apple_ref/occ/clm/CATransaction/setCompletionBlock:" target="_blank" rel="external">setCompletionBlock:</a> method. When all of the animations in the transaction finish, the transaction executes your completion block.</li>
<li>Assign a delegate to your CAAnimation object and implement the <a href="https://developer.apple.com/library/ios/documentation/GraphicsImaging/Reference/CAAnimation_class/index.html#//apple_ref/occ/instm/NSObject/animationDidStart:" target="_blank" rel="external">animationDidStart:</a> and <a href="https://developer.apple.com/library/ios/documentation/GraphicsImaging/Reference/CAAnimation_class/index.html#//apple_ref/occ/instm/NSObject/animationDidStop:finished:" target="_blank" rel="external">animationDidStop:finished:</a> delegate methods.</li>
</ul>
<h2 id="基于-layer-的view-怎么做动画"><a href="#基于-layer-的view-怎么做动画" class="headerlink" title="基于 layer 的view 怎么做动画"></a>基于 layer 的view 怎么做动画</h2><h3 id="iOS-中修改-layer-的规则"><a href="#iOS-中修改-layer-的规则" class="headerlink" title="iOS 中修改 layer 的规则"></a>iOS 中修改 layer 的规则</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">UIView</span> animateWithDuration:<span class="number">1.0</span> animations:^&#123;</span><br><span class="line">   <span class="comment">// Change the opacity implicitly.</span></span><br><span class="line">   myView.layer.opacity = <span class="number">0.0</span>;</span><br><span class="line"> </span><br><span class="line">   <span class="comment">// Change the position explicitly.</span></span><br><span class="line">   <span class="built_in">CABasicAnimation</span>* theAnim = [<span class="built_in">CABasicAnimation</span> animationWithKeyPath:<span class="string">@"position"</span>];</span><br><span class="line">   theAnim.fromValue = [<span class="built_in">NSValue</span> valueWith<span class="built_in">CGPoint</span>:myView.layer.position];</span><br><span class="line">   theAnim.toValue = [<span class="built_in">NSValue</span> valueWith<span class="built_in">CGPoint</span>:myNewPosition];</span><br><span class="line">   theAnim.duration = <span class="number">3.0</span>;</span><br><span class="line">   [myView.layer addAnimation:theAnim forKey:<span class="string">@"AnimateFrame"</span>];</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<h1 id="建立-layer-层级"><a href="#建立-layer-层级" class="headerlink" title="建立 layer 层级"></a>建立 layer 层级</h1><h2 id="将-layer-放入-layer层级中"><a href="#将-layer-放入-layer层级中" class="headerlink" title="将 layer 放入 layer层级中"></a>将 layer 放入 layer层级中</h2><h3 id="添加、插入、移除-sublayer"><a href="#添加、插入、移除-sublayer" class="headerlink" title="添加、插入、移除 sublayer"></a>添加、插入、移除 sublayer</h3><center><br><img src="http://ww1.sinaimg.cn/large/a9c4d5f6gw1f7jtndq23oj221u0po468.jpg" alt=""><br></center>

<h3 id="sublayer-的位置和大小"><a href="#sublayer-的位置和大小" class="headerlink" title="sublayer 的位置和大小"></a>sublayer 的位置和大小</h3><p><a href="https://developer.apple.com/library/ios/documentation/GraphicsImaging/Reference/CALayer_class/index.html#//apple_ref/occ/instp/CALayer/bounds" target="_blank" rel="external">bounds</a> 、<a href="https://developer.apple.com/library/ios/documentation/GraphicsImaging/Reference/CALayer_class/index.html#//apple_ref/occ/instp/CALayer/position" target="_blank" rel="external">position</a></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">myLayer.bounds = <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">100</span>, <span class="number">100</span>);</span><br><span class="line">myLayer.position = <span class="built_in">CGPointMake</span>(<span class="number">200</span>, <span class="number">200</span>);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>重点：对于 layer 的宽高总是使用整数</p>
</blockquote>
<h3 id="layer-层级如何影响动画"><a href="#layer-层级如何影响动画" class="headerlink" title="layer 层级如何影响动画"></a>layer 层级如何影响动画</h3><p><a href="https://developer.apple.com/library/ios/documentation/GraphicsImaging/Reference/CAMediaTiming_protocol/index.html#//apple_ref/occ/intfp/CAMediaTiming/speed" target="_blank" rel="external">speed</a> 属性，动画速度的倍数。</p>
<h2 id="调整layer层级的布局"><a href="#调整layer层级的布局" class="headerlink" title="调整layer层级的布局"></a>调整layer层级的布局</h2><p>Core Animation supports several options for adjusting the size and position of sublayers in response to changes to their superlayer. In iOS, the pervasive use of layer-backed views makes the creation of layer hierarchies less important; only manual layout updates are supported. For OS X, several other options are available that make it easier to manage your layer hierarchies</p>
<h2 id="sublayer-和-cliping"><a href="#sublayer-和-cliping" class="headerlink" title="sublayer 和 cliping"></a>sublayer 和 cliping</h2><p><a href="https://developer.apple.com/library/ios/documentation/GraphicsImaging/Reference/CALayer_class/index.html#//apple_ref/occ/instp/CALayer/masksToBounds" target="_blank" rel="external">masksToBounds</a> 属性设置 YES，就可以启用自动裁剪</p>
<center><br><img src="http://ww1.sinaimg.cn/mw690/a9c4d5f6gw1f7ju4oniryj20p60kf409.jpg" alt=""><br></center>

<h2 id="在layer-之间转换坐标值"><a href="#在layer-之间转换坐标值" class="headerlink" title="在layer 之间转换坐标值"></a>在layer 之间转换坐标值</h2><ul>
<li><a href="https://developer.apple.com/library/ios/documentation/GraphicsImaging/Reference/CALayer_class/index.html#//apple_ref/occ/instm/CALayer/convertPoint:fromLayer:" target="_blank" rel="external">convertPoint:fromLayer:</a></li>
<li><a href="https://developer.apple.com/library/ios/documentation/GraphicsImaging/Reference/CALayer_class/index.html#//apple_ref/occ/instm/CALayer/convertPoint:toLayer:" target="_blank" rel="external">convertPoint:toLayer:</a></li>
<li><a href="https://developer.apple.com/library/ios/documentation/GraphicsImaging/Reference/CALayer_class/index.html#//apple_ref/occ/instm/CALayer/convertRect:fromLayer:" target="_blank" rel="external">convertRect:fromLayer:</a></li>
<li><a href="https://developer.apple.com/library/ios/documentation/GraphicsImaging/Reference/CALayer_class/index.html#//apple_ref/occ/instm/CALayer/convertRect:toLayer:" target="_blank" rel="external">convertRect:toLayer:</a></li>
</ul>
<p>还有 <a href="https://developer.apple.com/library/ios/documentation/GraphicsImaging/Reference/CALayer_class/index.html#//apple_ref/occ/instm/CALayer/convertTime:fromLayer:" target="_blank" rel="external">convertTime:fromLayer</a> 和 <a href="https://developer.apple.com/library/ios/documentation/GraphicsImaging/Reference/CALayer_class/index.html#//apple_ref/occ/instm/CALayer/convertTime:toLayer:" target="_blank" rel="external">convertTime:toLayer</a></p>
<h1 id="高级动画技巧"><a href="#高级动画技巧" class="headerlink" title="高级动画技巧"></a>高级动画技巧</h1><h2 id="过渡动画支持更改-layer-可见性"><a href="#过渡动画支持更改-layer-可见性" class="headerlink" title="过渡动画支持更改 layer 可见性"></a>过渡动画支持更改 layer 可见性</h2><p>创建 <a href="https://developer.apple.com/library/ios/documentation/GraphicsImaging/Reference/CATransition_class/index.html#//apple_ref/occ/cl/CATransition" target="_blank" rel="external">CATransition</a> 对象 ，并添加给 layer。</p>
<p>Listing 5-1 shows the code used to create an animated push transition between two views. In the example, both myView1 and myView2 are located at the same position in the same parent view but only myView1 is currently visible. The push transition causes myView1 to slide out to the left and fade until it is hidden while myView2 slides in from the right and becomes visible. Updating the hidden property of both views ensures that the visibility of both views is correct at the end of the animation.</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CATransition</span>* transition = [<span class="built_in">CATransition</span> animation];</span><br><span class="line">transition.startProgress = <span class="number">0</span>;</span><br><span class="line">transition.endProgress = <span class="number">1.0</span>;</span><br><span class="line">transition.type = k<span class="built_in">CATransitionPush</span>;</span><br><span class="line">transition.subtype = k<span class="built_in">CATransitionFromRight</span>;</span><br><span class="line">transition.duration = <span class="number">1.0</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Add the transition animation to both layers</span></span><br><span class="line">[myView1.layer addAnimation:transition forKey:<span class="string">@"transition"</span>];</span><br><span class="line">[myView2.layer addAnimation:transition forKey:<span class="string">@"transition"</span>];</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Finally, change the visibility of the layers.</span></span><br><span class="line">myView1.hidden = <span class="literal">YES</span>;</span><br><span class="line">myView2.hidden = <span class="literal">NO</span>;</span><br></pre></td></tr></table></figure>
<h2 id="自定义动画的时间"><a href="#自定义动画的时间" class="headerlink" title="自定义动画的时间"></a>自定义动画的时间</h2><p><a href="https://developer.apple.com/library/ios/documentation/GraphicsImaging/Reference/CAMediaTiming_protocol/index.html#//apple_ref/occ/intf/CAMediaTiming" target="_blank" rel="external">CAMediaTiming</a> 协议。<code>CAAnimation</code> 和 <code>CALayer</code> 都遵守了这个协议。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;QuartzCore/CABase.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/objc.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/NSObject.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* The CAMediaTiming protocol is implemented by layers and animations, it</span><br><span class="line"> * models a hierarchical timing system, with each object describing the</span><br><span class="line"> * mapping from time values in the object's parent to local time.</span><br><span class="line"> *</span><br><span class="line"> * Absolute time is defined as mach time converted to seconds. The</span><br><span class="line"> * CACurrentMediaTime function is provided as a convenience for querying the</span><br><span class="line"> * current absolute time.</span><br><span class="line"> *</span><br><span class="line"> * The conversion from parent time to local time has two stages:</span><br><span class="line"> *</span><br><span class="line"> * 1. conversion to "active local time". This includes the point at</span><br><span class="line"> * which the object appears in the parent's timeline, and how fast it</span><br><span class="line"> * plays relative to the parent.</span><br><span class="line"> *</span><br><span class="line"> * 2. conversion from active to "basic local time". The timing model</span><br><span class="line"> * allows for objects to repeat their basic duration multiple times,</span><br><span class="line"> * and optionally to play backwards before repeating. */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@class</span> <span class="title">NSString</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NS_ASSUME_NONNULL_BEGIN</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">CAMediaTiming</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* The begin time of the object, in relation to its parent object, if</span><br><span class="line"> * applicable. Defaults to 0. */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> <span class="built_in">CFTimeInterval</span> beginTime;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* The basic duration of the object. Defaults to 0. */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> <span class="built_in">CFTimeInterval</span> duration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* The rate of the layer. Used to scale parent time to local time, e.g.</span><br><span class="line"> * if rate is 2, local time progresses twice as fast as parent time.</span><br><span class="line"> * Defaults to 1. */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> <span class="keyword">float</span> speed;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Additional offset in active local time. i.e. to convert from parent</span><br><span class="line"> * time tp to active local time t: t = (tp - begin) * speed + offset.</span><br><span class="line"> * One use of this is to "pause" a layer by setting `speed' to zero and</span><br><span class="line"> * `offset' to a suitable value. Defaults to 0. */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> <span class="built_in">CFTimeInterval</span> timeOffset;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* The repeat count of the object. May be fractional. Defaults to 0. */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> <span class="keyword">float</span> repeatCount;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* The repeat duration of the object. Defaults to 0. */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> <span class="built_in">CFTimeInterval</span> repeatDuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* When true, the object plays backwards after playing forwards. Defaults</span><br><span class="line"> * to NO. */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> <span class="built_in">BOOL</span> autoreverses;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Defines how the timed object behaves outside its active duration.</span><br><span class="line"> * Local time may be clamped to either end of the active duration, or</span><br><span class="line"> * the element may be removed from the presentation. The legal values</span><br><span class="line"> * are `backwards', `forwards', `both' and `removed'. Defaults to</span><br><span class="line"> * `removed'. */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">copy</span>) <span class="built_in">NSString</span> *fillMode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* `fillMode' options. */</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">CA_EXTERN</span> <span class="built_in">NSString</span> * <span class="keyword">const</span> k<span class="built_in">CAFillModeForwards</span></span><br><span class="line">    __OSX_<span class="built_in">AVAILABLE_STARTING</span> (__MAC_10_5, __IPHONE_2_0);</span><br><span class="line"><span class="built_in">CA_EXTERN</span> <span class="built_in">NSString</span> * <span class="keyword">const</span> k<span class="built_in">CAFillModeBackwards</span></span><br><span class="line">    __OSX_<span class="built_in">AVAILABLE_STARTING</span> (__MAC_10_5, __IPHONE_2_0);</span><br><span class="line"><span class="built_in">CA_EXTERN</span> <span class="built_in">NSString</span> * <span class="keyword">const</span> k<span class="built_in">CAFillModeBoth</span></span><br><span class="line">    __OSX_<span class="built_in">AVAILABLE_STARTING</span> (__MAC_10_5, __IPHONE_2_0);</span><br><span class="line"><span class="built_in">CA_EXTERN</span> <span class="built_in">NSString</span> * <span class="keyword">const</span> k<span class="built_in">CAFillModeRemoved</span></span><br><span class="line">    __OSX_<span class="built_in">AVAILABLE_STARTING</span> (__MAC_10_5, __IPHONE_2_0);</span><br><span class="line"></span><br><span class="line"><span class="built_in">NS_ASSUME_NONNULL_END</span></span><br></pre></td></tr></table></figure>
<p>得到 layer 的当前 local time</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CFTimeInterval</span> localLayerTime = [myLayer convertTime:<span class="built_in">CACurrentMediaTime</span>() fromLayer:<span class="literal">nil</span>];</span><br></pre></td></tr></table></figure>
<h2 id="暂停和重新开始动画"><a href="#暂停和重新开始动画" class="headerlink" title="暂停和重新开始动画"></a>暂停和重新开始动画</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">-(<span class="keyword">void</span>)pauseLayer:(<span class="built_in">CALayer</span>*)layer &#123;</span><br><span class="line">   <span class="built_in">CFTimeInterval</span> pausedTime = [layer convertTime:<span class="built_in">CACurrentMediaTime</span>() fromLayer:<span class="literal">nil</span>];</span><br><span class="line">   layer.speed = <span class="number">0.0</span>;</span><br><span class="line">   layer.timeOffset = pausedTime;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">-(<span class="keyword">void</span>)resumeLayer:(<span class="built_in">CALayer</span>*)layer &#123;</span><br><span class="line">   <span class="built_in">CFTimeInterval</span> pausedTime = [layer timeOffset];</span><br><span class="line">   layer.speed = <span class="number">1.0</span>;</span><br><span class="line">   layer.timeOffset = <span class="number">0.0</span>;</span><br><span class="line">   layer.beginTime = <span class="number">0.0</span>;</span><br><span class="line">   <span class="built_in">CFTimeInterval</span> timeSincePause = [layer convertTime:<span class="built_in">CACurrentMediaTime</span>() fromLayer:<span class="literal">nil</span>] - pausedTime;</span><br><span class="line">   layer.beginTime = timeSincePause;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="显式-Transactions-可以更改动画参数"><a href="#显式-Transactions-可以更改动画参数" class="headerlink" title="显式 Transactions 可以更改动画参数"></a>显式 Transactions 可以更改动画参数</h2><p><a href="https://developer.apple.com/library/ios/documentation/GraphicsImaging/Reference/CATransaction_class/index.html#//apple_ref/occ/cl/CATransaction" target="_blank" rel="external">CATransaction</a> 类</p>
<p>创建显式的 transaction</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">CATransaction</span> begin];</span><br><span class="line">theLayer.zPosition=<span class="number">200.0</span>;</span><br><span class="line">theLayer.opacity=<span class="number">0.0</span>;</span><br><span class="line">[<span class="built_in">CATransaction</span> commit];</span><br></pre></td></tr></table></figure>
<p>修改动画的默认持续时间</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">CATransaction</span> begin];</span><br><span class="line">[<span class="built_in">CATransaction</span> setValue:[<span class="built_in">NSNumber</span> numberWithFloat:<span class="number">10.0</span>f]</span><br><span class="line">                 forKey:k<span class="built_in">CATransactionAnimationDuration</span>];</span><br><span class="line"><span class="comment">// Perform the animations</span></span><br><span class="line">[<span class="built_in">CATransaction</span> commit];</span><br></pre></td></tr></table></figure>
<p>嵌套显式 transaction</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">CATransaction</span> begin]; <span class="comment">// Outer transaction</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// Change the animation duration to two seconds</span></span><br><span class="line">[<span class="built_in">CATransaction</span> setValue:[<span class="built_in">NSNumber</span> numberWithFloat:<span class="number">2.0</span>f]</span><br><span class="line">                forKey:k<span class="built_in">CATransactionAnimationDuration</span>];</span><br><span class="line"><span class="comment">// Move the layer to a new position</span></span><br><span class="line">theLayer.position = <span class="built_in">CGPointMake</span>(<span class="number">0.0</span>,<span class="number">0.0</span>);</span><br><span class="line"> </span><br><span class="line">[<span class="built_in">CATransaction</span> begin]; <span class="comment">// Inner transaction</span></span><br><span class="line"><span class="comment">// Change the animation duration to five seconds</span></span><br><span class="line">[<span class="built_in">CATransaction</span> setValue:[<span class="built_in">NSNumber</span> numberWithFloat:<span class="number">5.0</span>f]</span><br><span class="line">                 forKey:k<span class="built_in">CATransactionAnimationDuration</span>];</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Change the zPosition and opacity</span></span><br><span class="line">theLayer.zPosition=<span class="number">200.0</span>;</span><br><span class="line">theLayer.opacity=<span class="number">0.0</span>;</span><br><span class="line"> </span><br><span class="line">[<span class="built_in">CATransaction</span> commit]; <span class="comment">// Inner transaction</span></span><br><span class="line"> </span><br><span class="line">[<span class="built_in">CATransaction</span> commit]; <span class="comment">// Outer transaction</span></span><br></pre></td></tr></table></figure>
<h2 id="给动画添加透视"><a href="#给动画添加透视" class="headerlink" title="给动画添加透视"></a>给动画添加透视</h2><p>给 parent layer 添加透视变化</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CATransform3D</span> perspective = <span class="built_in">CATransform3DIdentity</span>;</span><br><span class="line">perspective.m34 = <span class="number">-1.0</span>/eyePosition;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Apply the transform to a parent layer.</span></span><br><span class="line">myParentLayer.sublayerTransform = perspective;</span><br></pre></td></tr></table></figure>
<h1 id="改变-layer-的默认行为"><a href="#改变-layer-的默认行为" class="headerlink" title="改变 layer 的默认行为"></a>改变 layer 的默认行为</h1><p><a href="https://developer.apple.com/library/ios/documentation/GraphicsImaging/Reference/CAAction_protocol/index.html#//apple_ref/occ/intf/CAAction" target="_blank" rel="external">CAAction</a> 协议</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Action (event handler) protocol. **/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">CAAction</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Called to trigger the event named 'path' on the receiver. The object</span><br><span class="line"> * (e.g. the layer) on which the event happened is 'anObject'. The</span><br><span class="line"> * arguments dictionary may be nil, if non-nil it carries parameters</span><br><span class="line"> * associated with the event. */</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)runActionForKey:(<span class="built_in">NSString</span> *)event object:(<span class="keyword">id</span>)anObject</span><br><span class="line">    arguments:(nullable <span class="built_in">NSDictionary</span> *)dict;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h2 id="自定义操作对象采用CAAction协议"><a href="#自定义操作对象采用CAAction协议" class="headerlink" title="自定义操作对象采用CAAction协议"></a>自定义操作对象采用CAAction协议</h2><h2 id="action-对象必须被安装在-layer-上，才能有效果"><a href="#action-对象必须被安装在-layer-上，才能有效果" class="headerlink" title="action 对象必须被安装在 layer 上，才能有效果"></a>action 对象必须被安装在 layer 上，才能有效果</h2><p>核心动画寻找 action 对象的顺序：</p>
<ol>
<li>如果 layer 有一个 delegate， 并且delegate 实现了 <code>actionForLayer:forKey</code> 方法，layer调用这个方法。delegate 必须做下面几件事之一：<ul>
<li>针对 key 返回 action 对象</li>
<li>没有它没有 handle the action 就返回 nil，这种情况会接着寻找</li>
<li>搜寻到末尾的时候立即返回 <a href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/Classes/NSNull_Class/index.html#//apple_ref/occ/cl/NSNull" target="_blank" rel="external">NSNull</a> 对象</li>
</ul>
</li>
<li>在 layer 的 <a href="https://developer.apple.com/library/ios/documentation/GraphicsImaging/Reference/CALayer_class/index.html#//apple_ref/occ/instp/CALayer/actions" target="_blank" rel="external">actions</a> 字典中寻找给定的 key</li>
<li>在 <a href="https://developer.apple.com/library/ios/documentation/GraphicsImaging/Reference/CALayer_class/index.html#//apple_ref/occ/instp/CALayer/style" target="_blank" rel="external">style</a> 字典中寻找包含 key 的 actions 字典（总而言之，<code>style</code> 字典包含了一个 key 为 <code>actions</code> ，value 也是一个字典。layer 在这第二个字典中寻找给定的 key）</li>
<li>layer 调用它的 <a href="https://developer.apple.com/library/ios/documentation/GraphicsImaging/Reference/CALayer_class/index.html#//apple_ref/occ/clm/CALayer/defaultActionForKey:" target="_blank" rel="external">defaultActionForKey:</a> 类方法</li>
<li>layer 执行核心动画定义的隐式 action </li>
</ol>
<p>使用 layer 代理对象提供 action</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">id</span>&lt;<span class="built_in">CAAction</span>&gt;)actionForLayer:(<span class="built_in">CALayer</span> *)theLayer</span><br><span class="line">                        forKey:(<span class="built_in">NSString</span> *)theKey &#123;</span><br><span class="line">    <span class="built_in">CATransition</span> *theAnimation=<span class="literal">nil</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> ([theKey isEqualToString:<span class="string">@"contents"</span>]) &#123;</span><br><span class="line"> </span><br><span class="line">        theAnimation = [[<span class="built_in">CATransition</span> alloc] init];</span><br><span class="line">        theAnimation.duration = <span class="number">1.0</span>;</span><br><span class="line">        theAnimation.timingFunction = [<span class="built_in">CAMediaTimingFunction</span> functionWithName:k<span class="built_in">CAMediaTimingFunctionEaseIn</span>];</span><br><span class="line">        theAnimation.type = k<span class="built_in">CATransitionPush</span>;</span><br><span class="line">        theAnimation.subtype = k<span class="built_in">CATransitionFromRight</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> theAnimation;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="使用-CATransaction-类暂时禁用-action"><a href="#使用-CATransaction-类暂时禁用-action" class="headerlink" title="使用 CATransaction 类暂时禁用 action"></a>使用 CATransaction 类暂时禁用 action</h2><p>Temporarily disabling a layer’s actions</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">CATransaction</span> begin];</span><br><span class="line">[<span class="built_in">CATransaction</span> setValue:(<span class="keyword">id</span>)k<span class="built_in">CFBooleanTrue</span></span><br><span class="line">                 forKey:k<span class="built_in">CATransactionDisableActions</span>];</span><br><span class="line">[aLayer removeFromSuperlayer];</span><br><span class="line">[<span class="built_in">CATransaction</span> commit];</span><br></pre></td></tr></table></figure>
<h1 id="提升动画性能"><a href="#提升动画性能" class="headerlink" title="提升动画性能"></a>提升动画性能</h1><h2 id="为-OS-X-Views-选择最佳的重绘策略"><a href="#为-OS-X-Views-选择最佳的重绘策略" class="headerlink" title="为 OS X Views 选择最佳的重绘策略"></a>为 OS X Views 选择最佳的重绘策略</h2><h2 id="在-OS-X-中更新-layer-来优化-rendering-path"><a href="#在-OS-X-中更新-layer-来优化-rendering-path" class="headerlink" title="在 OS X 中更新 layer 来优化 rendering path"></a>在 OS X 中更新 layer 来优化 rendering path</h2><h2 id="通用技巧和窍门"><a href="#通用技巧和窍门" class="headerlink" title="通用技巧和窍门"></a>通用技巧和窍门</h2><h3 id="尽可能使用不透明的-layer"><a href="#尽可能使用不透明的-layer" class="headerlink" title="尽可能使用不透明的 layer"></a>尽可能使用不透明的 layer</h3><h3 id="对-CAShapeLayer-对象使用更简单的-path"><a href="#对-CAShapeLayer-对象使用更简单的-path" class="headerlink" title="对 CAShapeLayer 对象使用更简单的 path"></a>对 CAShapeLayer 对象使用更简单的 path</h3><h3 id="对相同-layer-明确设置-layer-内容"><a href="#对相同-layer-明确设置-layer-内容" class="headerlink" title="对相同 layer 明确设置 layer 内容"></a>对相同 layer 明确设置 layer 内容</h3><h3 id="总是将-layer-的大小设置为-整数值"><a href="#总是将-layer-的大小设置为-整数值" class="headerlink" title="总是将 layer 的大小设置为 整数值"></a>总是将 layer 的大小设置为 整数值</h3><h3 id="根据需要使用异步来渲染-layer"><a href="#根据需要使用异步来渲染-layer" class="headerlink" title="根据需要使用异步来渲染 layer"></a>根据需要使用异步来渲染 layer</h3><p><a href="https://developer.apple.com/library/ios/documentation/GraphicsImaging/Reference/CALayer_class/index.html#//apple_ref/occ/instp/CALayer/drawsAsynchronously" target="_blank" rel="external">drawsAsynchronously</a> 属性</p>
<h2 id="当给-layer-添加阴影的时候指定-shadow-path"><a href="#当给-layer-添加阴影的时候指定-shadow-path" class="headerlink" title="当给 layer 添加阴影的时候指定 shadow path"></a>当给 layer 添加阴影的时候指定 shadow path</h2><h1 id="Appendix-A-layer-style-property-animation"><a href="#Appendix-A-layer-style-property-animation" class="headerlink" title="Appendix A: layer style property animation"></a>Appendix A: layer style property animation</h1><p><a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/CoreAnimation_guide/LayerStyleProperties/LayerStyleProperties.html#//apple_ref/doc/uid/TP40004514-CH10-SW1" target="_blank" rel="external">Layer Style Property Animations</a></p>
<h1 id="Appendix-B-Animatable-Properties"><a href="#Appendix-B-Animatable-Properties" class="headerlink" title="Appendix B: Animatable Properties"></a>Appendix B: Animatable Properties</h1><p><a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/CoreAnimation_guide/AnimatableProperties/AnimatableProperties.html#//apple_ref/doc/uid/TP40004514-CH11-SW1" target="_blank" rel="external">Animatable Properties</a></p>
<blockquote>
<p>新博客文章地址：<a href="http://yoferzhang.com/post/20160905CoreAnimationProgrammingGuide/">Core Animation Programming Guide 核心动画编程指南</a><br>CSDN文章地址：<a href="">Core Animation Programming Guide 核心动画编程指南</a></p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoferzhang.com/post/20160902ViewProgrammingGuide/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Yofer Zhang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="http://ww2.sinaimg.cn/mw690/a9c4d5f6jw1e3siexaeopj.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="YoferZhang 的博客">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="YoferZhang 的博客" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/20160902ViewProgrammingGuide/" itemprop="url">
                  【iOS】View Programming Guide for iOS 视图编程指南
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-02T15:25:29+08:00">
                2016-09-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/post/20160902ViewProgrammingGuide/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="post/20160902ViewProgrammingGuide/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>版权声明：本文为博主原创，如需转载请注明出处。</p>
</blockquote>
<h1 id="1-有关-Windows-and-Views"><a href="#1-有关-Windows-and-Views" class="headerlink" title="1 有关 Windows and Views"></a>1 有关 Windows and Views</h1><p>每个应用都至少有一个 window 和一个 view。</p>
<h2 id="1-1-添加额外的-Window"><a href="#1-1-添加额外的-Window" class="headerlink" title="1.1 添加额外的 Window"></a>1.1 添加额外的 Window</h2><p>一般在有外界显示设备的时候才需要添加额外的 window</p>
<p>下面的代码举了一个例子，这里假定对象实现了方法 externalWindow，externalWindow 存储一个 window 的引用</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)configureExternalDisplayAndShowWithContent:(<span class="built_in">UIViewController</span>*)rootVC</span><br><span class="line">&#123;</span><br><span class="line">   <span class="comment">// Configure the content only if a second screen is available.</span></span><br><span class="line">   <span class="keyword">if</span> ([[<span class="built_in">UIScreen</span> screens] count] &gt; <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="built_in">UIScreen</span>* externalScreen = [[<span class="built_in">UIScreen</span> screens] objectAtIndex:<span class="number">1</span>];</span><br><span class="line">      <span class="built_in">CGRect</span> screenBounds = externalScreen.bounds;</span><br><span class="line"> </span><br><span class="line">      <span class="comment">// Configure the window</span></span><br><span class="line">      <span class="keyword">self</span>.externalWindow = [[<span class="built_in">UIWindow</span> alloc] initWithFrame:screenBounds];</span><br><span class="line">      <span class="keyword">self</span>.externalWindow.windowLevel = <span class="built_in">UIWindowLevelNormal</span>;</span><br><span class="line">      <span class="keyword">self</span>.externalWindow.screen = externalScreen;</span><br><span class="line"> </span><br><span class="line">      <span class="comment">// Install the root view controller</span></span><br><span class="line">      <span class="keyword">self</span>.externalWindow.rootViewController = rootVC;</span><br><span class="line"> </span><br><span class="line">      <span class="comment">// Show the window, but do not make it key.</span></span><br><span class="line">      <span class="keyword">self</span>.externalWindow.hidden = <span class="literal">NO</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// No external display available for configuration.</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="2-View-和-Window-层级"><a href="#2-View-和-Window-层级" class="headerlink" title="2 View 和 Window 层级"></a>2 View 和 Window 层级</h1><h2 id="2-1-View-层级原理"><a href="#2-1-View-层级原理" class="headerlink" title="2.1 View 层级原理"></a>2.1 View 层级原理</h2><p>UIKit中的每个 view，底层都拥有一个 layer 对象，通常都是CALayer。大多数情况下都直接通过 UIView 操作；当需要更多控制的时候可以通过 layer 执行操作。</p>
<p>注意：bar button item 不是 view，所以不能直接访问它的 layer。实际上 bar button item 是直接继承自 NSObject，而 layer 是 UIView 中定义的，所以bar button item没有。</p>
<center><br><img src="http://ww2.sinaimg.cn/mw690/a9c4d5f6gw1f7fc1paxz3j20i40armz9.jpg" alt=""><br></center>

<p>核心动画层会对 view对象绘制代码的内容进行缓存重用，尤其是在有动画的情况下，重用比重新创建一个新的内容资源消耗小很多。</p>
<h3 id="2-1-1-视图层级和子视图管理"><a href="#2-1-1-视图层级和子视图管理" class="headerlink" title="2.1.1 视图层级和子视图管理"></a>2.1.1 视图层级和子视图管理</h3><p>如果子视图是完全不透明的话，会遮盖父视图的内容。父视图将子视图存放在一个有序的数组中，所以后添加的（子视图数组最后的）会在最上面显示。</p>
<p>父视图改变大小会引起子视图的大小随之变化，可以自定义这种变化。还有父视图被隐藏、改变父视图的透明度（alpha），或者对父视图的坐标系统应用数学转换等，都会影响到子视图。</p>
<p>UIResponder 和它的子类可以响应事件，并处理事件，UIView就是继承自 UIResponder。</p>
<center><br><img src="http://ww4.sinaimg.cn/mw690/a9c4d5f6gw1f7fcs0ioclj20hw07vmxu.jpg" alt=""><br></center>

<p>点击事件的响应是从上到下一层一层判断的，如果最后没有任何对象做出响应，通常就丢弃了。</p>
<h3 id="2-1-2-视图绘图周期"><a href="#2-1-2-视图绘图周期" class="headerlink" title="2.1.2 视图绘图周期"></a>2.1.2 视图绘图周期</h3><p>第一次绘图的时候系统保存一个绘图内容的快拍（snapshot），如果之后再没有对内容改动，那么不会再调用绘图代码，都直接使用这个快拍；如果有了改动，就重新生成一个快拍，周而复始。</p>
<p>当视图的内容或者外观发生变化的时候可以使用 <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instm/UIView/setNeedsDisplay" target="_blank" rel="external">setNeedsDisplay</a> 和 <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instm/UIView/setNeedsDisplayInRect:" target="_blank" rel="external">setNeedsDisplayInRect</a> 方法进行重绘；注意如果改变了视图的几何形状，这个方法就失效了。这两个方法是等待当前 run loop 执行到最后的时候，再将刚才设置的所有重绘操作一次执行完成。</p>
<blockquote>
<p>有关几何形状的变化，需要看下面的 Content Modes</p>
</blockquote>
<p>UIView 的子类，通常重写 <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instm/UIView/drawRect:" target="_blank" rel="external">drawRect:</a> 方法，在这个方法里面写绘图代码。这个方法不需要自己调用。</p>
<h3 id="2-1-3-Content-Modes-内容模式"><a href="#2-1-3-Content-Modes-内容模式" class="headerlink" title="2.1.3 Content Modes 内容模式"></a>2.1.3 Content Modes 内容模式</h3><p>当发生下列两种情况时，内容模式就会应用：</p>
<ul>
<li>改变视图的 <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instp/UIView/frame" target="_blank" rel="external">frame</a> 或者 <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instp/UIView/bounds" target="_blank" rel="external">bounds</a> 矩形的宽或高。</li>
<li>指定一个转换，比如视图的 <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instp/UIView/transform" target="_blank" rel="external">transform</a> 属性的缩放比例</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>)                 <span class="built_in">UIViewContentMode</span> contentMode;                <span class="comment">// default is UIViewContentModeScaleToFill</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_ENUM</span>(<span class="built_in">NSInteger</span>, <span class="built_in">UIViewContentMode</span>) &#123;</span><br><span class="line">    <span class="built_in">UIViewContentModeScaleToFill</span>,</span><br><span class="line">    <span class="built_in">UIViewContentModeScaleAspectFit</span>,      <span class="comment">// contents scaled to fit with fixed aspect. remainder is transparent</span></span><br><span class="line">    <span class="built_in">UIViewContentModeScaleAspectFill</span>,     <span class="comment">// contents scaled to fill with fixed aspect. some portion of content may be clipped.</span></span><br><span class="line">    <span class="built_in">UIViewContentModeRedraw</span>,              <span class="comment">// redraw on bounds change (calls -setNeedsDisplay)</span></span><br><span class="line">    <span class="built_in">UIViewContentModeCenter</span>,              <span class="comment">// contents remain same size. positioned adjusted.</span></span><br><span class="line">    <span class="built_in">UIViewContentModeTop</span>,</span><br><span class="line">    <span class="built_in">UIViewContentModeBottom</span>,</span><br><span class="line">    <span class="built_in">UIViewContentModeLeft</span>,</span><br><span class="line">    <span class="built_in">UIViewContentModeRight</span>,</span><br><span class="line">    <span class="built_in">UIViewContentModeTopLeft</span>,</span><br><span class="line">    <span class="built_in">UIViewContentModeTopRight</span>,</span><br><span class="line">    <span class="built_in">UIViewContentModeBottomLeft</span>,</span><br><span class="line">    <span class="built_in">UIViewContentModeBottomRight</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<center><br><img src="http://ww4.sinaimg.cn/mw690/a9c4d5f6gw1f7g5ydwc9uj20c90jpwil.jpg" alt=""><br></center>

<p>UIViewContentModeRedraw 通常都不需要使用这个值，尤其在标准系统视图中不要使用。</p>
<h3 id="2-1-4-可伸缩的视图"><a href="#2-1-4-可伸缩的视图" class="headerlink" title="2.1.4 可伸缩的视图"></a>2.1.4 可伸缩的视图</h3><p>可以指定一个区域为可伸缩的，可以沿着一个轴或者两个轴伸缩。下图显示了视图自身显示的失真</p>
<center><br><img src="http://ww4.sinaimg.cn/mw690/a9c4d5f6gw1f7g67e6e1rj20az0cajtq.jpg" alt=""><br></center>

<p><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instp/UIView/contentStretch" target="_blank" rel="external">contentStretch</a> 属性用来指定可伸缩的区域。但是这个属性iOS6之后被废弃了，通常这个属性都是用在 view 的背景 UIImage 对象，所以现在用 [UIImage resizableImageWithCapInsets:] 达到相同效果。</p>
<h3 id="2-1-5-内嵌动画的支持"><a href="#2-1-5-内嵌动画的支持" class="headerlink" title="2.1.5 内嵌动画的支持"></a>2.1.5 内嵌动画的支持</h3><p>执行动画需要做两件事：</p>
<ul>
<li>告诉UIKit 你想要执行动画</li>
<li>改变属性的值</li>
</ul>
<p>下面这些 UIView 对象的属性都可以用作动画：</p>
<ul>
<li><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instp/UIView/frame" target="_blank" rel="external">frame</a> 以动画形式改变视图的位置和大小</li>
<li><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instp/UIView/bounds" target="_blank" rel="external">bounds</a> 以动画形式改变视图的大小</li>
<li><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instp/UIView/center" target="_blank" rel="external">center</a> 以动画形式改变视图的位置 </li>
<li><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instp/UIView/transform" target="_blank" rel="external">transform</a> 旋转或者伸缩视图 </li>
<li><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instp/UIView/alpha" target="_blank" rel="external">alpha</a> 改变视图的透明度</li>
<li><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instp/UIView/backgroundColor" target="_blank" rel="external">backgroundColor</a> 改变视图的背景颜色 </li>
</ul>
<p>比如通常可以用导航栏控制器控制两个视图的转换动画，这是提供的标准动画，当觉得达不到想要效果，就可以自定义。</p>
<p>还可以直接使用 Core Animation layers创建动画。</p>
<h2 id="2-2-视图的几何（Geometry）和坐标（Coordinate）系统"><a href="#2-2-视图的几何（Geometry）和坐标（Coordinate）系统" class="headerlink" title="2.2 视图的几何（Geometry）和坐标（Coordinate）系统"></a>2.2 视图的几何（Geometry）和坐标（Coordinate）系统</h2><center><br><img src="http://ww1.sinaimg.cn/mw690/a9c4d5f6gw1f7g6qvtlhxj206808nq3d.jpg" alt=""><br></center>

<p>每个视图和窗口都定义了自己的局部坐标系统。</p>
<h3 id="2-2-1-Frame，Bounds-和-Center-属性的关系"><a href="#2-2-1-Frame，Bounds-和-Center-属性的关系" class="headerlink" title="2.2.1 Frame，Bounds 和 Center 属性的关系"></a>2.2.1 Frame，Bounds 和 Center 属性的关系</h3><ul>
<li><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instp/UIView/frame" target="_blank" rel="external">frame</a> 属性包含矩形框架，指定视图的大小和在父视图坐标系中的位置</li>
<li><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instp/UIView/bounds" target="_blank" rel="external">bounds</a> 属性包含了矩形边界，指定了在视图自己局部的坐标系中视图的大小（以及内容的边界）</li>
<li><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instp/UIView/center" target="_blank" rel="external">center</a> 属性包含了父视图坐标系中视图的中点</li>
</ul>
<center><br><img src="http://ww3.sinaimg.cn/mw690/a9c4d5f6gw1f7hj771kufj20f008ldhz.jpg" alt=""><br></center>

<p>下面3种情况，改变会有连锁反应：</p>
<ul>
<li>改变frame 属性，bounds、center 属性也会随着改变</li>
<li>改变center 属性，frame 的原点会改变</li>
<li>bounds 属性的大小改变，frame 属性也会改变</li>
</ul>
<h3 id="2-2-2-坐标系变换"><a href="#2-2-2-坐标系变换" class="headerlink" title="2.2.2 坐标系变换"></a>2.2.2 坐标系变换</h3><p>利用仿射变换可以改变整个视图的大小、位置或者方向。</p>
<p><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instp/UIView/transform" target="_blank" rel="external">transform</a> 属性可以修改变换方式，并且有动画。</p>
<h3 id="2-2-3-点像素"><a href="#2-2-3-点像素" class="headerlink" title="2.2.3 点像素"></a>2.2.3 点像素</h3><p>One point does not necessarily correspond to one pixel on the screen.</p>
<p>一个 point 并不一定和 一个像素相等，千万不要有相等的假设。</p>
<h3 id="2-2-4-视图的运行交互模式"><a href="#2-2-4-视图的运行交互模式" class="headerlink" title="2.2.4 视图的运行交互模式"></a>2.2.4 视图的运行交互模式</h3><center><br><img src="http://ww2.sinaimg.cn/mw690/a9c4d5f6gw1f7hku953fkj20fy08amyj.jpg" alt=""><br></center>

<p>考虑下面几种情况：</p>
<p>1.用户触摸屏幕</p>
<p>2.硬件给UIKit框架报告触摸事件</p>
<p>3.UIKit 框架把触摸事件包装为一个 <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIEvent_Class/index.html#//apple_ref/occ/cl/UIEvent" target="_blank" rel="external">UIEvent</a> 对象，并且分配给适当的视图。</p>
<p>4.视图的 event-handling 代码响应事件。比如，你的代码可以：</p>
<ul>
<li>改变视图或者子视图属性（frame，bounds，alpha 等等）</li>
<li>调用 <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instm/UIView/setNeedsLayout" target="_blank" rel="external">setNeedsLayout</a> 方法来标记需要布局更新的视图或者子视图。</li>
<li>调用 <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instm/UIView/setNeedsDisplay" target="_blank" rel="external">setNeedsDisplay</a> 或者 <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instm/UIView/setNeedsDisplayInRect:" target="_blank" rel="external">setNeedsDisplayInRect:</a> 方法来标记需要重绘的视图或它的子视图。</li>
<li>通知 controller 有关一些数据块的修改</li>
</ul>
<p>上面这都是由你来决定做哪些事情。</p>
<p>如果使用了手势识别来处理事件，就不要重写任何手势识别的方法；同样，如果视图不包含任何子视图或者它的大小没有改变，不要重写 layoutSubviews 方法；当你的视图内容在运行时候需要改变，或者你正在使用比如Uikit或者Core Graphics的原生技术来进行绘图时，才需要重写 drawRect:</p>
<h2 id="2-3-有效使用视图的要点"><a href="#2-3-有效使用视图的要点" class="headerlink" title="2.3 有效使用视图的要点"></a>2.3 有效使用视图的要点</h2><p>自定义视图需要考虑性能问题；优化绘图代码之前，先测量性能，然后定个性能标准再优化。</p>
<h3 id="2-3-1-视图并不需要总是对应一个试图控制器"><a href="#2-3-1-视图并不需要总是对应一个试图控制器" class="headerlink" title="2.3.1 视图并不需要总是对应一个试图控制器"></a>2.3.1 视图并不需要总是对应一个试图控制器</h3><p>视图控制器提供的功能比如：协调视图在屏幕上的显示，协调视图在屏幕上的移动，释放内存，旋转视图等。</p>
<h3 id="2-3-2-尽可能少的进行自定义绘图"><a href="#2-3-2-尽可能少的进行自定义绘图" class="headerlink" title="2.3.2 尽可能少的进行自定义绘图"></a>2.3.2 尽可能少的进行自定义绘图</h3><h3 id="2-3-3-内容模型的优势"><a href="#2-3-3-内容模型的优势" class="headerlink" title="2.3.3 内容模型的优势"></a>2.3.3 内容模型的优势</h3><p>应该避免使用 <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/c/econst/UIViewContentModeRedraw" target="_blank" rel="external">UIViewContentModeRedraw</a>。总是使用 <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instm/UIView/setNeedsDisplay" target="_blank" rel="external">setNeedsDisplay</a> 或者 <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instm/UIView/setNeedsDisplayInRect:" target="_blank" rel="external">setNeedsDisplayInRect:</a></p>
<h3 id="2-3-4-尽可能的将视图声明为不透明的"><a href="#2-3-4-尽可能的将视图声明为不透明的" class="headerlink" title="2.3.4 尽可能的将视图声明为不透明的"></a>2.3.4 尽可能的将视图声明为不透明的</h3><p>对于透明的渲染会增加性能的损耗。</p>
<h3 id="2-3-5-当滚动的时候调整视图的绘制行为"><a href="#2-3-5-当滚动的时候调整视图的绘制行为" class="headerlink" title="2.3.5 当滚动的时候调整视图的绘制行为"></a>2.3.5 当滚动的时候调整视图的绘制行为</h3><p>滚动的时候非常损耗性能，所以可以考虑在滚动的时候暂时降低内容的渲染质量。滚动停止的时候再恢复。</p>
<h3 id="2-3-6-不同通过嵌入子视图来自定义控件"><a href="#2-3-6-不同通过嵌入子视图来自定义控件" class="headerlink" title="2.3.6 不同通过嵌入子视图来自定义控件"></a>2.3.6 不同通过嵌入子视图来自定义控件</h3><p>永远不要给系统控件自行添加视图，这样会导致很多错误发生。</p>
<h1 id="3-Windows-窗口"><a href="#3-Windows-窗口" class="headerlink" title="3 Windows 窗口"></a>3 Windows 窗口</h1><p>这章节涉及内容不常用，用时再看 - <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIWindow_Class/index.html#//apple_ref/c/data/UIWindowDidResignKeyNotification" target="_blank" rel="external">Windows</a></p>
<p>窗口职责：</p>
<ul>
<li>包含应用的可视化内容</li>
<li>在视图触摸事件和其他应用对象之间扮演递送者</li>
<li>通常和视图控制器协作，来适应方向的变化</li>
</ul>
<h2 id="3-1-涉及窗口的任务"><a href="#3-1-涉及窗口的任务" class="headerlink" title="3.1 涉及窗口的任务"></a>3.1 涉及窗口的任务</h2><ul>
<li>Use the window object to convert points and rectangles to or from the window’s local coordinate system.</li>
<li>Use window notifications to track window-related changes. </li>
</ul>
<h2 id="3-2-创建和配置窗口"><a href="#3-2-创建和配置窗口" class="headerlink" title="3.2 创建和配置窗口"></a>3.2 创建和配置窗口</h2><h3 id="3-2-1-用IB创建窗口"><a href="#3-2-1-用IB创建窗口" class="headerlink" title="3.2.1 用IB创建窗口"></a>3.2.1 用IB创建窗口</h3><h3 id="3-2-2-代码创建窗口"><a href="#3-2-2-代码创建窗口" class="headerlink" title="3.2.2 代码创建窗口"></a>3.2.2 代码创建窗口</h3><h3 id="3-2-3-给窗口添加内容"><a href="#3-2-3-给窗口添加内容" class="headerlink" title="3.2.3 给窗口添加内容"></a>3.2.3 给窗口添加内容</h3><h3 id="3-2-4-改变窗口层级"><a href="#3-2-4-改变窗口层级" class="headerlink" title="3.2.4 改变窗口层级"></a>3.2.4 改变窗口层级</h3><h2 id="3-3-监视窗口的改变"><a href="#3-3-监视窗口的改变" class="headerlink" title="3.3 监视窗口的改变"></a>3.3 监视窗口的改变</h2><ul>
<li><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIWindow_Class/index.html#//apple_ref/c/data/UIWindowDidBecomeVisibleNotification" target="_blank" rel="external">UIWindowDidBecomeVisibleNotification</a></li>
<li><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIWindow_Class/index.html#//apple_ref/c/data/UIWindowDidBecomeHiddenNotification" target="_blank" rel="external">UIWindowDidBecomeHiddenNotification</a></li>
<li><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIWindow_Class/index.html#//apple_ref/c/data/UIWindowDidBecomeKeyNotification" target="_blank" rel="external">UIWindowDidBecomeKeyNotification</a></li>
<li><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIWindow_Class/index.html#//apple_ref/c/data/UIWindowDidResignKeyNotification" target="_blank" rel="external">UIWindowDidResignKeyNotification</a></li>
</ul>
<h2 id="3-4-在额外的设备上显示内容"><a href="#3-4-在额外的设备上显示内容" class="headerlink" title="3.4 在额外的设备上显示内容"></a>3.4 在额外的设备上显示内容</h2><h3 id="3-4-1-处理屏幕连接和断开通知"><a href="#3-4-1-处理屏幕连接和断开通知" class="headerlink" title="3.4.1 处理屏幕连接和断开通知"></a>3.4.1 处理屏幕连接和断开通知</h3><h3 id="3-4-2-为额外的设备配置一个窗口"><a href="#3-4-2-为额外的设备配置一个窗口" class="headerlink" title="3.4.2 为额外的设备配置一个窗口"></a>3.4.2 为额外的设备配置一个窗口</h3><h3 id="3-4-3为额外的设备配置屏幕模式"><a href="#3-4-3为额外的设备配置屏幕模式" class="headerlink" title="3.4.3为额外的设备配置屏幕模式"></a>3.4.3为额外的设备配置屏幕模式</h3><h1 id="4-Views-视图"><a href="#4-Views-视图" class="headerlink" title="4 Views 视图"></a>4 Views 视图</h1><p>view 的职责：</p>
<p>布局和子视图管理：</p>
<ul>
<li>view 定义它对于父视图的默认 resize 行为</li>
<li>视图可以管理一系列子视图</li>
<li>视图可以根据需要调整子视图的大小和位置</li>
<li>视图可以将它的坐标系转化为其他视图或者窗口的坐标系</li>
</ul>
<p>绘制和动画：</p>
<ul>
<li>视图在它的矩形区域绘制内容</li>
<li>view 的某些属性可以以动画的形式变换到新值</li>
</ul>
<p>事件处理：</p>
<ul>
<li>视图可以收到触摸事件</li>
<li>视图可以参与到响应链</li>
</ul>
<h2 id="4-1-创建和配置视图对象"><a href="#4-1-创建和配置视图对象" class="headerlink" title="4.1 创建和配置视图对象"></a>4.1 创建和配置视图对象</h2><h3 id="4-1-1-使用IB创建视图对象"><a href="#4-1-1-使用IB创建视图对象" class="headerlink" title="4.1.1 使用IB创建视图对象"></a>4.1.1 使用IB创建视图对象</h3><p>可以查看 <a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/LoadingResources/Introduction/Introduction.html#//apple_ref/doc/uid/10000051i" target="_blank" rel="external">Resource Programming Guide</a></p>
<h3 id="4-1-2-代码创建view对象"><a href="#4-1-2-代码创建view对象" class="headerlink" title="4.1.2 代码创建view对象"></a>4.1.2 代码创建view对象</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CGRect</span>  viewRect = <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">100</span>, <span class="number">100</span>);</span><br><span class="line"><span class="built_in">UIView</span>* myView = [[<span class="built_in">UIView</span> alloc] initWithFrame:viewRect];</span><br></pre></td></tr></table></figure>
<h3 id="4-1-3-设置view-的属性"><a href="#4-1-3-设置view-的属性" class="headerlink" title="4.1.3 设置view 的属性"></a>4.1.3 设置view 的属性</h3><p>view 的一些关键属性的用法</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>用法</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instp/UIView/alpha" target="_blank" rel="external">aplha</a>, <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instp/UIView/hidden" target="_blank" rel="external">hidden</a>, <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instp/UIView/opaque" target="_blank" rel="external">opaque</a></td>
<td>这些属性影响view 的透明度，alpha 和 hidden 属性直接改变 view 透明度；opaque 属性告诉系统是否应该混合视图的显示。设置为YES 可以提升性能。</td>
</tr>
<tr>
<td><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instp/UIView/bounds" target="_blank" rel="external">bounds</a>, <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instp/UIView/frame" target="_blank" rel="external">frame</a>, <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instp/UIView/center" target="_blank" rel="external">center</a>, <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instp/UIView/transform" target="_blank" rel="external">transform</a></td>
<td>center 和 frame 属性都和父视图相关，而bounds属性在自己的坐标系中定义了可视化内容区域。transform 属性常用语动画或者用复杂的方式移动 view。</td>
</tr>
<tr>
<td><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instp/UIView/autoresizingMask" target="_blank" rel="external">autoresizingMask</a>, <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instp/UIView/autoresizesSubviews" target="_blank" rel="external">autoresizesSubviews</a></td>
<td>这些属性影响视图和子视图的自动 resieze 行为。autoresizingMask 属性控制视图在父视图中如何响应变化。autoresizesSubviews 属性控制是否当前视图的子视图要完全被 resize。</td>
</tr>
<tr>
<td><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instp/UIView/contentMode" target="_blank" rel="external">contentMode</a>, <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instp/UIView/contentStretch" target="_blank" rel="external">contentStretch</a>, <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instm/UIView/contentScaleFactor" target="_blank" rel="external">contentScaleFactor</a></td>
<td>这些属性影响 view 里面内容的渲染行为。</td>
</tr>
<tr>
<td><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instp/UIView/gestureRecognizers" target="_blank" rel="external">gestureRecognizers</a>, <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instp/UIView/userInteractionEnabled" target="_blank" rel="external">userInteractionEnabled</a>, <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instp/UIView/multipleTouchEnabled" target="_blank" rel="external">multipleTouchEnabled</a>, <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instp/UIView/exclusiveTouch" target="_blank" rel="external">exclusiveTouch</a></td>
<td>这些属性影响 view 如何处理触摸事件。</td>
</tr>
<tr>
<td><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instp/UIView/backgroundColor" target="_blank" rel="external">backgroundColor</a>, <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instp/UIView/subviews" target="_blank" rel="external">subviews</a>, <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instm/UIView/drawRect:" target="_blank" rel="external">drawRect:</a>方法, <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instp/UIView/layer" target="_blank" rel="external">layer</a>, (<a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/clm/UIView/layerClass" target="_blank" rel="external">layerClass</a> 方法)</td>
<td>这些属性和方法帮你管理 view 中的实际内容。</td>
</tr>
</tbody>
</table>
<h3 id="4-1-4-为以后的验证标记-view"><a href="#4-1-4-为以后的验证标记-view" class="headerlink" title="4.1.4 为以后的验证标记 view"></a>4.1.4 为以后的验证标记 view</h3><p><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instp/UIView/tag" target="_blank" rel="external">tag</a> 可以用一个整数值来标记特定的 view。默认这个属性为 0。</p>
<p>找到标记的view，可以使用 <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instm/UIView/viewWithTag:" target="_blank" rel="external">viewWithTag:</a> 方法。</p>
<h2 id="4-2-创建和管理-view-层级"><a href="#4-2-创建和管理-view-层级" class="headerlink" title="4.2 创建和管理 view 层级"></a>4.2 创建和管理 view 层级</h2><h3 id="4-2-1-添加和移除子视图"><a href="#4-2-1-添加和移除子视图" class="headerlink" title="4.2.1 添加和移除子视图"></a>4.2.1 添加和移除子视图</h3><p><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instm/UIView/addSubview:" target="_blank" rel="external">addSubview:</a> 方法直接添加到最上面。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)removeFromSuperview;</span><br><span class="line">- (<span class="keyword">void</span>)insertSubview:(<span class="built_in">UIView</span> *)view atIndex:(<span class="built_in">NSInteger</span>)index;</span><br><span class="line">- (<span class="keyword">void</span>)exchangeSubviewAtIndex:(<span class="built_in">NSInteger</span>)index1 withSubviewAtIndex:(<span class="built_in">NSInteger</span>)index2;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)addSubview:(<span class="built_in">UIView</span> *)view;</span><br><span class="line">- (<span class="keyword">void</span>)insertSubview:(<span class="built_in">UIView</span> *)view belowSubview:(<span class="built_in">UIView</span> *)siblingSubview;</span><br><span class="line">- (<span class="keyword">void</span>)insertSubview:(<span class="built_in">UIView</span> *)view aboveSubview:(<span class="built_in">UIView</span> *)siblingSubview;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)bringSubviewToFront:(<span class="built_in">UIView</span> *)view;</span><br><span class="line">- (<span class="keyword">void</span>)sendSubviewToBack:(<span class="built_in">UIView</span> *)view;</span><br></pre></td></tr></table></figure>
<h3 id="4-2-2-隐藏-view"><a href="#4-2-2-隐藏-view" class="headerlink" title="4.2.2 隐藏 view"></a>4.2.2 隐藏 view</h3><p>设置 hidden 属性为 YES，或者将alpha 属性设置为 0.0。隐藏view 之后就不能收到触摸事件了。</p>
<p>如果要以动画形式将view 从可视化到隐藏，必须使用 alpha 属性。hidden 属性不是可动画的</p>
<h3 id="4-2-3-从-view-层级中找出视图"><a href="#4-2-3-从-view-层级中找出视图" class="headerlink" title="4.2.3 从 view 层级中找出视图"></a>4.2.3 从 view 层级中找出视图</h3><p>两种方式：</p>
<ul>
<li>存储相应视图的指针，比如 view controller 拥有视图的方式</li>
<li>给 view 的 tag 属性赋值，但数字要独一无二；然后用 <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instm/UIView/viewWithTag:" target="_blank" rel="external">viewWithTag:</a> 方法拿到</li>
</ul>
<h3 id="4-2-4-转变，伸缩，旋转-view"><a href="#4-2-4-转变，伸缩，旋转-view" class="headerlink" title="4.2.4 转变，伸缩，旋转 view"></a>4.2.4 转变，伸缩，旋转 view</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// M_PI/4.0 is one quarter of a half circle, or 45 degrees.</span></span><br><span class="line"><span class="built_in">CGAffineTransform</span> xform = <span class="built_in">CGAffineTransformMakeRotation</span>(M_PI/<span class="number">4.0</span>);</span><br><span class="line"><span class="keyword">self</span>.view.transform = xform;</span><br></pre></td></tr></table></figure>
<center><br><img src="http://ww1.sinaimg.cn/mw690/a9c4d5f6gw1f7ht5urbqlj20i40gpgmx.jpg" alt=""><br></center>

<h3 id="4-2-5-在视图层级中转换坐标"><a href="#4-2-5-在视图层级中转换坐标" class="headerlink" title="4.2.5 在视图层级中转换坐标"></a>4.2.5 在视图层级中转换坐标</h3><p>UIView 定义了下面几种方法在view 的局部坐标系中转换坐标</p>
<ul>
<li><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instm/UIView/convertPoint:fromView:" target="_blank" rel="external">convertPoint:fromView:</a></li>
<li><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instm/UIView/convertRect:fromView:" target="_blank" rel="external">convertRect:fromView:</a></li>
<li><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instm/UIView/convertPoint:toView:" target="_blank" rel="external">convertPoint:toView:</a></li>
<li><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instm/UIView/convertRect:toView:" target="_blank" rel="external">convertRect:toView:</a></li>
</ul>
<p>类似，UIWindow也定义了几个转换方法：</p>
<ul>
<li><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIWindow_Class/index.html#//apple_ref/occ/instm/UIWindow/convertPoint:fromWindow:" target="_blank" rel="external">convertPoint:fromWindow:</a></li>
<li><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIWindow_Class/index.html#//apple_ref/occ/instm/UIWindow/convertRect:fromWindow:" target="_blank" rel="external">convertRect:fromWindow:</a></li>
<li><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIWindow_Class/index.html#//apple_ref/occ/instm/UIWindow/convertPoint:toWindow:" target="_blank" rel="external">convertPoint:toWindow:</a></li>
<li><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIWindow_Class/index.html#//apple_ref/occ/instm/UIWindow/convertRect:toWindow:" target="_blank" rel="external">convertRect:toWindow:</a></li>
</ul>
<center><br><img src="http://ww3.sinaimg.cn/mw690/a9c4d5f6gw1f7htf2df7dj20f9060jsc.jpg" alt=""><br></center>

<h2 id="4-3-在运行时调整-view-的大小和位置"><a href="#4-3-在运行时调整-view-的大小和位置" class="headerlink" title="4.3 在运行时调整 view 的大小和位置"></a>4.3 在运行时调整 view 的大小和位置</h2><p>UIView 支持自动和手动布局</p>
<h3 id="4-3-1-为布局改变做准备"><a href="#4-3-1-为布局改变做准备" class="headerlink" title="4.3.1 为布局改变做准备"></a>4.3.1 为布局改变做准备</h3><p>当 view 中有下面几种事件发生的时候，布局需要改变：</p>
<ul>
<li>view 的 bound 矩形大小发生变化</li>
<li>界面的方法发生变化，这通常会触发根视图的 bound 矩形变化</li>
<li>与 view layer相关的 Core Animation sublayer 的集合发生变化，并要求 layout</li>
<li>调用view 的 <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instm/UIView/setNeedsLayout" target="_blank" rel="external">setNeedsLayout</a> 或者 <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instm/UIView/layoutIfNeeded" target="_blank" rel="external">layoutIfNeeded</a> 方法，让应用强制布局</li>
<li>调用view的 layer对象的 <a href="https://developer.apple.com/library/ios/documentation/GraphicsImaging/Reference/CALayer_class/index.html#//apple_ref/occ/instm/CALayer/setNeedsLayout" target="_blank" rel="external">setNeedsLayout</a> 方法，让应用强制布局</li>
</ul>
<h3 id="4-3-2-使用自动调整大小规则让布局自动变化"><a href="#4-3-2-使用自动调整大小规则让布局自动变化" class="headerlink" title="4.3.2 使用自动调整大小规则让布局自动变化"></a>4.3.2 使用自动调整大小规则让布局自动变化</h3><p>设置父视图 <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instp/UIView/autoresizesSubviews" target="_blank" rel="external">autoresizesSubviews</a> 属性来决定子视图是否需要调整大小。如果这个属性为 YES，每个子视图的 <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instp/UIView/autoresizingMask" target="_blank" rel="external">autoresizingMask</a> 属性决定如何变化。</p>
<table>
<thead>
<tr>
<th>Autoresizing mask</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/c/econst/UIViewAutoresizingNone" target="_blank" rel="external">UIViewAutoresizingNone</a></td>
<td>默认值，view不会自动调整大小</td>
</tr>
<tr>
<td><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/c/econst/UIViewAutoresizingFlexibleHeight" target="_blank" rel="external">UIViewAutoresizingFlexibleHeight</a></td>
<td>当父视图的高变化的时候，视图的高也会变化。如果没有包含这个常量，视图的高不变</td>
</tr>
<tr>
<td><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/c/econst/UIViewAutoresizingFlexibleWidth" target="_blank" rel="external">UIViewAutoresizingFlexibleWidth</a></td>
<td>当父视图的宽变化的时候，视图的宽也会变化。如果没有包含这个常量，视图的宽不变</td>
</tr>
<tr>
<td><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/c/econst/UIViewAutoresizingFlexibleLeftMargin" target="_blank" rel="external">UIViewAutoresizingFlexibleLeftMargin</a></td>
<td>视图左边界与父视图左边界的距离会按需要增大或减小。如果没有包含这个常量，将维持固定的距离</td>
</tr>
<tr>
<td><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/c/econst/UIViewAutoresizingFlexibleRightMargin" target="_blank" rel="external">UIViewAutoresizingFlexibleRightMargin</a></td>
<td>视图右边界与父视图右边界的距离会按需要增大或减小。如果没有包含这个常量，将维持固定的距离</td>
</tr>
<tr>
<td><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/c/econst/UIViewAutoresizingFlexibleBottomMargin" target="_blank" rel="external">UIViewAutoresizingFlexibleBottomMargin</a></td>
<td>视图下边界与父视图下边界的距离会按需要增大或减小。如果没有包含这个常量，将维持固定的距离</td>
</tr>
<tr>
<td><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/c/econst/UIViewAutoresizingFlexibleTopMargin" target="_blank" rel="external">UIViewAutoresizingFlexibleTopMargin</a></td>
<td>视图上边界与父视图上边界的距离会按需要增大或减小。如果没有包含这个常量，将维持固定的距离</td>
</tr>
</tbody>
</table>
<center><br><img src="http://ww2.sinaimg.cn/mw690/a9c4d5f6gw1f7huakdcxsj20pp0eldhs.jpg" alt=""><br></center>

<h3 id="4-3-3-手动调整视图布局"><a href="#4-3-3-手动调整视图布局" class="headerlink" title="4.3.3 手动调整视图布局"></a>4.3.3 手动调整视图布局</h3><p>在自定义 view 中，如果自动布局行为没有达到期望要求，可以实现 <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instm/UIView/layoutSubviews" target="_blank" rel="external">layoutSubviews</a> ，可以下面几件事：</p>
<ul>
<li>调整任何当前子视图的大小和位置</li>
<li>添加移除子视图或者核心动画层（Core Animation layers）</li>
<li>调用 <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instm/UIView/setNeedsDisplay" target="_blank" rel="external">setNeedsDisplay</a> 或者 <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instm/UIView/setNeedsDisplayInRect:" target="_blank" rel="external">setNeedsDisplayInRect:</a> 方法强制子视图重绘</li>
</ul>
<p>有大片滚动区域的时候应用会经常手动布局子视图。</p>
<p>写布局代码的时候测试代码对于下面情况是否完善：</p>
<ul>
<li>view方向改变的时候，确保布局对于所有支持方向都是正确的</li>
<li>确保你的代码对于 status bar高度的变化有适当的响应。</li>
</ul>
<h2 id="4-4-运行时修改视图"><a href="#4-4-运行时修改视图" class="headerlink" title="4.4 运行时修改视图"></a>4.4 运行时修改视图</h2><p>在 view controller 中：</p>
<ul>
<li>view controller 在显示 view 之前创建它们，可以从 nib 文件 load view 或者用代码创建它们。但这些views 不在需要的时候，销毁它们</li>
<li>当设备方向改变的时候， view controller 可能调整view 的大小和位置来匹配。对于新的方向，可能会隐藏一些view并且显示另外一些view</li>
<li>view controller 管理可编辑的内容，可能添加一下额外的按钮，使得编辑更加的方便</li>
</ul>
<h2 id="4-5-与-Core-Animation-Layers-交互"><a href="#4-5-与-Core-Animation-Layers-交互" class="headerlink" title="4.5 与 Core Animation Layers 交互"></a>4.5 与 Core Animation Layers 交互</h2><p>每个 view 的专属 layer 属性。</p>
<h3 id="4-5-1-改变-Layer-类关联的视图"><a href="#4-5-1-改变-Layer-类关联的视图" class="headerlink" title="4.5.1 改变 Layer 类关联的视图"></a>4.5.1 改变 Layer 类关联的视图</h3><p>view 被创建之后 layer关联view 的类型就不能改变了，每个 view 使用 <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/clm/UIView/layerClass" target="_blank" rel="external">layerClass</a> 类方法指定 layer 对象的类，这个方法默认实现返回的是 <a href="https://developer.apple.com/library/ios/documentation/GraphicsImaging/Reference/CALayer_class/index.html#//apple_ref/occ/cl/CALayer" target="_blank" rel="external">CALayer</a> 类，只能在子类中改变这个值，重写方法，返回一个不同的值。</p>
<p>view 将自己设置为它的layer对象的代理；view 拥有它的layer。view 和 layer 之间的关系不能改变。</p>
<h3 id="4-5-2-在-view-中-嵌入-Layer-对象"><a href="#4-5-2-在-view-中-嵌入-Layer-对象" class="headerlink" title="4.5.2 在 view 中 嵌入 Layer 对象"></a>4.5.2 在 view 中 嵌入 Layer 对象</h3><p>自定义 layer 对象可以是任何 CALayer 的实例，不被任何 view拥有。自定义 layer 不能接收时间，或者参与到响应链中，但是可以绘制自己，并且可以响应父视图的大小变化或者根据核心动画层规则响应。</p>
<p>给 view 添加自定义 layer 的实例代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Create the layer.</span></span><br><span class="line">    <span class="built_in">CALayer</span>* myLayer = [[<span class="built_in">CALayer</span> alloc] init];</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Set the contents of the layer to a fixed image. And set</span></span><br><span class="line">    <span class="comment">// the size of the layer to match the image size.</span></span><br><span class="line">    <span class="built_in">UIImage</span> layerContents = [[<span class="built_in">UIImage</span> imageNamed:<span class="string">@"myImage"</span>] retain];</span><br><span class="line">    <span class="built_in">CGSize</span> imageSize = layerContents.size;</span><br><span class="line"> </span><br><span class="line">    myLayer.bounds = <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, imageSize.width, imageSize.height);</span><br><span class="line">    myLayer = layerContents.CGImage;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Add the layer to the view.</span></span><br><span class="line">    <span class="built_in">CALayer</span>*    viewLayer = <span class="keyword">self</span>.view.layer;</span><br><span class="line">    [viewLayer addSublayer:myLayer];</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Center the layer in the view.</span></span><br><span class="line">    <span class="built_in">CGRect</span>        viewBounds = backingView.bounds;</span><br><span class="line">    myLayer.position = <span class="built_in">CGPointMake</span>(<span class="built_in">CGRectGetMidX</span>(viewBounds), <span class="built_in">CGRectGetMidY</span>(viewBounds));</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Release the layer, since it is retained by the view's layer</span></span><br><span class="line">    [myLayer release];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-6-定义自定义-view"><a href="#4-6-定义自定义-view" class="headerlink" title="4.6 定义自定义 view"></a>4.6 定义自定义 view</h2><h3 id="4-6-1-自定义视图的实现清单"><a href="#4-6-1-自定义视图的实现清单" class="headerlink" title="4.6.1 自定义视图的实现清单"></a>4.6.1 自定义视图的实现清单</h3><p>自定义视图需要注意下面这些情况：</p>
<ul>
<li>为 view 定义适当的初始化方法：<ul>
<li>对于想要用代码创建 view，需要重写 <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instm/UIView/initWithFrame:" target="_blank" rel="external">initWithFrame:</a> 方法或者定义一个自定义初始化方法</li>
<li>对于想要从 nib 文件中 加载view，需要重写 <a href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/Protocols/NSCoding_Protocol/index.html#//apple_ref/occ/intfm/NSCoding/initWithCoder:" target="_blank" rel="external">initWithCoder:</a> 方法。使用这个方法初始化你的view并把它放入一个已知状态。</li>
</ul>
</li>
<li>实现<a href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/Classes/NSObject_Class/index.html#//apple_ref/occ/instm/NSObject/dealloc" target="_blank" rel="external">dealloc</a> 方法，来处理自定义数据的清理</li>
<li>为了处理自定义的绘制，重写 <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instm/UIView/drawRect:" target="_blank" rel="external">drawRect:</a> 方法并且在方法中进行绘制</li>
<li>设置视图 <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instp/UIView/autoresizingMask" target="_blank" rel="external">autoresizingMask</a> 属性来定义它的自动调整大小行为。</li>
<li>如果你的 view class 管理一个或多个必需的子视图：<ul>
<li>视图的初始化过程中创建这些子视图。 </li>
<li>创建的时候设置每个子视图的 autoresizingMask 属性</li>
<li>如果子视图要求自定义布局，重写 <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instm/UIView/layoutSubviews" target="_blank" rel="external">layoutSubviews</a> 方法，并实现你的布局</li>
</ul>
</li>
<li>为了处理基于触摸的事件：<ul>
<li>使用 <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instm/UIView/addGestureRecognizer:" target="_blank" rel="external">addGestureRecognizer</a> 方法给view添加合适的手势识别</li>
<li>为了处理触摸事件，重写 <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIResponder_Class/index.html#//apple_ref/occ/instm/UIResponder/touchesBegan:withEvent:" target="_blank" rel="external">touchesBegan:withEvent:</a>, <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIResponder_Class/index.html#//apple_ref/occ/instm/UIResponder/touchesMoved:withEvent:" target="_blank" rel="external">touchesMoved:withEvent:</a>, <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIResponder_Class/index.html#//apple_ref/occ/instm/UIResponder/touchesEnded:withEvent:" target="_blank" rel="external">touchesEnded:withEvent:</a>, <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIResponder_Class/index.html#//apple_ref/occ/instm/UIResponder/touchesCancelled:withEvent:" target="_blank" rel="external">touchesCancelled:withEvent:</a> 方法。（不管有没有重写其他触摸方法，应该总是要重写 <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIResponder_Class/index.html#//apple_ref/occ/instm/UIResponder/touchesCancelled:withEvent:" target="_blank" rel="external">touchesCancelled:withEvent:</a> 方法）</li>
</ul>
</li>
<li>如果想要view 的打印版本再不同的屏幕版本上看起来不同，需要实现 <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/instm/UIView/drawRect:forViewPrintFormatter:" target="_blank" rel="external">drawRect:forViewPrintFormatter:</a> 方法。详情看 <a href="https://developer.apple.com/library/ios/documentation/2DDrawing/Conceptual/DrawingPrintingiOS/Introduction/Introduction.html#//apple_ref/doc/uid/TP40010156" target="_blank" rel="external">Drawing and Printing Guide for iOS. </a></li>
</ul>
<h3 id="4-6-2-初始化自定义-view"><a href="#4-6-2-初始化自定义-view" class="headerlink" title="4.6.2 初始化自定义 view"></a>4.6.2 初始化自定义 view</h3><p>view 应该包含 initWithFrame: 方法。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)initWithFrame:(<span class="built_in">CGRect</span>)aRect &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> initWithFrame:aRect];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">          <span class="comment">// setup the initial properties of the view</span></span><br><span class="line">          ...</span><br><span class="line">       &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-6-3-实现自己的绘图代码"><a href="#4-6-3-实现自己的绘图代码" class="headerlink" title="4.6.3 实现自己的绘图代码"></a>4.6.3 实现自己的绘图代码</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)drawRect:(<span class="built_in">CGRect</span>)rect &#123;</span><br><span class="line">    <span class="built_in">CGContextRef</span> context = <span class="built_in">UIGraphicsGetCurrentContext</span>();</span><br><span class="line">    <span class="built_in">CGRect</span>    myFrame = <span class="keyword">self</span>.bounds;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Set the line width to 10 and inset the rectangle by</span></span><br><span class="line">    <span class="comment">// 5 pixels on all sides to compensate for the wider line.</span></span><br><span class="line">    <span class="built_in">CGContextSetLineWidth</span>(context, <span class="number">10</span>);</span><br><span class="line">    <span class="built_in">CGRectInset</span>(myFrame, <span class="number">5</span>, <span class="number">5</span>);</span><br><span class="line"> </span><br><span class="line">    [[<span class="built_in">UIColor</span> redColor] set];</span><br><span class="line">    <span class="built_in">UIRectFrame</span>(myFrame);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-6-4-响应事件"><a href="#4-6-4-响应事件" class="headerlink" title="4.6.4 响应事件"></a>4.6.4 响应事件</h3><h3 id="4-6-5-使用view-之后清理"><a href="#4-6-5-使用view-之后清理" class="headerlink" title="4.6.5 使用view 之后清理"></a>4.6.5 使用view 之后清理</h3><h1 id="5-Animations-动画"><a href="#5-Animations-动画" class="headerlink" title="5 Animations 动画"></a>5 Animations 动画</h1><h2 id="5-1-什么可以变为动画？"><a href="#5-1-什么可以变为动画？" class="headerlink" title="5.1 什么可以变为动画？"></a>5.1 什么可以变为动画？</h2><p>下面是UIView中可以用于动画的一些属性：</p>
<ul>
<li>frame</li>
<li>bounds</li>
<li>center</li>
<li>transform</li>
<li>alpha</li>
<li>backgroundColor</li>
<li>contentStretch</li>
</ul>
<p>使用 Core Animation 可以对view 的layer 做下面类型的变化：</p>
<ul>
<li>layer 大小和位置</li>
<li>当执行过渡时候，使用的中点</li>
<li>在 3D 空间中 layer或者 sublayer 的变化</li>
<li>从 layer 层级中添加或者移除 layer</li>
<li>对于其他同级layer 的Z轴顺序</li>
<li>layer 的阴影</li>
<li>layer 的边界（包含边角是否是圆角）</li>
<li>resize操作时候 layer 的部分伸缩</li>
<li>layer 的不透明度</li>
<li>在 layer边界外面部分的裁剪行为</li>
<li>layer 的当前内容</li>
<li>layer 的光栅线</li>
</ul>
<h2 id="5-2-视图中的动画属性变化"><a href="#5-2-视图中的动画属性变化" class="headerlink" title="5.2 视图中的动画属性变化"></a>5.2 视图中的动画属性变化</h2><h3 id="5-2-1-使用基于-block-的方法开始动画"><a href="#5-2-1-使用基于-block-的方法开始动画" class="headerlink" title="5.2.1 使用基于 block 的方法开始动画"></a>5.2.1 使用基于 block 的方法开始动画</h3><p>下面有3个类方法：</p>
<ul>
<li><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/clm/UIView/animateWithDuration:animations:" target="_blank" rel="external">animateWithDuration:animations:</a></li>
<li><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/clm/UIView/animateWithDuration:animations:completion:" target="_blank" rel="external">animateWithDuration:animations:completion:</a></li>
<li><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/clm/UIView/animateWithDuration:delay:options:animations:completion:" target="_blank" rel="external">animateWithDuration:delay:options:animations:completion:</a></li>
</ul>
<p>这些方法都是开了新线程执行动画，以防阻塞当前线程或者主线程。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">UIView</span> animateWithDuration:<span class="number">1.0</span> animations:^&#123;</span><br><span class="line">        firstView.alpha = <span class="number">0.0</span>;</span><br><span class="line">        secondView.alpha = <span class="number">1.0</span>;</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<p>上面方法只是慢进慢出的单一动画形式，想要复杂的，必须使用 <code>animateWithDuration:delay:options:animations:completion:</code> 方法，可以自定义下面动画参数：</p>
<ul>
<li>开始动画前的延迟</li>
<li>动画期间所使用的时序曲线类型</li>
<li>动画应该重复的次数</li>
<li>动画达到末尾的时候是否应该自动反转</li>
<li>动画进行的时候时候view 是否接收触摸事件</li>
<li>当前动画是否可以中断正在进行的任何其他动画，或者是等到其他都完成再开始</li>
</ul>
<p>下面代码设置了渐隐动画，并且使用 completion handler，这是连接多个动画的基本方式</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">IBAction</span>)showHideView:(<span class="keyword">id</span>)sender</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Fade out the view right away</span></span><br><span class="line">    [<span class="built_in">UIView</span> animateWithDuration:<span class="number">1.0</span></span><br><span class="line">        delay: <span class="number">0.0</span></span><br><span class="line">        options: <span class="built_in">UIViewAnimationOptionCurveEaseIn</span></span><br><span class="line">        animations:^&#123;</span><br><span class="line">             thirdView.alpha = <span class="number">0.0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        completion:^(<span class="built_in">BOOL</span> finished)&#123;</span><br><span class="line">            <span class="comment">// Wait one second and then fade in the view</span></span><br><span class="line">            [<span class="built_in">UIView</span> animateWithDuration:<span class="number">1.0</span></span><br><span class="line">                 delay: <span class="number">1.0</span></span><br><span class="line">                 options:<span class="built_in">UIViewAnimationOptionCurveEaseOut</span></span><br><span class="line">                 animations:^&#123;</span><br><span class="line">                    thirdView.alpha = <span class="number">1.0</span>;</span><br><span class="line">                 &#125;</span><br><span class="line">                 completion:<span class="literal">nil</span>];</span><br><span class="line">        &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-2-2-使用-Begin-Commit-方法开始动画"><a href="#5-2-2-使用-Begin-Commit-方法开始动画" class="headerlink" title="5.2.2 使用 Begin/Commit 方法开始动画"></a>5.2.2 使用 Begin/Commit 方法开始动画</h3><p>这是 iOS 3.2 之前使用的方法。。。</p>
<p>执行简单的 begin/commit 动画</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">UIView</span> beginAnimations:<span class="string">@"ToggleViews"</span> context:<span class="literal">nil</span>];</span><br><span class="line">[<span class="built_in">UIView</span> setAnimationDuration:<span class="number">1.0</span>];</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Make the animatable changes.</span></span><br><span class="line">firstView.alpha = <span class="number">0.0</span>;</span><br><span class="line">secondView.alpha = <span class="number">1.0</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Commit the changes and perform the animation.</span></span><br><span class="line">[<span class="built_in">UIView</span> commitAnimations];</span><br></pre></td></tr></table></figure>
<p>配置动画参数：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This method begins the first animation.</span></span><br><span class="line">- (<span class="keyword">IBAction</span>)showHideView:(<span class="keyword">id</span>)sender</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="built_in">UIView</span> beginAnimations:<span class="string">@"ShowHideView"</span> context:<span class="literal">nil</span>];</span><br><span class="line">    [<span class="built_in">UIView</span> setAnimationCurve:<span class="built_in">UIViewAnimationCurveEaseIn</span>];</span><br><span class="line">    [<span class="built_in">UIView</span> setAnimationDuration:<span class="number">1.0</span>];</span><br><span class="line">    [<span class="built_in">UIView</span> setAnimationDelegate:<span class="keyword">self</span>];</span><br><span class="line">    [<span class="built_in">UIView</span> setAnimationDidStopSelector:<span class="keyword">@selector</span>(showHideDidStop:finished:context:)];</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Make the animatable changes.</span></span><br><span class="line">    thirdView.alpha = <span class="number">0.0</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Commit the changes and perform the animation.</span></span><br><span class="line">    [<span class="built_in">UIView</span> commitAnimations];</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Called at the end of the preceding animation.</span></span><br><span class="line">- (<span class="keyword">void</span>)showHideDidStop:(<span class="built_in">NSString</span> *)animationID finished:(<span class="built_in">NSNumber</span> *)finished context:(<span class="keyword">void</span> *)context</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="built_in">UIView</span> beginAnimations:<span class="string">@"ShowHideView2"</span> context:<span class="literal">nil</span>];</span><br><span class="line">    [<span class="built_in">UIView</span> setAnimationCurve:<span class="built_in">UIViewAnimationCurveEaseOut</span>];</span><br><span class="line">    [<span class="built_in">UIView</span> setAnimationDuration:<span class="number">1.0</span>];</span><br><span class="line">    [<span class="built_in">UIView</span> setAnimationDelay:<span class="number">1.0</span>];</span><br><span class="line"> </span><br><span class="line">    thirdView.alpha = <span class="number">1.0</span>;</span><br><span class="line"> </span><br><span class="line">    [<span class="built_in">UIView</span> commitAnimations];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-2-3-配置动画代理"><a href="#5-2-3-配置动画代理" class="headerlink" title="5.2.3 配置动画代理"></a>5.2.3 配置动画代理</h3><p>如果想要在动画开始前或者结束后立即执行代码，就需要将代理对象和 start or stop selector，与 begin/commit 动画块联结起来。使用UIView的类方法 <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/clm/UIView/setAnimationDelegate:" target="_blank" rel="external">setAnimationDelegate:</a> 设置代理对象。使用 <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/clm/UIView/setAnimationWillStartSelector:" target="_blank" rel="external">setAnimationWillStartSelector:</a> 和 <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/clm/UIView/setAnimationDidStopSelector:" target="_blank" rel="external">setAnimationDidStopSelector:</a> 类方法设置开始和结束的 selector。</p>
<p>类似下面的代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)animationWillStart:(<span class="built_in">NSString</span> *)animationID context:(<span class="keyword">void</span> *)context;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)animationDidStop:(<span class="built_in">NSString</span> *)animationID finished:(<span class="built_in">NSNumber</span> *)finished context:(<span class="keyword">void</span> *)context;</span><br></pre></td></tr></table></figure>
<p>在基于 block 的动画方法中不需要使用上面这种形式。直接在动画block之前放置想要在动画前执行的代码，在 completion handler 里面放置想要在动画结束后执行的代码。</p>
<h3 id="5-2-4-嵌套动画-block"><a href="#5-2-4-嵌套动画-block" class="headerlink" title="5.2.4 嵌套动画 block"></a>5.2.4 嵌套动画 block</h3><p>被嵌套的动画与父动画同一时间开始，但可以以自己的配置选项运行。默认被嵌套的动画继承了父动画的持续时间和动画曲线。</p>
<p>有不同配置的嵌套动画</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">UIView</span> animateWithDuration:<span class="number">1.0</span></span><br><span class="line">        delay: <span class="number">1.0</span></span><br><span class="line">        options:<span class="built_in">UIViewAnimationOptionCurveEaseOut</span></span><br><span class="line">        animations:^&#123;</span><br><span class="line">            aView.alpha = <span class="number">0.0</span>;</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// Create a nested animation that has a different</span></span><br><span class="line">            <span class="comment">// duration, timing curve, and configuration.</span></span><br><span class="line">            [<span class="built_in">UIView</span> animateWithDuration:<span class="number">0.2</span></span><br><span class="line">                 delay:<span class="number">0.0</span></span><br><span class="line">                 options: <span class="built_in">UIViewAnimationOptionOverrideInheritedCurve</span> |</span><br><span class="line">                          <span class="built_in">UIViewAnimationOptionCurveLinear</span> |</span><br><span class="line">                          <span class="built_in">UIViewAnimationOptionOverrideInheritedDuration</span> |</span><br><span class="line">                          <span class="built_in">UIViewAnimationOptionRepeat</span> |</span><br><span class="line">                          <span class="built_in">UIViewAnimationOptionAutoreverse</span></span><br><span class="line">                 animations:^&#123;</span><br><span class="line">                      [<span class="built_in">UIView</span> setAnimationRepeatCount:<span class="number">2.5</span>];</span><br><span class="line">                      anotherView.alpha = <span class="number">0.0</span>;</span><br><span class="line">                 &#125;</span><br><span class="line">                 completion:<span class="literal">nil</span>];</span><br><span class="line"> </span><br><span class="line">        &#125;</span><br><span class="line">        completion:<span class="literal">nil</span>];</span><br></pre></td></tr></table></figure>
<h3 id="5-2-5-实现动画的逆行"><a href="#5-2-5-实现动画的逆行" class="headerlink" title="5.2.5 实现动画的逆行"></a>5.2.5 实现动画的逆行</h3><h2 id="5-3-在view-之间创建动画过渡"><a href="#5-3-在view-之间创建动画过渡" class="headerlink" title="5.3 在view 之间创建动画过渡"></a>5.3 在view 之间创建动画过渡</h2><p>不要把 view transition 和 view controller 的变换搞混，view transition 只是影响 view 层级</p>
<h3 id="5-3-1-改变视图的子视图"><a href="#5-3-1-改变视图的子视图" class="headerlink" title="5.3.1 改变视图的子视图"></a>5.3.1 改变视图的子视图</h3><p><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/occ/clm/UIView/transitionWithView:duration:options:animations:completion:" target="_blank" rel="external">transitionWithView:duration:options:animations:completion:</a> 方法。<a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html#//apple_ref/c/econst/UIViewAnimationOptionAllowAnimatedContent" target="_blank" rel="external">UIViewAnimationOptionAllowAnimatedContent</a> 设置选项。</p>
<p>将空的文本视图与现有的进行交换</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">IBAction</span>)displayNewPage:(<span class="keyword">id</span>)sender</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="built_in">UIView</span> transitionWithView:<span class="keyword">self</span>.view</span><br><span class="line">        duration:<span class="number">1.0</span></span><br><span class="line">        options:<span class="built_in">UIViewAnimationOptionTransitionCurlUp</span></span><br><span class="line">        animations:^&#123;</span><br><span class="line">            currentTextView.hidden = <span class="literal">YES</span>;</span><br><span class="line">            swapTextView.hidden = <span class="literal">NO</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        completion:^(<span class="built_in">BOOL</span> finished)&#123;</span><br><span class="line">            <span class="comment">// Save the old text and then swap the views.</span></span><br><span class="line">            [<span class="keyword">self</span> saveNotes:temp];</span><br><span class="line"> </span><br><span class="line">            <span class="built_in">UIView</span>*    temp = currentTextView;</span><br><span class="line">            currentTextView = swapTextView;</span><br><span class="line">            swapTextView = temp;</span><br><span class="line">        &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-3-2-替换view"><a href="#5-3-2-替换view" class="headerlink" title="5.3.2 替换view"></a>5.3.2 替换view</h3><p>只是交换两个 view，不是 view controllers。</p>
<p>一个 view controller 中两个 view 之间的开关</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">IBAction</span>)toggleMainViews:(<span class="keyword">id</span>)sender &#123;</span><br><span class="line">    [<span class="built_in">UIView</span> transitionFromView:(displayingPrimary ? primaryView : secondaryView)</span><br><span class="line">        toView:(displayingPrimary ? secondaryView : primaryView)</span><br><span class="line">        duration:<span class="number">1.0</span></span><br><span class="line">        options:(displayingPrimary ? <span class="built_in">UIViewAnimationOptionTransitionFlipFromRight</span> :</span><br><span class="line">                    <span class="built_in">UIViewAnimationOptionTransitionFlipFromLeft</span>)</span><br><span class="line">        completion:^(<span class="built_in">BOOL</span> finished) &#123;</span><br><span class="line">            <span class="keyword">if</span> (finished) &#123;</span><br><span class="line">                displayingPrimary = !displayingPrimary;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-4-将多个动画连接在一起"><a href="#5-4-将多个动画连接在一起" class="headerlink" title="5.4 将多个动画连接在一起"></a>5.4 将多个动画连接在一起</h2><h2 id="5-5-Animating-View-and-Layer-Changes-Together"><a href="#5-5-Animating-View-and-Layer-Changes-Together" class="headerlink" title="5.5 Animating View and Layer Changes Together"></a>5.5 Animating View and Layer Changes Together</h2><p>下面代码显示了同时修改view 和 自定义 layer 的动画。例子中的 view 包含了一个自定义 CALayer ，在view 的 bounds 中央。当顺时针旋转 layer 时，逆时针旋转 view。</p>
<p>Mixing view and layer animations</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">UIView</span> animateWithDuration:<span class="number">1.0</span></span><br><span class="line">    delay:<span class="number">0.0</span></span><br><span class="line">    options: <span class="built_in">UIViewAnimationOptionCurveLinear</span></span><br><span class="line">    animations:^&#123;</span><br><span class="line">        <span class="comment">// Animate the first half of the view rotation.</span></span><br><span class="line">        <span class="built_in">CGAffineTransform</span>  xform = <span class="built_in">CGAffineTransformMakeRotation</span>(DEGREES_TO_RADIANS(<span class="number">-180</span>));</span><br><span class="line">        backingView.transform = xform;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// Rotate the embedded CALayer in the opposite direction.</span></span><br><span class="line">        <span class="built_in">CABasicAnimation</span>*    layerAnimation = [<span class="built_in">CABasicAnimation</span> animationWithKeyPath:<span class="string">@"transform"</span>];</span><br><span class="line">        layerAnimation.duration = <span class="number">2.0</span>;</span><br><span class="line">        layerAnimation.beginTime = <span class="number">0</span>; <span class="comment">//CACurrentMediaTime() + 1;</span></span><br><span class="line">        layerAnimation.valueFunction = [<span class="built_in">CAValueFunction</span> functionWithName:k<span class="built_in">CAValueFunctionRotateZ</span>];</span><br><span class="line">        layerAnimation.timingFunction = [<span class="built_in">CAMediaTimingFunction</span></span><br><span class="line">                        functionWithName:k<span class="built_in">CAMediaTimingFunctionLinear</span>];</span><br><span class="line">        layerAnimation.fromValue = [<span class="built_in">NSNumber</span> numberWithFloat:<span class="number">0.0</span>];</span><br><span class="line">        layerAnimation.toValue = [<span class="built_in">NSNumber</span> numberWithFloat:DEGREES_TO_RADIANS(<span class="number">360.0</span>)];</span><br><span class="line">        layerAnimation.byValue = [<span class="built_in">NSNumber</span> numberWithFloat:DEGREES_TO_RADIANS(<span class="number">180.0</span>)];</span><br><span class="line">        [manLayer addAnimation:layerAnimation forKey:<span class="string">@"layerAnimation"</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    completion:^(<span class="built_in">BOOL</span> finished)&#123;</span><br><span class="line">        <span class="comment">// Now do the second half of the view rotation.</span></span><br><span class="line">        [<span class="built_in">UIView</span> animateWithDuration:<span class="number">1.0</span></span><br><span class="line">             delay: <span class="number">0.0</span></span><br><span class="line">             options: <span class="built_in">UIViewAnimationOptionCurveLinear</span></span><br><span class="line">             animations:^&#123;</span><br><span class="line">                 <span class="built_in">CGAffineTransform</span>  xform = <span class="built_in">CGAffineTransformMakeRotation</span>(DEGREES_TO_RADIANS(<span class="number">-359</span>));</span><br><span class="line">                 backingView.transform = xform;</span><br><span class="line">             &#125;</span><br><span class="line">             completion:^(<span class="built_in">BOOL</span> finished)&#123;</span><br><span class="line">                 backingView.transform = <span class="built_in">CGAffineTransformIdentity</span>;</span><br><span class="line">         &#125;];</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<blockquote>
<p>苹果官方文档地址：<a href="https://developer.apple.com/library/ios/documentation/WindowsViews/Conceptual/ViewPG_iPhoneOS/Introduction/Introduction.html#//apple_ref/doc/uid/TP40009503-CH1-SW2" target="_blank" rel="external">View Programming Guide for iOS</a></p>
<p>新博客文章地址：<a href="http://yoferzhang.com/post/20160902ViewProgrammingGuide/">View Programming Guide for iOS</a><br>CSDN文章地址：<a href="http://blog.csdn.net/zyq522376829/article/details/52437919" target="_blank" rel="external">View Programming Guide for iOS</a></p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoferzhang.com/post/20160831KVO/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Yofer Zhang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="http://ww2.sinaimg.cn/mw690/a9c4d5f6jw1e3siexaeopj.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="YoferZhang 的博客">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="YoferZhang 的博客" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/20160831KVO/" itemprop="url">
                  【iOS】KVO编程指南,Key-Value Observing Programming Guide翻译
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-08-31T20:53:27+08:00">
                2016-08-31
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/post/20160831KVO/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="post/20160831KVO/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>版权声明：本文为博主原创翻译，如需转载请注明出处。</p>
</blockquote>
<h1 id="1-Introduction-to-Key-Value-Observing-Programming-Guide-KVO编程指南介绍"><a href="#1-Introduction-to-Key-Value-Observing-Programming-Guide-KVO编程指南介绍" class="headerlink" title="1 Introduction to Key-Value Observing Programming Guide - KVO编程指南介绍"></a>1 Introduction to Key-Value Observing Programming Guide - KVO编程指南介绍</h1><p>Key-value observing is a mechanism that allows objects to be notified of changes to specified properties of other objects.</p>
<p>键 - 值观察是一种机制，当指定对象属性改变的时候允许另一个对象接受通知。</p>
<blockquote>
<p>Important: In order to understand key-value observing, you must first understand key-value coding.</p>
<p>重要：了解键值观察之前，首先要理解键值编程 (<a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/KeyValueCoding/Articles/KeyValueCoding.html#//apple_ref/doc/uid/10000107i" target="_blank" rel="external">key-value coding</a>)</p>
</blockquote>
<h2 id="1-1-At-a-Glance-概括"><a href="#1-1-At-a-Glance-概括" class="headerlink" title="1.1 At a Glance - 概括"></a>1.1 At a Glance - 概括</h2><p>Key-value observing provides a mechanism that allows objects to be notified of changes to specific properties of other objects. It is particularly useful for communication between model and controller layers in an application. (In OS X, the controller layer binding technology relies heavily on key-value observing.) A controller object typically observes properties of model objects, and a view object observes properties of model objects through a controller. In addition, however, a model object may observe other model objects (usually to determine when a dependent value changes) or even itself (again to determine when a dependent value changes).</p>
<p>You can observe properties including simple attributes, to-one relationships, and to-many relationships. Observers of to-many relationships are informed of the type of change made—as well as which objects are involved in the change.</p>
<p>There are three steps to setting up an observer of a property. Understanding these three steps provides a clear illustration of how KVO works.</p>
<p>键 - 值观察是一种机制，当指定对象属性改变的时候允许另一个对象接受通知。在应用中，对于模型和控制器层之间的交流非常有用。（在 OS X 中，控制器层绑定技术严重依赖于键-值观察。）一个控制器对象通常观察模型对象的属性，视图对象通过控制器观察模型对象的属性。然后，一个模型对象可以观察其它模型对象（通常为了确定从属值是什么时候改变的），或者甚至观察自身（也是为了确定从属值何时变化）。</p>
<p>你可以观察一些属性，比如简单的属性，一对一关系的，一对多关系的。一对多关系的观察者可以收到变化的类型，以及哪些对象发生了改变。</p>
<p>建立属性的观察者有三步。下面提供一个清晰的KVO工作方式演示，来理解这三步。</p>
<p>1.First, see whether you have a scenario where key-value observing could be beneficial, for example, an object that needs to be notified when any changes are made to a specific property in another object.</p>
<p>1.首先，考虑这样的一个场景，例如当对一个A对象的特定做出任何改变的时候，B对象需要被通知。</p>
<center><br><img src="http://ww1.sinaimg.cn/mw690/a9c4d5f6gw1f7d8p43trej20af00vq2t.jpg" alt=""><br></center>

<p>2.The PersonObject must register as an observer of the BankObject’s accountBalance property by sending an addObserver:forKeyPath:options:context: message.</p>
<p>2.<code>PersonObject</code>必须注册为 <code>BankObject</code> 的 <code>accountBalance</code> 属性的观察者，通过发送一个消息 <a href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/Protocols/NSKeyValueObserving_Protocol/index.html#//apple_ref/occ/instm/NSObject/addObserver:forKeyPath:options:context:" target="_blank" rel="external">addObserver:forKeyPath:options:context:</a> </p>
<center><br><img src="http://ww4.sinaimg.cn/mw690/a9c4d5f6gw1f7d8wwxxoij20b704bq35.jpg" alt=""><br></center>

<blockquote>
<p>Note: The addObserver:forKeyPath:options:context: method establishes a connection between the instances of the objects that you specify. A connection is not established between the two classes, but rather between the two specified instances of the objects.</p>
<p>注意：<code>addObserver:forKeyPath:options:context:</code> 方法规定了一个指定对象实例之间的连接。注意不是两个类之间的连接，两个对象的实例。</p>
</blockquote>
<p>3.In order to respond to change notifications, the observer must implement the observeValueForKeyPath:ofObject:change:context: method. This method implementation defines how the observer responds to change notifications. It is in this method that you can customize your response to a change in one of the observed properties.</p>
<p>3.为了响应变化的通知，观察者必须实现方法 <a href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/Protocols/NSKeyValueObserving_Protocol/index.html#//apple_ref/occ/instm/NSObject/observeValueForKeyPath:ofObject:change:context:" target="_blank" rel="external">observeValueForKeyPath:ofObject:change:context:</a>。这个方法的实现中定义了观察者如何响应改变通知。可以在这个方法中定制被观察属性之一改变时的响应。</p>
<center><br><img src="http://ww4.sinaimg.cn/mw690/a9c4d5f6gw1f7d93mqed2j20dp0773z0.jpg" alt=""><br></center>

<p>Registering for Key-Value Observing describes how to register and receive observation notifications.</p>
<p><a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/KeyValueObserving/Articles/KVOBasics.html#//apple_ref/doc/uid/20002252-BAJEAIEE" target="_blank" rel="external">Registering for Key-Value Observing</a>说明如何注册和接受观察的通知。</p>
<p>4.The observeValueForKeyPath:ofObject:change:context: method is automatically invoked when the value of an observed property is changed in a KVO-compliant manner, or if a key upon which it depends is changed.</p>
<p>4.当被观察属性的值在KVO-compliant方式中改变 或者它依赖的一个key改变的时候，<code>observeValueForKeyPath:ofObject:change:context:</code> 方法自动被调用。</p>
<center><br><img src="http://ww1.sinaimg.cn/mw690/a9c4d5f6gw1f7d9dlm0vyj209b04z74e.jpg" alt=""><br></center>

<p>Registering Dependent Keys explains how to specify that the value of a key is dependent on the value of another key.</p>
<p><a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/KeyValueObserving/Articles/KVODependentKeys.html#//apple_ref/doc/uid/20002179-BAJEAIEE" target="_blank" rel="external">Registering Dependent Keys</a> 解释了指定一个键的值依赖于另一个键的值。</p>
<p>KVO’s primary benefit is that you don’t have to implement your own scheme to send notifications every time a property changes. Its well-defined infrastructure has framework-level support that makes it easy to adopt—typically you do not have to add any code to your project. In addition, the infrastructure is already full-featured, which makes it easy to support multiple observers for a single property, as well as dependent values.</p>
<p>KVO Compliance describes the difference between automatic and manual key-value observing, and how to implement both.</p>
<p>Unlike notifications that use NSNotificationCenter, there is no central object that provides change notification for all observers. Instead, notifications are sent directly to the observing objects when changes are made. NSObject provides this base implementation of key-value observing, and you should rarely need to override these methods.</p>
<p>Key-Value Observing Implementation Details describes how key-value observing is implemented.</p>
<p>KVO的优点是，每次属性改变的时候，不需要自己实现发送通知。它良好定义的基础设施有架构层面的支持，使得它易于使用，通常不需要再工程中添加任何代码。此外，基础设施已经是全特性的，它可以很容易地支持单一属性的多个观察者，以及相关的值。</p>
<p><a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/KeyValueObserving/Articles/KVOCompliance.html#//apple_ref/doc/uid/20002178-BAJEAIEE" target="_blank" rel="external">KVO Compliance</a> 描述了自动和手动键值观察的区别，以及如何实现两者。</p>
<p>于使用 <a href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/Classes/NSNotificationCenter_Class/index.html#//apple_ref/occ/cl/NSNotificationCenter" target="_blank" rel="external">NSNotificationCenter</a> 的通知不同，这里没有为所有观察者提供更改通知的中央对象，。相反，更改时通知直接被发送到观察对象。<code>NSObject</code> 提供了键值观察的基本实现，你应该很少需要重写这些方法。</p>
<p><a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/KeyValueObserving/Articles/KVOImplementation.html#//apple_ref/doc/uid/20002307-BAJEAIEE" target="_blank" rel="external">Key-Value Observing Implementation Details</a>描述键值观察室如何实现的。</p>
<h1 id="2-Registering-for-Key-Value-Observing-注册键值观察"><a href="#2-Registering-for-Key-Value-Observing-注册键值观察" class="headerlink" title="2 Registering for Key-Value Observing - 注册键值观察"></a>2 Registering for Key-Value Observing - 注册键值观察</h1><p>In order to receive key-value observing notifications for a property, three things are required:</p>
<ul>
<li>The observed class must be key-value observing compliant for the property that you wish to observe.</li>
<li>You must register the observing object with the observed object, using the method addObserver:forKeyPath:options:context:.</li>
<li>The observing class must implement observeValueForKeyPath:ofObject:change:context:.</li>
</ul>
<p>针对一个属性，为了接收键值观察通知，有3个要求：</p>
<ul>
<li>对于你希望观察的属性，被观察的类必须是键值观察兼容的。</li>
<li>你必须对被观察的对象注册观察对象，使用方法 <code>addObserver:forKeyPath:options:context:</code></li>
<li>观察类必须实现方法 <code>observeValueForKeyPath:ofObject:change:context:</code></li>
</ul>
<blockquote>
<p>Important: Not all classes are KVO-compliant for all properties. You can ensure your own classes are KVO-compliant by following the steps described in KVO Compliance. Typically properties in Apple-supplied frameworks are only KVO-compliant if they are documented as such.</p>
<p>重要提示：不是所有类对于所有属性都是KVO兼容的。你可以通过下面几个步骤确保你自己的类是KVO兼容的，在<a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/KeyValueObserving/Articles/KVOCompliance.html#//apple_ref/doc/uid/20002178-BAJEAIEE" target="_blank" rel="external">KVO Compliance</a>中有描述。通常，如果它们被记录为这种苹果提供的框架属性，那就唯一KVO兼容的。</p>
</blockquote>
<h2 id="2-1-Registering-as-an-Observer-注册为一个观察者"><a href="#2-1-Registering-as-an-Observer-注册为一个观察者" class="headerlink" title="2.1 Registering as an Observer - 注册为一个观察者"></a>2.1 Registering as an Observer - 注册为一个观察者</h2><p>In order to be notified of changes to a property, an observing object must first register with the object to be observed by sending it an addObserver:forKeyPath:options:context: message, passing the observer object and the key path of the property to be observed. The options parameter specifies the information that is provided to the observer when a change notification is sent. Using the option NSKeyValueObservingOptionOld specifies that the original object value is provided to the observer as an entry in the change dictionary. Specifying the NSKeyValueObservingOptionNew option provides the new value as an entry in the change dictionary. To receive both values, you would bitwise OR the option constants.</p>
<p>The example in Listing 1 demonstrates registering an inspector object for the property openingBalance.</p>
<p>为了属性改变时能被通知到，观察对象首先要对被观察对象进行注册，通过给被观察对象发送消息 <code>addObserver:forKeyPath:options:context:</code> 。传给的参数是观察者对象，被观察对象属性的键路径（key path）。可选的参数是当改变通知被发送的时候，提供给观察者的指定信息。使用选项 <a href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/Protocols/NSKeyValueObserving_Protocol/index.html#//apple_ref/doc/c_ref/NSKeyValueObservingOptionOld" target="_blank" rel="external">NSKeyValueObservingOptionOld</a> 指定原始对象的值，在变化字典中提供给观察者。<a href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/Protocols/NSKeyValueObserving_Protocol/index.html#//apple_ref/doc/c_ref/NSKeyValueObservingOptionNew" target="_blank" rel="external">NSKeyValueObservingOptionNew</a> 选项，提供新的值。为了收到这两个值，你应该对这两个选项常量使用位或。</p>
<p>清单1的例子演示给 <code>openingBalance</code> 属性注册一个观察者 <code>inspector</code> 对象。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)registerAsObserver &#123;</span><br><span class="line">    <span class="comment">/*</span><br><span class="line">     注册 `inspector` ，来接收 `account` 对象的属性 `openingBalance` </span><br><span class="line">     改变时的通知，并且指定旧值和新值都应该提供给观察者。</span><br><span class="line">     */</span></span><br><span class="line">    [account addObserver:inspector</span><br><span class="line">             forKeyPath:<span class="string">@"openingBalance"</span></span><br><span class="line">                 options:(<span class="built_in">NSKeyValueObservingOptionNew</span> | <span class="built_in">NSKeyValueObservingOptionOld</span>)</span><br><span class="line">                    context:<span class="literal">NULL</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>When you register an object as an observer, you can also provide a context pointer. The context pointer is provided to the observer when observeValueForKeyPath:ofObject:change:context: is invoked. The context pointer can be a C pointer or an object reference. The context pointer can be used as a unique identifier to determine the change that is being observed, or to provide some other data to the observer.</p>
<blockquote>
<p>Note: The key-value observing addObserver:forKeyPath:options:context: method does not maintain strong references to the observing object, the observed objects, or the context. You should ensure that you maintain strong references to the observing, and observed, objects, and the context as necessary.</p>
</blockquote>
<p>注册的时候，也可以提供一个上下文指针（context pointer），当 <code>observeValueForKeyPath:ofObject:change:context:</code> 被调用的时候，context pointer 会被提供给观察者。context pointer 可以是一个 C pointer 或者 一个对象引用。context pointer 可以用作唯一标识符，来确定正在被观察对象的变化，或者提供某些其他数据给观察者。</p>
<blockquote>
<p>注意：键值观察方法 <code>addObserver:forKeyPath:options:context:</code> ，对于观察者对象，被观察的对象或者 context 都不会维持强引用。在必要的时候，你应该自己确保你对于它们维持强引用。</p>
</blockquote>
<h2 id="2-2-Receiving-Notification-of-a-Change-针对改变接收通知"><a href="#2-2-Receiving-Notification-of-a-Change-针对改变接收通知" class="headerlink" title="2.2 Receiving Notification of a Change - 针对改变接收通知"></a>2.2 Receiving Notification of a Change - 针对改变接收通知</h2><p>When the value of an observed property of an object changes, the observer receives an observeValueForKeyPath:ofObject:change:context: message. All observers must implement this method.</p>
<p>The observer is provided the object and key path that triggered the observer notification, a dictionary containing details about the change, and the context pointer that was provided when the observer was registered.</p>
<p>The change dictionary entry NSKeyValueChangeKindKey provides information about the type of change that occurred. If the value of the observed object has changed, the NSKeyValueChangeKindKey entry returns NSKeyValueChangeSetting. Depending on the options specified when the observer was registered, the NSKeyValueChangeOldKey and NSKeyValueChangeNewKey entries in the change dictionary contain the values of the property before, and after, the change. If the property is an object, the value is provided directly. If the property is a scalar or a C structure, the value is wrapped in an NSValue object (as with key-value coding).</p>
<p>If the observed property is a to-many relationship, the NSKeyValueChangeKindKey entry also indicates whether objects in the relationship were inserted, removed, or replaced by returning NSKeyValueChangeInsertion, NSKeyValueChangeRemoval, or NSKeyValueChangeReplacement, respectively.</p>
<p>The change dictionary entry for NSKeyValueChangeIndexesKey is an NSIndexSet object specifying the indexes in the relationship that changed. If NSKeyValueObservingOptionNew or NSKeyValueObservingOptionOld are specified as options when the observer is registered, the NSKeyValueChangeOldKey and NSKeyValueChangeNewKey entries in the change dictionary are arrays containing the values of the related objects before, and after, the change.</p>
<p>The example in Listing 2 shows the observeValueForKeyPath:ofObject:change:context: implementation for an inspector that reflects the old and new values of the property openingBalance, as registered in Listing 1.</p>
<p>当一个改变了被观察对象属性的值，观察者收到消息 <a href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/Protocols/NSKeyValueObserving_Protocol/index.html#//apple_ref/occ/instm/NSObject/observeValueForKeyPath:ofObject:change:context:" target="_blank" rel="external">observeValueForKeyPath:ofObject:change:context:</a> 。所有的观察者必须实现这个方法。</p>
<p>观察者被提供 触发观察者通知的对象和 <code>key path</code> ，就是一个字典，包含了变化和注册时填写的context pointer。</p>
<p>变化字典中 <a href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/Protocols/NSKeyValueObserving_Protocol/index.html#//apple_ref/doc/c_ref/NSKeyValueChangeKindKey" target="_blank" rel="external">NSKeyValueChangeKindKey</a> 提供了关于发生变化的信息。如果被观察对象的值被改变了，<a href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/Protocols/NSKeyValueObserving_Protocol/index.html#//apple_ref/doc/c_ref/NSKeyValueChangeKindKey" target="_blank" rel="external">NSKeyValueChangeKindKey</a> 返回 <a href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/Protocols/NSKeyValueObserving_Protocol/index.html#//apple_ref/doc/c_ref/NSKeyValueChangeSetting" target="_blank" rel="external">NSKeyValueChangeSetting</a> 。根据观察者被注册时指定的选项，NSKeyValueChangeOldKey 和 NSKeyValueChangeNewKey ，在变化字典中包含了属性之前的值以及改变之后的值。如果属性是一个对象，值会被直接提供。如果属性是标量或者C结构体，值会被包含在一个 <code>NSValue</code> 对象中（比如 键值编程）。</p>
<p>如果被观察的属性是一对多的关系（比如数组，集合），NSKeyValueChangeKindKey 也会指定关系中的对象是否被返回的 NSKeyValueChangeInsertion 插入，NSKeyValueChangeRemoval 移除或者 NSKeyValueChangeReplacement 替代。</p>
<p>变化字典的条目 NSKeyValueChangeIndexesKey 是一个 NSIndexSet 对象，指出被改变关系的下标。如果注册的时候 NSKeyValueObservingOptionNew 或者 NSKeyValueObservingOptionOld 被指定为选项，变化字典中 NSKeyValueChangeOldKey 和 NSKeyValueChangeNewKey 就会是数组，包含了相关对象变化之前和之后的值。</p>
<p>清单2的例子演示了 <code>observeValueForKeyPath:ofObject:change:context:</code> 实现</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath</span><br><span class="line">                      ofObject:(<span class="keyword">id</span>)object</span><br><span class="line">                        change:(<span class="built_in">NSDictionary</span> *)change</span><br><span class="line">                       context:(<span class="keyword">void</span> *)context &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> ([keyPath isEqual:<span class="string">@"openingBalance"</span>]) &#123;</span><br><span class="line">        [openingBalanceInspectorField setObjectValue:</span><br><span class="line">            [change objectForKey:<span class="built_in">NSKeyValueChangeNewKey</span>]];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span><br><span class="line">     Be sure to call the superclass's implementation *if it implements it*.</span><br><span class="line">     NSObject does not implement the method.</span><br><span class="line">     */</span></span><br><span class="line">    [<span class="keyword">super</span> observeValueForKeyPath:keyPath</span><br><span class="line">                         ofObject:object</span><br><span class="line">                           change:change</span><br><span class="line">                           context:context];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-3-Removing-an-Object-as-an-Observer-移除对象观察者"><a href="#2-3-Removing-an-Object-as-an-Observer-移除对象观察者" class="headerlink" title="2.3 Removing an Object as an Observer 移除对象观察者"></a>2.3 Removing an Object as an Observer 移除对象观察者</h2><p>You remove a key-value observer by sending the observed object a removeObserver:forKeyPath: message, specifying the observing object and the key path. The example in Listing 3 removes the inspector as an observer of openingBalance.</p>
<p>你可以给被观察对象发送一个消息 <code>removeObserver:forKeyPath:</code> 来移除键值观察，指定观察者对象和 key path 。清单3 的例子移除了 <code>openingBalance</code> 的观察者 inspector 。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)unregisterForChangeNotification &#123;</span><br><span class="line">    [observedObject removeObserver:inspector forKeyPath:<span class="string">@"openingBalance"</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If the context is an object, you must keep a strong reference to it until removing the observer. After receiving a removeObserver:forKeyPath: message, the observing object will no longer receive any observeValueForKeyPath:ofObject:change:context: messages for the specified key path and object.</p>
<p>如果 context 是一个对象，在移除观察者之前你必须对它保持一个强引用。接收到 <code>removeObserver:forKeyPath:</code> 消息后，观察对象将不在接收任何指定 key path 和对象的 <code>observeValueForKeyPath:ofObject:change:context:</code> 消息。</p>
<h1 id="3-KVO-Compliance-KVO-兼容性"><a href="#3-KVO-Compliance-KVO-兼容性" class="headerlink" title="3 KVO Compliance - KVO 兼容性"></a>3 KVO Compliance - KVO 兼容性</h1><p>In order to be considered KVO-compliant for a specific property, a class must ensure the following:</p>
<ul>
<li>The class must be key-value coding compliant for the property, as specified in Ensuring KVC Compliance. KVO supports the same data types as KVC.</li>
<li>The class emits KVO change notifications for the property.</li>
<li>Dependent keys are registered appropriately (see Registering Dependent Keys).</li>
</ul>
<p>There are two techniques for ensuring the change notifications are emitted. Automatic support is provided by NSObject and is by default available for all properties of a class that are key-value coding compliant. Typically, if you follow standard Cocoa coding and naming conventions, you can use automatic change notifications—you don’t have to write any additional code.</p>
<p>Manual change notification provides additional control over when notifications are emitted, and requires additional coding. You can control automatic notifications for properties of your subclass by implementing the class method automaticallyNotifiesObserversForKey:.</p>
<p>考虑到指定属性的 KVO-compliant，类必须确认下面几点：</p>
<ul>
<li>类对于属性必须被键值编程兼容，在 <a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/KeyValueCoding/Articles/Compliant.html#//apple_ref/doc/uid/20002172" target="_blank" rel="external">Ensuring KVC Compliance</a> 中有指出。KVO支持与KVC相同的数据类型。</li>
<li>类对于属性能发出KVO改变通知。</li>
<li>在注册时适当的设置相关的 <code>key</code> （见 <a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/KeyValueObserving/Articles/KVODependentKeys.html#//apple_ref/doc/uid/20002179-BAJEAIEE" target="_blank" rel="external">Registering Dependent Keys</a>）</li>
</ul>
<p>有两种技术确保改变通知被发出。自动支持由 NSObject 提供，并且对于一个类的所有属性键值编程兼容性都是可用的。通常来说，如果遵循标准的Cocoa 编程和命名规范，你就可以使用自动变化通知，不用写任何额外的代码。</p>
<p>手动变化通知在当通知被发出的时候提供了额外的控制，并且需要添加一些代码。你可以通过实现类方法 <a href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/Protocols/NSKeyValueObserving_Protocol/index.html#//apple_ref/occ/clm/NSObject/automaticallyNotifiesObserversForKey:" target="_blank" rel="external">automaticallyNotifiesObserversForKey:</a> 来控制你子类属性的自动通知。</p>
<h2 id="3-1-Automatic-Change-Notification-自动变化通知"><a href="#3-1-Automatic-Change-Notification-自动变化通知" class="headerlink" title="3.1 Automatic Change Notification - 自动变化通知"></a>3.1 Automatic Change Notification - 自动变化通知</h2><p>NSObject provides a basic implementation of automatic key-value change notification. Automatic key-value change notification informs observers of changes made using key-value compliant accessors, as well as the key-value coding methods. Automatic notification is also supported by the collection proxy objects returned by, for example, mutableArrayValueForKey:.</p>
<p>The examples shown in Listing 1 result in any observers of the property name to be notified of the change.</p>
<p>Listing 1  Examples of method calls that cause KVO change notifications to be emitted</p>
<p>NSObject 提供了一个自动键值变化通知的基本实现。自动键值变化通知告知所做改变的观察者使用键值兼容的 accessors，以及键值编程方法。自动通知也被返回的集合代理对象支持，例如 <code>mutableArrayValueForKey:</code>。</p>
<p>清单1的例子展示了改变时，属性名被修改的情况下任何观察者的结果。</p>
<p>清单1，导致发出KVO变化通知的方法调用例子</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Call the accessor method.</span></span><br><span class="line">[account setName:<span class="string">@"Savings"</span>];</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Use setValue:forKey:.</span></span><br><span class="line">[account setValue:<span class="string">@"Savings"</span> forKey:<span class="string">@"name"</span>];</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Use a key path, where 'account' is a kvc-compliant property of 'document'.</span></span><br><span class="line">[document setValue:<span class="string">@"Savings"</span> forKeyPath:<span class="string">@"account.name"</span>];</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Use mutableArrayValueForKey: to retrieve a relationship proxy object.</span></span><br><span class="line">Transaction *newTransaction = &lt;<span class="meta">#Create a new transaction for the account#&gt;;</span></span><br><span class="line"><span class="built_in">NSMutableArray</span> *transactions = [account mutableArrayValueForKey:<span class="string">@"transactions"</span>];</span><br><span class="line">[transactions addObject:newTransaction];</span><br></pre></td></tr></table></figure>
<h2 id="3-2-Manual-Change-Notification-手动变化通知"><a href="#3-2-Manual-Change-Notification-手动变化通知" class="headerlink" title="3.2 Manual Change Notification - 手动变化通知"></a>3.2 Manual Change Notification - 手动变化通知</h2><p>Manual change notification provides more granular control over how and when notifications are sent to observers. This can be useful to help minimize triggering notifications that are unnecessary, or to group a number of changes into a single notification.</p>
<p>A class that implements manual notification must override the NSObject implementation of automaticallyNotifiesObserversForKey:. It is possible to use both automatic and manual observer notifications in the same class. For properties that perform manual notification, the subclass implementation of automaticallyNotifiesObserversForKey: should return NO. A subclass implementation should invoke super for any unrecognized keys. The example in Listing 2 enables manual notification for the openingBalance property allowing the superclass to determine the notification for all other keys.</p>
<p>Listing 2  Example implementation of automaticallyNotifiesObserversForKey:</p>
<p>手动变化通知在当通知被发送给观察者的时候提供了更多精细的控制。对于减少不必要的触发通知，或者一大波变化给一个通知，都很有帮助。</p>
<p>实现手动通知的类必须重写 NSObject 实现的方法 <a href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/Protocols/NSKeyValueObserving_Protocol/index.html#//apple_ref/occ/clm/NSObject/automaticallyNotifiesObserversForKey:" target="_blank" rel="external">automaticallyNotifiesObserversForKey:</a> 。有可能在相同的类中使用自动和手动的观察通知。对于执行手动通知的属性，子类的 <code>automaticallyNotifiesObserversForKey:</code> 方法实现应该返回 NO。子类实现中对于任何为确认的 key，应该调用父类。清单2的例子对于 openingBalance 属性启用了手动通知，允许父类来决定所有其他 key 的通知。</p>
<p>清单2 <code>automaticallyNotifiesObserversForKey:</code>实现的例子</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">BOOL</span>)automaticallyNotifiesObserversForKey:(<span class="built_in">NSString</span> *)theKey &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">BOOL</span> automatic = <span class="literal">NO</span>;</span><br><span class="line">    <span class="keyword">if</span> ([theKey isEqualToString:<span class="string">@"openingBalance"</span>]) &#123;</span><br><span class="line">        automatic = <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        automatic = [<span class="keyword">super</span> automaticallyNotifiesObserversForKey:theKey];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> automatic;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>To implement manual observer notification, you invoke willChangeValueForKey: before changing the value, and didChangeValueForKey: after changing the value. The example in Listing 3 implements manual notifications for the openingBalance property.</p>
<p>Listing 3  Example accessor method implementing manual notification</p>
<p>要实现手动观察通知，在值变化之前要调用 <a href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/Protocols/NSKeyValueObserving_Protocol/index.html#//apple_ref/occ/instm/NSObject/willChangeValueForKey:" target="_blank" rel="external">willChangeValueForKey:</a>，值变化之后要调用 <a href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/Protocols/NSKeyValueObserving_Protocol/index.html#//apple_ref/occ/instm/NSObject/didChangeValueForKey:" target="_blank" rel="external">didChangeValueForKey:</a> 。清单3的例子，对于 openingBalance 属性实现了手动通知。</p>
<p>清单3 accessor 方法实现手动通知的例子</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setOpeningBalance:(<span class="keyword">double</span>)theBalance &#123;</span><br><span class="line">    [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@"openingBalance"</span>];</span><br><span class="line">    _openingBalance = theBalance;</span><br><span class="line">    [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@"openingBalance"</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>You can minimize sending unnecessary notifications by first checking if the value has changed. The example in Listing 4 tests the value of openingBalance and only provides the notification if it has changed.</p>
<p>Listing 4  Testing the value for change before providing notification</p>
<p>你可以先检查值是否改变，来将不必要发送的通知最小化。清单3的例子测试了 openingBalance 的值，并且只提供了如果它改变的通知。</p>
<p>清单4 在通知之前测试值得变化</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setOpeningBalance:(<span class="keyword">double</span>)theBalance &#123;</span><br><span class="line">    <span class="keyword">if</span> (theBalance != _openingBalance) &#123;</span><br><span class="line">        [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@"openingBalance"</span>];</span><br><span class="line">        _openingBalance = theBalance;</span><br><span class="line">        [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@"openingBalance"</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If a single operation causes multiple keys to change you must nest the change notifications as shown in Listing 5.</p>
<p>Listing 5  Nesting change notifications for multiple keys</p>
<p>如果一个操作导致多个 key 的变化，你必须像清单5 一样将变化通知进行嵌套。</p>
<p>清单5 对多个 key 将变化通知嵌套</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setOpeningBalance:(<span class="keyword">double</span>)theBalance &#123;</span><br><span class="line">    [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@"openingBalance"</span>];</span><br><span class="line">    [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@"itemChanged"</span>];</span><br><span class="line">    _openingBalance = theBalance;</span><br><span class="line">    _itemChanged = _itemChanged+<span class="number">1</span>;</span><br><span class="line">    [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@"itemChanged"</span>];</span><br><span class="line">    [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@"openingBalance"</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In the case of an ordered to-many relationship, you must specify not only the key that changed, but also the type of change and the indexes of the objects involved. The type of change is an NSKeyValueChange that specifies NSKeyValueChangeInsertion, NSKeyValueChangeRemoval, or NSKeyValueChangeReplacement. The indexes of the affected objects are passed as an NSIndexSet object.</p>
<p>The code fragment in Listing 6 demonstrates how to wrap a deletion of objects in the to-many relationship transactions.</p>
<p>Listing 6  Implementation of manual observer notification in a to-many relationship</p>
<p>在有序，一对多关系的情况下，你必须指出不仅 key 发生了变化，还要指出变化的类型以及被调用对象的下标。变换的类型是 <a href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/Protocols/NSKeyValueObserving_Protocol/index.html#//apple_ref/c/tdef/NSKeyValueChange" target="_blank" rel="external">NSKeyValueChange</a> ，可以指定 <a href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/Protocols/NSKeyValueObserving_Protocol/index.html#//apple_ref/doc/c_ref/NSKeyValueChangeInsertion" target="_blank" rel="external">NSKeyValueChangeInsertion</a>，<a href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/Protocols/NSKeyValueObserving_Protocol/index.html#//apple_ref/doc/c_ref/NSKeyValueChangeRemoval" target="_blank" rel="external">NSKeyValueChangeRemoval</a>或者 <a href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/Protocols/NSKeyValueObserving_Protocol/index.html#//apple_ref/doc/c_ref/NSKeyValueChangeReplacement" target="_blank" rel="external">NSKeyValueChangeReplacement</a> 。受影响对象的索引作为 NSIndexSet 对象被传递。</p>
<p>清单6 一对多关系的手动观察通知的实现</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)removeTransactionsAtIndexes:(<span class="built_in">NSIndexSet</span> *)indexes &#123;</span><br><span class="line">    [<span class="keyword">self</span> willChange:<span class="built_in">NSKeyValueChangeRemoval</span></span><br><span class="line">        valuesAtIndexes:indexes forKey:<span class="string">@"transactions"</span>];</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Remove the transaction objects at the specified indexes.</span></span><br><span class="line"> </span><br><span class="line">    [<span class="keyword">self</span> didChange:<span class="built_in">NSKeyValueChangeRemoval</span></span><br><span class="line">        valuesAtIndexes:indexes forKey:<span class="string">@"transactions"</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="4-Registering-Dependent-Keys-注册相关-key"><a href="#4-Registering-Dependent-Keys-注册相关-key" class="headerlink" title="4 Registering Dependent Keys - 注册相关 key"></a>4 Registering Dependent Keys - 注册相关 key</h1><p>There are many situations in which the value of one property depends on that of one or more other attributes in another object. If the value of one attribute changes, then the value of the derived property should also be flagged for change. How you ensure that key-value observing notifications are posted for these dependent properties depends on the cardinality of the relationship.</p>
<p>一个属性的值取决于一个或者多个其他对象的属性，有很多种情况。如果一个属性变化，那么派生属性也应该被标记改变。对于这些相关属性依赖于关系的基数，你如果确保通知被发出。</p>
<h2 id="4-1-To-one-Relationships-一对一关系"><a href="#4-1-To-one-Relationships-一对一关系" class="headerlink" title="4.1 To-one Relationships - 一对一关系"></a>4.1 To-one Relationships - 一对一关系</h2><p>To trigger notifications automatically for a to-one relationship you should either override keyPathsForValuesAffectingValueForKey: or implement a suitable method that follows the pattern it defines for registering dependent keys.</p>
<p>For example, the full name of a person is dependent on both the first and last names. A method that returns the full name could be written as follows:</p>
<p>对于一对一关系，为了自动触发通知，你应该重写 <code>keyPathsForValuesAffectingValueForKey:</code> 方法，或者实现一个合适的方法，遵循一种模式，它定义取决于注册相关的key。</p>
<p>例如，一个人的全名依赖于人的姓和名。一个返回全名的方法可以写成下面形式：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSString</span> *)fullName &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@ %@"</span>,firstName, lastName];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>An application observing the fullName property must be notified when either the firstName or lastName properties change, as they affect the value of the property.</p>
<p>One solution is to override keyPathsForValuesAffectingValueForKey: specifying that the fullName property of a person is dependent on the lastName and firstName properties. Listing 1 shows an example implementation of such a dependency:</p>
<p>Listing 1  Example implementation of keyPathsForValuesAffectingValueForKey:</p>
<p>应用观察 fullName 属性，必须注意到当 firstName 或者 lastName 属性变化时，会影响到 fullName属性的值。</p>
<p>一种解决方法是重写 <code>keyPathsForValuesAffectingValueForKey:</code> ，指定人的 fullName 属性依赖于 lastName 和 firstName 属性。清单1 展示了这样一个例子：</p>
<p>清单1 <code>keyPathsForValuesAffectingValueForKey:</code> 的实现例子</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">NSSet</span> *)keyPathsForValuesAffectingValueForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">NSSet</span> *keyPaths = [<span class="keyword">super</span> keyPathsForValuesAffectingValueForKey:key];</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> ([key isEqualToString:<span class="string">@"fullName"</span>]) &#123;</span><br><span class="line">        <span class="built_in">NSArray</span> *affectingKeys = @[<span class="string">@"lastName"</span>, <span class="string">@"firstName"</span>];</span><br><span class="line">        keyPaths = [keyPaths setByAddingObjectsFromArray:affectingKeys];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> keyPaths;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Your override should typically invoke super and return a set that includes any members in the set that result from doing that (so as not to interfere with overrides of this method in superclasses).</p>
<p>You can also achieve the same result by implementing a class method that follows the naming convention keyPathsForValuesAffecting<key>, where <key> is the name of the attribute (first letter capitalized) that is dependent on the values. Using this pattern the code in Listing 1 could be rewritten as a class method named keyPathsForValuesAffectingFullName as shown in Listing 2.</key></key></p>
<p>Listing 2  Example implementation of the keyPathsForValuesAffecting<key> naming convention</key></p>
<p>重写，通常应该调用 super ，并且返回一个 set ，包括这样做的导致结果的任何成员。（在父类中不要因为这个方法的重写造成干扰）。</p>
<p>你也可以通过实现一个类方法达到同样的结果，遵循命名约定 keyPathsForValuesAffecting<key>，<key> 是属性名（首字母大写），依赖于值。清单1中使用这种模式的代码，可以像在清单2中被重写为一个类方法 <code>keyPathsForValuesAffectingFullName</code> 。</key></key></p>
<p>清单2 keyPathsForValuesAffecting<key> 命名约定的实现例子</key></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">NSSet</span> *)keyPathsForValuesAffectingFullName &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSSet</span> setWithObjects:<span class="string">@"lastName"</span>, <span class="string">@"firstName"</span>, <span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>You can’t override the keyPathsForValuesAffectingValueForKey: method when you add a computed property to an existing class using a category, because you’re not supposed to override methods in categories. In that case, implement a matching keyPathsForValuesAffecting<key> class method to take advantage of this mechanism.</key></p>
<blockquote>
<p>Note: You cannot set up dependencies on to-many relationships by implementing keyPathsForValuesAffectingValueForKey:. Instead, you must observe the appropriate attribute of each of the objects in the to-many collection and respond to changes in their values by updating the dependent key yourself. The following section shows a strategy for dealing with this situation.</p>
</blockquote>
<p>当你使用一个 category 给一个现有的类添加一个计算属性的时候，你不能重写 <code>keyPathsForValuesAffectingValueForKey:</code> 方法，因为不允许重写分类（categories）中的方法。这种情况下，实现一个匹配的 <code>keyPathsForValuesAffecting&lt;Key&gt;</code> 类方法，体现了这种机制的优势。</p>
<blockquote>
<p>注意：你不能通过实现 <code>keyPathsForValuesAffectingValueForKey:</code> 方法建立依赖于一对多的关系。相反，你必须观察一对多集合中对象的每个响应属性，并通过更新自己依赖的 key 来响应它们值的变化。下面一节讲了处理这种情况的一种策略。</p>
</blockquote>
<h2 id="4-2-To-many-Relationships-一对多关系"><a href="#4-2-To-many-Relationships-一对多关系" class="headerlink" title="4.2 To-many Relationships - 一对多关系"></a>4.2 To-many Relationships - 一对多关系</h2><p>The keyPathsForValuesAffectingValueForKey: method does not support key-paths that include a to-many relationship. For example, suppose you have a Department object with a to-many relationship (employees) to a Employee, and Employee has a salary attribute. You might want the Department object have a totalSalary attribute that is dependent upon the salaries of all the Employees in the relationship. You can not do this with, for example, keyPathsForValuesAffectingTotalSalary and returning employees.salary as a key.</p>
<p>There are two possible solutions in both situations:</p>
<p>1.You can use key-value observing to register the parent (in this example, Department) as an observer of the relevant attribute of all the children (Employees in this example). You must add and remove the parent as an observer as child objects are added to and removed from the relationship (see Registering for Key-Value Observing). In the observeValueForKeyPath:ofObject:change:context: method you update the dependent value in response to changes, as illustrated in the following code fragment:</p>
<p><code>keyPathsForValuesAffectingValueForKey:</code> 方法不支持包含一对多关系的 key-path。例如，Department 对象有一个一对多的关系 对于 Employee，Employee 有 salary 属性。你希望 Department 对象有一个 totalSalary 属性，这个属性依赖于所有 Employees。你不能像下面这样，<code>keyPathsForValuesAffectingTotalSalary</code> 并且将 employees.salary 作为一个 key 返回。</p>
<p>在两种情况中有两个可能的解决方法：</p>
<p>1.可以使用键值观察注册 parent(例子中就是 Department) 作为所有 children（Employees） 相关属性的观察者。你必须添加和移除 parent 。在 <code>observeValueForKeyPath:ofObject:change:context:</code> 方法中，在响应变化中更新相关的值，就像下面的代码所示：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath ofObject:(<span class="keyword">id</span>)object change:(<span class="built_in">NSDictionary</span> *)change context:(<span class="keyword">void</span> *)context &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (context == totalSalaryContext) &#123;</span><br><span class="line">        [<span class="keyword">self</span> updateTotalSalary];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    <span class="comment">// deal with other observations and/or invoke super...</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">- (<span class="keyword">void</span>)updateTotalSalary &#123;</span><br><span class="line">    [<span class="keyword">self</span> setTotalSalary:[<span class="keyword">self</span> valueForKeyPath:<span class="string">@"employees.@sum.salary"</span>]];</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">- (<span class="keyword">void</span>)setTotalSalary:(<span class="built_in">NSNumber</span> *)newTotalSalary &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (totalSalary != newTotalSalary) &#123;</span><br><span class="line">        [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@"totalSalary"</span>];</span><br><span class="line">        _totalSalary = newTotalSalary;</span><br><span class="line">        [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@"totalSalary"</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">- (<span class="built_in">NSNumber</span> *)totalSalary &#123;</span><br><span class="line">    <span class="keyword">return</span> _totalSalary;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.If you’re using Core Data, you can register the parent with the application’s notification center as an observer of its managed object context. The parent should respond to relevant change notifications posted by the children in a manner similar to that for key-value observing. </p>
<p>2.如果使用Core Data，你可以在应用程序的通知中心注册 parent 作为它管理的对象 context 的观察者。parent 应该响应 与键值观察类似方式被 children 发出的的变化通知。</p>
<h2 id="4-3-Key-Value-Observing-Implementation-Details-键值观察实现细节"><a href="#4-3-Key-Value-Observing-Implementation-Details-键值观察实现细节" class="headerlink" title="4.3 Key-Value Observing Implementation Details - 键值观察实现细节"></a>4.3 Key-Value Observing Implementation Details - 键值观察实现细节</h2><p>Automatic key-value observing is implemented using a technique called isa-swizzling.</p>
<p>The isa pointer, as the name suggests, points to the object’s class which maintains a dispatch table. This dispatch table essentially contains pointers to the methods the class implements, among other data.</p>
<p>When an observer is registered for an attribute of an object the isa pointer of the observed object is modified, pointing to an intermediate class rather than at the true class. As a result the value of the isa pointer does not necessarily reflect the actual class of the instance.</p>
<p>You should never rely on the isa pointer to determine class membership. Instead, you should use the class method to determine the class of an object instance.</p>
<p>自动键值观察是使用一种称为 <code>isa-swizzling</code> 的技术实现。</p>
<p>isa 指针，顾名思义，只想一个对象的类，维持一个调度表。这个调度表基本上包含指向类的方法实现以及其他数据的指针。</p>
<p>当一个观察者被注册，被观察者对象的 isa 指针所指的对象的属性被修改，指的是一个中间的类而不是真正的类。结果就是 isa 指针的值并不一定反映实际类的实例。</p>
<p>你应该永远不要依靠 isa 指针来确定类成员资格。相反，你应该使用 <a href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/Protocols/NSObject_Protocol/index.html#//apple_ref/occ/intfm/NSObject/class" target="_blank" rel="external">class</a> 方法来确定对象实例的类。</p>
<blockquote>
<p>苹果官方文档地址：<a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/KeyValueObserving/KeyValueObserving.html#//apple_ref/doc/uid/10000177-BCICJDHA" target="_blank" rel="external">Key-Value Observing Programming Guide</a></p>
<p>新博客文章地址：<a href="http://yoferzhang.com/post/20160831KVO/">KVO编程指南,Key-Value Observing Programming Guide翻译</a><br>CSDN文章地址：<a href="http://blog.csdn.net/zyq522376829/article/details/52402735" target="_blank" rel="external">KVO编程指南,Key-Value Observing Programming Guide翻译</a></p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoferzhang.com/post/20160830ConcurrencyProgrammingGuide/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Yofer Zhang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="http://ww2.sinaimg.cn/mw690/a9c4d5f6jw1e3siexaeopj.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="YoferZhang 的博客">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="YoferZhang 的博客" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/20160830ConcurrencyProgrammingGuide/" itemprop="url">
                  【iOS】iOS并发编程对比总结,NSThread,NSOperation,GCD
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-08-30T17:41:03+08:00">
                2016-08-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/post/20160830ConcurrencyProgrammingGuide/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="post/20160830ConcurrencyProgrammingGuide/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>版权声明：本文为博主原创，如需转载请注明出处。</p>
</blockquote>
<h2 id="1-多线程概念"><a href="#1-多线程概念" class="headerlink" title="1. 多线程概念"></a>1. 多线程概念</h2><p>进程</p>
<ul>
<li>正在进行中的程序被称为进程，负责程序运行的内存分配</li>
<li>每一个进程都有自己独立的虚拟内存空间</li>
</ul>
<p>线程</p>
<ul>
<li>线程是进程中一个独立的执行路径(控制单元)</li>
<li>一个进程中至少包含一条线程，即主线程</li>
<li>可以将耗时的执行路径(如：网络请求)放在其他线程中执行</li>
</ul>
<p>创建线程的目的就是为了开启一条新的执行路径，运行指定的代码，与主线程中的代码实现同时运行</p>
<center><br><img src="http://ww2.sinaimg.cn/mw690/a9c4d5f6gw1f7bzfmbtm6j210d09eq7t.jpg" alt=""><br></center>

<h3 id="1-1-多任务系统调度示意图"><a href="#1-1-多任务系统调度示意图" class="headerlink" title="1.1 多任务系统调度示意图"></a>1.1 多任务系统调度示意图</h3><center><br><img src="http://ww1.sinaimg.cn/mw690/a9c4d5f6gw1f7c0wop4esj20ro0efwhy.jpg" alt=""><br></center>

<p>说明：每个应用程序由操作系统分配的短暂的时间片(Timeslice)轮流使用CPU，由于CPU对每个时间片的处理速度非常快，因此，用户看来好像这些任务在同时执行的</p>
<p>并发：指两个或多个任务在同一时间间隔内发生，但是，在任意一个时刻点上，CPU只会处理一个任务</p>
<h3 id="1-2-优势、弊端以及误区"><a href="#1-2-优势、弊端以及误区" class="headerlink" title="1.2 优势、弊端以及误区"></a>1.2 优势、弊端以及误区</h3><p>优势</p>
<ul>
<li>充分发挥多核处理器优势，将不同线程任务分配给不同的处理器，真正进入“并行运算”状态</li>
<li>将耗时的任务分配到其他线程执行，由主线程负责统一更新界面会使应用程序更加流畅，用户体验更好</li>
<li>当硬件处理器的数量增加，程序会运行更快，而程序无需做任何调整</li>
</ul>
<p>弊端</p>
<ul>
<li>新建线程会消耗内存空间和CPU时间，线程太多会降低系统的运行性能</li>
</ul>
<p>误区</p>
<ul>
<li>多线程技术是为了并发执行多项任务，不会提高单个算法本身的执行效率</li>
</ul>
<h3 id="1-3-iOS的三种多线程技术"><a href="#1-3-iOS的三种多线程技术" class="headerlink" title="1.3 iOS的三种多线程技术"></a>1.3 iOS的三种多线程技术</h3><p>NSThread</p>
<ul>
<li>使用NSThread对象建立一个线程非常方便</li>
<li>但是！要使用NSThread管理多个线程非常困难，不推荐使用</li>
<li>技巧！使用[NSThread currentThread]跟踪任务所在线程，适用于这三种技术</li>
</ul>
<p>NSOperation/NSOperationQueue</p>
<ul>
<li>是使用GCD实现的一套Objective-C的API</li>
<li>是面向对象的线程技术</li>
<li>提供了一些在GCD中不容易实现的特性，如：限制最大并发数量、操作之间的依赖关系</li>
</ul>
<p>GCD —— Grand Central Dispatch </p>
<ul>
<li>是基于C语言的底层API</li>
<li>用Block定义任务，使用起来非常灵活便捷</li>
<li>提供了更多的控制能力以及操作队列中所不能使用的底层函数</li>
</ul>
<p>提示：iOS的开发者，需要了解三种多线程技术的基本使用，因为在实际开发中会根据实际情况选择不同的多线程技术</p>
<h2 id="2-GCD-Grand-Central-Dispatch"><a href="#2-GCD-Grand-Central-Dispatch" class="headerlink" title="2 GCD - Grand Central Dispatch"></a>2 GCD - Grand Central Dispatch</h2><h3 id="2-1-GCD基本思想"><a href="#2-1-GCD基本思想" class="headerlink" title="2.1 GCD基本思想"></a>2.1 GCD基本思想</h3><p>GCD的基本思想是就将操作s放在队列s中去执行</p>
<ul>
<li>操作使用Blocks定义</li>
<li>队列负责调度任务执行所在的线程以及具体的执行时间</li>
<li>队列的特点是先进先出(FIFO)的，新添加至对列的操作都会排在队尾</li>
</ul>
<p>提示</p>
<ul>
<li>GCD的函数都是以dispatch(分派、调度)开头的</li>
</ul>
<p>队列<code>dispatch_queue_t</code></p>
<ul>
<li>串行队列，队列中的任务只会顺序执行</li>
<li>并行队列，队列中的任务通常会并发执行</li>
</ul>
<p>操作</p>
<ul>
<li><code>dispatch_async</code> 异步操作，会并发执行，无法确定任务的执行顺序</li>
<li><code>dispatch_sync</code> 同步操作，会依次顺序执行，能够决定任务的执行顺序</li>
</ul>
<p>注：</p>
<ul>
<li>队列不是线程？也不表示对应的CPU</li>
<li>队列就是负责调度的!谁空闲，就把任务给谁！</li>
<li>多线程技术的目的，就是为了在一个CPU上实现快速切换！</li>
</ul>
<h3 id="2-2-串行队列"><a href="#2-2-串行队列" class="headerlink" title="2.2 串行队列"></a>2.2 串行队列</h3><center><br><img src="http://ww2.sinaimg.cn/mw690/a9c4d5f6gw1f7c1snqhqcj223817mb29.jpg" alt=""><br></center>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#pragma mark - 串行（一个接一个，排队跑步，保持队形）队列</span></span><br><span class="line">- (<span class="keyword">void</span>)gcdDemo1</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 将操作放在队列中</span></span><br><span class="line">    <span class="comment">// 在C语言函数中，定义类型，绝大多数的结尾是_t或者ref</span></span><br><span class="line">    <span class="comment">// 使用串行队列，的异步任务非常非常非常有用！新建子线程是有开销的，不能无休止新建线程</span></span><br><span class="line">    <span class="comment">// 即可以保证效率（新建一个子线程），用能够实现并发</span></span><br><span class="line">    <span class="comment">// 应用案例：</span></span><br><span class="line">    <span class="comment">// 1&gt; 从网络上上下载图片</span></span><br><span class="line">    <span class="comment">// 2&gt; 滤镜（高光，红眼...）</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> q = dispatch_queue_create(<span class="string">"com.yoferzhang.gcddemo"</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 非ARC开发时，千万别忘记release</span></span><br><span class="line"><span class="comment">//    dispatch_release(q);</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 串行行队列的同步任务，同样会在主线程上运行</span></span><br><span class="line">    <span class="comment">// 提示：在开发中极少用d</span></span><br><span class="line">    <span class="comment">// 面试中有可能会问！</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i) &#123;</span><br><span class="line">        <span class="comment">// 同步任务顺序执行</span></span><br><span class="line">        <span class="built_in">dispatch_sync</span>(q, ^&#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"%@ %d"</span>, [<span class="built_in">NSThread</span> currentThread], i);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i) &#123;</span><br><span class="line">        <span class="comment">// 异步任务，并发执行，但是如果在串行队列中，仍然会依次顺序执行</span></span><br><span class="line">        <span class="built_in">dispatch_async</span>(q, ^&#123;</span><br><span class="line">            <span class="comment">// [NSThread currentThread] 可以在开发中，跟踪当前线程</span></span><br><span class="line">            <span class="comment">// num = 1，表示主线程</span></span><br><span class="line">            <span class="comment">// num = 2，表示第2个子线程。。。</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"%@ %d"</span>, [<span class="built_in">NSThread</span> currentThread], i);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-3-并行队列"><a href="#2-3-并行队列" class="headerlink" title="2.3 并行队列"></a>2.3 并行队列</h3><center><br><img src="http://ww3.sinaimg.cn/mw690/a9c4d5f6gw1f7c2280muvj223m15ab29.jpg" alt=""><br></center>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#pragma mark - 并行（并排跑，类似于赛跑）</span></span><br><span class="line">- (<span class="keyword">void</span>)gcdDemo2</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 特点：没有队形，执行顺序程序员不能控制！</span></span><br><span class="line">    <span class="comment">// 应用场景：并发执行任务，没有先后顺序关系</span></span><br><span class="line">    <span class="comment">// 并行队列容易出错！并行队列不能控制新建线程的数量！</span></span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> q = dispatch_queue_create(<span class="string">"com.yoferzhang.gcd2"</span>, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">    </span><br><span class="line"><span class="comment">//    for (int i = 0; i &lt; 10; ++i) &#123;</span></span><br><span class="line"><span class="comment">//        // 异步任务</span></span><br><span class="line"><span class="comment">//        dispatch_async(q, ^&#123;</span></span><br><span class="line"><span class="comment">//            // [NSThread currentThread] 可以在开发中，跟踪当前线程</span></span><br><span class="line"><span class="comment">//            // num = 1，表示主线程</span></span><br><span class="line"><span class="comment">//            // num = 2，表示第2个子线程。。。</span></span><br><span class="line"><span class="comment">//            NSLog(@"%@ %d", [NSThread currentThread], i);</span></span><br><span class="line"><span class="comment">//        &#125;);</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i) &#123;</span><br><span class="line">        <span class="comment">// 同步任务顺序执行</span></span><br><span class="line">        <span class="built_in">dispatch_sync</span>(q, ^&#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"%@ %d"</span>, [<span class="built_in">NSThread</span> currentThread], i);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-4-全局队列"><a href="#2-4-全局队列" class="headerlink" title="2.4 全局队列"></a>2.4 全局队列</h3><center><br><img src="http://ww2.sinaimg.cn/mw690/a9c4d5f6gw1f7c242thitj220614mb29.jpg" alt=""><br></center>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#pragma mark - 全局队列（苹果为了方便多线程的设计，提供一个全局队列，供所有的APP共同使用）</span></span><br><span class="line">- (<span class="keyword">void</span>)gcdDemo3</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 全局队列与并行队列的区别</span></span><br><span class="line">    <span class="comment">// 1&gt; 不需要创建，直接GET就能用</span></span><br><span class="line">    <span class="comment">// 2&gt; 两个队列的执行效果相同</span></span><br><span class="line">    <span class="comment">// 3&gt; 全局队列没有名称，调试时，无法确认准确队列</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 记住：在开发中永远用DISPATCH_QUEUE_PRIORITY_DEFAULT</span></span><br><span class="line">    <span class="comment">// 多线程的优先级反转！低优先级的线程阻塞了高优先级的线程！</span></span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> q =dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i) &#123;</span><br><span class="line">        <span class="comment">// 同步任务顺序执行</span></span><br><span class="line">        <span class="built_in">dispatch_sync</span>(q, ^&#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"%@ %d"</span>, [<span class="built_in">NSThread</span> currentThread], i);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i) &#123;</span><br><span class="line">        <span class="comment">// 异步任务，并发执行，但是如果在穿行队列中，仍然会依次顺序执行</span></span><br><span class="line">        <span class="built_in">dispatch_async</span>(q, ^&#123;</span><br><span class="line">            <span class="comment">// [NSThread currentThread] 可以在开发中，跟踪当前线程</span></span><br><span class="line">            <span class="comment">// num = 1，表示主线程</span></span><br><span class="line">            <span class="comment">// num = 2，表示第2个子线程。。。</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"%@ %d"</span>, [<span class="built_in">NSThread</span> currentThread], i);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-5-主队列"><a href="#2-5-主队列" class="headerlink" title="2.5 主队列"></a>2.5 主队列</h3><center><br><img src="http://ww2.sinaimg.cn/mw690/a9c4d5f6gw1f7c26453v8j2210188hdt.jpg" alt=""><br></center>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#pragma mark - 主(线程)队列，保证操作在主线程上执行</span></span><br><span class="line">- (<span class="keyword">void</span>)gcdDemo4</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 每一个应用程序都只有一个主线程</span></span><br><span class="line">    <span class="comment">// 为什么需要在主线程上工作呢？</span></span><br><span class="line">    <span class="comment">// 在iOS开发中，所有UI的更新工作，都必须在主线程上执行！</span></span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> q = dispatch_get_main_queue();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 主线程是由工作的，而且除非将程序杀掉，否则主线程的工作永远不会结束！</span></span><br><span class="line">    <span class="comment">// 阻塞了！！！</span></span><br><span class="line">    <span class="built_in">dispatch_sync</span>(q, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"come here baby!"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 异步任务，在主线程上运行，同时是保持队形的</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i) &#123;</span><br><span class="line">        <span class="built_in">dispatch_async</span>(q, ^&#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"%@ - %d"</span>, [<span class="built_in">NSThread</span> currentThread], i);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-6-不同队列中嵌套dispatch-sync的结果"><a href="#2-6-不同队列中嵌套dispatch-sync的结果" class="headerlink" title="2.6 不同队列中嵌套dispatch_sync的结果"></a>2.6 不同队列中嵌套dispatch_sync的结果</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 全局队列，都在主线程上执行，不会死锁</span></span><br><span class="line"><span class="built_in">dispatch_queue_t</span> q = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// 并行队列，都在主线程上执行，不会死锁</span></span><br><span class="line"><span class="built_in">dispatch_queue_t</span> q = dispatch_queue_create(<span class="string">"com.yoferzhang.gcddemo"</span>, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line"><span class="comment">// 串行队列，会死锁，但是会执行嵌套同步操作之前的代码</span></span><br><span class="line"><span class="built_in">dispatch_queue_t</span> q = dispatch_queue_create(<span class="string">"com.yoferzhang.gcddemo"</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line"><span class="comment">// 直接死锁</span></span><br><span class="line"><span class="built_in">dispatch_queue_t</span> q = dispatch_get_main_queue();</span><br><span class="line"></span><br><span class="line"><span class="built_in">dispatch_sync</span>(q, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"同步任务 %@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">    <span class="built_in">dispatch_sync</span>(q, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"同步任务 %@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="2-7-dispatch-sync的应用场景"><a href="#2-7-dispatch-sync的应用场景" class="headerlink" title="2.7 dispatch_sync的应用场景"></a>2.7 dispatch_sync的应用场景</h3><ul>
<li>阻塞并行队列的执行，要求某一操作执行后再进行后续操作，如用户登录</li>
<li>确保块代码之外的局部变量确实被修改</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_queue_t</span> q = dispatch_queue_create(<span class="string">"com.yoferzhang.gcddemo"</span>, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">__block <span class="built_in">BOOL</span> logon = <span class="literal">NO</span>;</span><br><span class="line"><span class="built_in">dispatch_sync</span>(q, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"模拟耗时操作 %@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">      [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2.0</span>f];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"模拟耗时完成 %@"</span>, [<span class="built_in">NSThread</span> currentThread]); </span><br><span class="line">    logon = <span class="literal">YES</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">dispatch_async</span>(q, ^&#123;</span><br><span class="line">       <span class="built_in">NSLog</span>(<span class="string">@"登录完成的处理 %@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2.0</span>f];</span><br><span class="line"></span><br><span class="line">通常在多线程调试中用于模拟耗时操作</span><br><span class="line">在发布的应用程序中，不要使用此方法！</span><br></pre></td></tr></table></figure>
<h3 id="2-8-GCD——大中央调度"><a href="#2-8-GCD——大中央调度" class="headerlink" title="2.8 GCD——大中央调度"></a>2.8 GCD——大中央调度</h3><ul>
<li>串行队列，同步任务，不需要新建线程</li>
<li><p>串行队列，异步任务，需要一个子线程，线程的创建和回收不需要程序员参与！“是最安全的一个选择”串行队列只能创建！</p>
</li>
<li><p>并行队列，同步任务，不需要创建线程</p>
</li>
<li>并行队列，异步任务，有多少个任务，就开N个线程执行，</li>
</ul>
<p>无论什么队列和什么任务，线程的创建和回收不需要程序员参与。<br>线程的创建回收工作是由队列负责的</p>
<p>“并发”编程，为了让程序员从负责的线程控制中解脱出来！只需要面对队列和任务！</p>
<h3 id="2-9-GCD阶段性小结"><a href="#2-9-GCD阶段性小结" class="headerlink" title="2.9 GCD阶段性小结"></a>2.9 GCD阶段性小结</h3><p>GCD</p>
<ul>
<li>通过GCD，开发者不用再直接跟线程打交道，只需要向队列中添加代码块即可</li>
<li>GCD在后端管理着一个线程池，GCD不仅决定着代码块将在哪个线程被执行，它还根据可用的系统资源对这些线程进行管理。从而让开发者从线程管理的工作中解放出来，通过集中的管理线程，缓解大量线程被创建的问题</li>
<li>使用GCD，开发者可以将工作考虑为一个队列，而不是一堆线程，这种并行的抽象模型更容易掌握和使用</li>
</ul>
<p>GCD的队列</p>
<ul>
<li>GCD公开有5个不同的队列：运行在主线程中的主队列，3 个不同优先级的后台队列，以及一个优先级更低的后台队列（用于 I/O）</li>
<li>自定义队列：串行和并行队列。自定义队列非常强大，建议在开发中使用。在自定义队列中被调度的所有Block最终都将被放入到系统的全局队列中和线程池中</li>
<li>提示：不建议使用不同优先级的队列，因为如果设计不当，可能会出现优先级反转，即低优先级的操作阻塞高优先级的操作</li>
</ul>
<h3 id="2-10-GCD队列示意图"><a href="#2-10-GCD队列示意图" class="headerlink" title="2.10 GCD队列示意图"></a>2.10 GCD队列示意图</h3><center><br><img src="http://ww2.sinaimg.cn/mw690/a9c4d5f6gw1f7c2dj8c6cj21110lbjvb.jpg" alt=""><br></center>

<h2 id="3-NSOperation"><a href="#3-NSOperation" class="headerlink" title="3 NSOperation"></a>3 NSOperation</h2><h3 id="3-1-NSOperation-amp-NSOperationQueue"><a href="#3-1-NSOperation-amp-NSOperationQueue" class="headerlink" title="3.1 NSOperation &amp; NSOperationQueue"></a>3.1 NSOperation &amp; NSOperationQueue</h3><p>简介</p>
<ul>
<li>NSOperationQueue(操作队列)是由GCD提供的队列模型的Cocoa抽象，是一套Objective-C的API</li>
<li>GCD提供了更加底层的控制，而操作队列则在GCD之上实现了一些方便的功能，这些功能对于开发者而言通常是最好最安全的选择<br>队列及操作</li>
</ul>
<p>NSOperationQueue有两种不同类型的队列：主队列和自定义队列</p>
<p>主队列运行在主线程上</p>
<p>自定义队列在后台执行</p>
<p>队列处理的任务是NSOperation的子类</p>
<ul>
<li>NSInvocationOperation</li>
<li>NSBlockOperation</li>
</ul>
<h3 id="3-2-NSOperation的基本使用步骤"><a href="#3-2-NSOperation的基本使用步骤" class="headerlink" title="3.2 NSOperation的基本使用步骤"></a>3.2 NSOperation的基本使用步骤</h3><p>基本使用步骤</p>
<ul>
<li>定义操作队列</li>
<li>定义操作</li>
<li>将操作添加到队列</li>
</ul>
<p>提示：一旦将操作添加到队列，操作就会立即被调度执行</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#pragma mark NSBlockOperation</span></span><br><span class="line">- (<span class="keyword">void</span>)demoOp1</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//    NSBlockOperation *block = [NSBlockOperation blockOperationWithBlock:^&#123;</span></span><br><span class="line"><span class="comment">//        NSLog(@"%@", [NSThread currentThread]);</span></span><br><span class="line"><span class="comment">//    &#125;];</span></span><br><span class="line"><span class="comment">//    </span></span><br><span class="line">    <span class="comment">// 所有的自定义队列，都是在子线程中运行</span></span><br><span class="line"><span class="comment">//    [self.myQueue addOperation:block];</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 新建线程是有开销的</span></span><br><span class="line">    <span class="comment">// 在设定同时并发的最大线程数时，如果前一个线程工作完成，但是还没有销毁，会新建线程</span></span><br><span class="line">    <span class="comment">// 应用场景：网络开发中，下载工作！（线程开销：CPU,MEM）电量！</span></span><br><span class="line">    <span class="comment">// 如果是3G，开3个子线程</span></span><br><span class="line">    <span class="comment">// 如果是WIFI，开6个子线程</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i) &#123;</span><br><span class="line">        [<span class="keyword">self</span>.myQueue addOperationWithBlock:^&#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"%@ %d"</span>, [<span class="built_in">NSThread</span> currentThread], i);</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 在主线程中执行</span></span><br><span class="line"><span class="comment">//    [[NSOperationQueue mainQueue] addOperationWithBlock:^&#123;</span></span><br><span class="line"><span class="comment">//        NSLog(@"%@", [NSThread currentThread]);</span></span><br><span class="line"><span class="comment">//    &#125;];</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-3-NSInvocationOperation-调度操作"><a href="#3-3-NSInvocationOperation-调度操作" class="headerlink" title="3.3 NSInvocationOperation(调度操作)"></a>3.3 NSInvocationOperation(调度操作)</h3><p>定义队列</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self</span>.myQueue = [[<span class="built_in">NSOperationQueue</span> alloc] init];</span><br></pre></td></tr></table></figure>
<p>操作调用的方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)operationAction:(<span class="keyword">id</span>)obj</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@ - obj : %@"</span>, [<span class="built_in">NSThread</span> currentThread], obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定义操作并添加到队列</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSInvocationOperation</span> *op = [[<span class="built_in">NSInvocationOperation</span> alloc] initWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(operationAction:) object:@(i)];</span><br><span class="line">[<span class="keyword">self</span>.myQueue addOperation:op];</span><br></pre></td></tr></table></figure>
<p>小结：需要准备一个被调度的方法，并且能够接收一个参数</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#pragma mark NSInvocationOP</span></span><br><span class="line">- (<span class="keyword">void</span>)demoOp2</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 需要定义一个方法，能够接收一个参数</span></span><br><span class="line">    <span class="comment">// 是用起来不够灵活</span></span><br><span class="line">    <span class="built_in">NSInvocationOperation</span> *op = [[<span class="built_in">NSInvocationOperation</span> alloc] initWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(demoOp:) object:<span class="string">@"hello op"</span>];</span><br><span class="line">    </span><br><span class="line"><span class="comment">//    [self.myQueue addOperation:op];</span></span><br><span class="line">    </span><br><span class="line">    [[<span class="built_in">NSOperationQueue</span> mainQueue] addOperation:op];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-4-设置操作的依赖关系"><a href="#3-4-设置操作的依赖关系" class="headerlink" title="3.4 设置操作的依赖关系"></a>3.4 设置操作的依赖关系</h3><p>提示：利用addDependency可以指定操作之间的彼此依赖关系(执行先后顺序)</p>
<p>注意：不要出现循环依赖！</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#pragma mark - NSOperation方法</span></span><br><span class="line"><span class="meta">#pragma mark 设置任务的执行顺序</span></span><br><span class="line">- (<span class="keyword">void</span>)demoOp3</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSBlockOperation</span> *op1 = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"下载图片 %@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">    &#125;];</span><br><span class="line">    <span class="built_in">NSBlockOperation</span> *op2 = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"修饰图片 %@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">    &#125;];</span><br><span class="line">    <span class="built_in">NSBlockOperation</span> *op3 = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"保存图片 %@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">    &#125;];</span><br><span class="line">    <span class="built_in">NSBlockOperation</span> *op4 = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"更新UI %@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设定执行顺序, Dependency依赖，可能会开多个，但不会太多</span></span><br><span class="line">    <span class="comment">// 依赖关系是可以跨队列的！</span></span><br><span class="line">    [op2 addDependency:op1];</span><br><span class="line">    [op3 addDependency:op2];</span><br><span class="line">    [op4 addDependency:op3];</span><br><span class="line">    <span class="comment">// GCD是串行队列，异步任务，只会开一个线程</span></span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.myQueue addOperation:op1];</span><br><span class="line">    [<span class="keyword">self</span>.myQueue addOperation:op2];</span><br><span class="line">    [<span class="keyword">self</span>.myQueue addOperation:op3];</span><br><span class="line">    <span class="comment">// 所有UI的更新需要在主线程上进行</span></span><br><span class="line">    [[<span class="built_in">NSOperationQueue</span> mainQueue] addOperation:op4];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-5-设置同时并发的线程数量"><a href="#3-5-设置同时并发的线程数量" class="headerlink" title="3.5 设置同时并发的线程数量"></a>3.5 设置同时并发的线程数量</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">self</span>.myQueue setMaxConcurrentOperationCount:<span class="number">2</span>];</span><br><span class="line"><span class="comment">// 设置同时并发的线程数量能够有效地降低CPU和内存的开销</span></span><br><span class="line"><span class="comment">// 这一功能用GCD不容易实现</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i) &#123;</span><br><span class="line">    <span class="built_in">NSBlockOperation</span> *op = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</span><br><span class="line">        [<span class="keyword">self</span> operationAction:@(i)];</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.myQueue addOperation:op];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-6-NSOperation小结"><a href="#3-6-NSOperation小结" class="headerlink" title="3.6 NSOperation小结"></a>3.6 NSOperation小结</h3><p>从本质上来看，操作队列的性能会比GCD略低，不过，大多数情况下这点负面影响可以忽略不计，操作队列是并发编程的首选工具</p>
<p>AFN，底层用GCD开发，开发的接口是NSOperation的。</p>
<h2 id="4-Run-Loop"><a href="#4-Run-Loop" class="headerlink" title="4 Run Loop"></a>4 Run Loop</h2><ul>
<li>Run Loop提供了一种异步执行代码的机制，不能并行执行任务</li>
<li>在主队列中，Main Run Loop直接配合任务的执行，负责处理UI事件、计时器，以及其它内核相关事件</li>
<li>Run Loop的主要目的是保证程序执行的线程不会被系统终止</li>
</ul>
<p>Run Loop的工作特点</p>
<ul>
<li>当有事件发生时，Run Loop会根据具体的事件类型通知应用程序做出响应</li>
<li>当没有事件发生时，Run Loop会进入休眠状态，从而达到省电的目的</li>
<li>当事件再次发生时，Run Loop会被重新唤醒，处理事件</li>
<li>主线程和其他线程中的Run Loop</li>
</ul>
<p>iOS程序的主线程默认已经配置好了Run Loop</p>
<p>其他线程默认情况下没有设置Run Loop</p>
<p>一般在开发中很少会主动创建RunLoop，而通常会把事件添加到RunLoop中</p>
<h3 id="4-1-RunLoop示意图"><a href="#4-1-RunLoop示意图" class="headerlink" title="4.1 RunLoop示意图"></a>4.1 RunLoop示意图</h3><center><br><img src="http://ww4.sinaimg.cn/mw690/a9c4d5f6gw1f7c2mzokvvj21sq15u7wh.jpg" alt=""><br></center>

<h3 id="4-2-UIApplication中的Run-Loop"><a href="#4-2-UIApplication中的Run-Loop" class="headerlink" title="4.2 UIApplication中的Run Loop"></a>4.2 UIApplication中的Run Loop</h3><center><br><img src="http://ww4.sinaimg.cn/mw690/a9c4d5f6gw1f7c2oiph4xj21110lb11g.jpg" alt=""><br></center>

<h3 id="4-3-多线程中的循环引用"><a href="#4-3-多线程中的循环引用" class="headerlink" title="4.3 多线程中的循环引用"></a>4.3 多线程中的循环引用</h3><p>如果self对象持有操作对象的引用，同时操作对象当中又直接访问了self时，才会造成循环引用</p>
<p>单纯在操作对象中使用self不会造成循环引用</p>
<p>注意：此时不能使用(weakSelf)</p>
<h2 id="5-资源共享"><a href="#5-资源共享" class="headerlink" title="5 资源共享"></a>5 资源共享</h2><h3 id="5-1-多线程中的资源共享"><a href="#5-1-多线程中的资源共享" class="headerlink" title="5.1 多线程中的资源共享"></a>5.1 多线程中的资源共享</h3><p>并发编程中许多问题的根源就是在多线程中访问共享资源。资源可以是一个属性、一个对象、网络设备或者一个文件等</p>
<p>在多线程中任何一个共享的资源都可能是一个潜在的冲突点，必须精心设计以防止这种冲突的发生</p>
<h3 id="5-2-资源共享示例"><a href="#5-2-资源共享示例" class="headerlink" title="5.2 资源共享示例"></a>5.2 资源共享示例</h3><center><br><img src="http://ww1.sinaimg.cn/mw690/a9c4d5f6gw1f7c2r17clmj20x80ihmz8.jpg" alt=""><br></center>

<h3 id="5-3-互斥锁-synchronized"><a href="#5-3-互斥锁-synchronized" class="headerlink" title="5.3 互斥锁(@synchronized)"></a>5.3 互斥锁(@synchronized)</h3><center><br><img src="http://ww2.sinaimg.cn/mw690/a9c4d5f6gw1f7c2rpwk1fj21040m6ju3.jpg" alt=""><br></center>

<h3 id="5-4-共享资源小结"><a href="#5-4-共享资源小结" class="headerlink" title="5.4 共享资源小结"></a>5.4 共享资源小结</h3><ul>
<li>为了保证性能，atomic仅针对属性的setter方法做了保护</li>
<li>而争抢共享资源时，如果涉及到属性的getter方法，可以使用互斥锁@synchronized可以保证属性在多个线程之间的读写都是安全的</li>
<li>无论是atomic还是@synchronized，使用的代价都是高昂的</li>
</ul>
<p>建议：多线程是并发执行多个任务提高效率的，如果可能，应该在线程中避免争抢共享资源</p>
<p>正是出于性能的考虑，UIKit中的绝大多数的类都不是线程安全的，因此，苹果公司要求：更新UI相关的操作，应该在主线程中执行</p>
<p>取舍！</p>
<h2 id="6单例"><a href="#6单例" class="headerlink" title="6单例"></a>6单例</h2><ul>
<li>单例模式是一种常用的软件设计模式</li>
<li>通过单例模式可以保证系统中一个类只有一个实例而且该实例易于外界访问，从而方便对实例个数的控制并节约系统资源</li>
<li>如果希望系统中某个类的对象只能存在一个，单例模式是最好的解决方案</li>
</ul>
<p>iOS中最常见的单例就是UIApplication </p>
<p>应用场景：</p>
<ul>
<li>音频播放，背景音乐！</li>
<li>硬件资源：加速器、[UIScreen mainScreen]</li>
</ul>
<p>sharedXX, mainXXX</p>
<h3 id="6-1-单例的实现步骤"><a href="#6-1-单例的实现步骤" class="headerlink" title="6.1 单例的实现步骤"></a>6.1 单例的实现步骤</h3><p>重写allocWithZone方法</p>
<p>allocWithZone方法是对象分配内存空间时，最终会调用的方法，重写该方法，保证只会分配一个内存空间</p>
<p>建立sharedXXX类方法，便于其他类访问</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">DemoObj</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 共享实例，便于其他类访问</span></span><br><span class="line">+ (instancetype)sharedDemoObj;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"DemoObj.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">DemoObj</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> DemoObj *instance;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> 1. 重写allocWithZone，用dispatch_once实例化一个静态变量</span><br><span class="line"> 2. 写一个+sharedXXX方便其他类调用</span><br><span class="line"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 在iOS中，所有对象的内存空间的分配，最终都会调用allocWithZone方法</span></span><br><span class="line"><span class="comment">// 如果要做单例，需要重写此方法</span></span><br><span class="line"><span class="comment">// GCD提供了一个方法，专门用来创建单例的</span></span><br><span class="line">+ (<span class="keyword">id</span>)allocWithZone:(<span class="keyword">struct</span> _<span class="built_in">NSZone</span> *)zone</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">static</span> DemoObj *instance;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// dispatch_once是线程安全的，onceToken默认为0</span></span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="comment">// dispatch_once宏可以保证块代码中的指令只被执行一次</span></span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        <span class="comment">// 在多线程环境下，永远只会被执行一次，instance只会被实例化一次</span></span><br><span class="line">        instance = [<span class="keyword">super</span> allocWithZone:zone];</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (instancetype)sharedDemoObj</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 如果有两个线程同时实例化，很有可能创建出两个实例来</span></span><br><span class="line"><span class="comment">//    if (!instance) &#123;</span></span><br><span class="line"><span class="comment">//        // thread 1 0x0000A</span></span><br><span class="line"><span class="comment">//        // thread 2 0x0000B</span></span><br><span class="line"><span class="comment">//        instance = [[self alloc] init];</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"><span class="comment">//    // 第一个线程返回的指针已经被修改！</span></span><br><span class="line"><span class="comment">//    return instance;</span></span><br><span class="line">    <span class="keyword">return</span> [[<span class="keyword">self</span> alloc] init];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h3 id="6-2-单例小结"><a href="#6-2-单例小结" class="headerlink" title="6.2 单例小结"></a>6.2 单例小结</h3><p>优点</p>
<ul>
<li>可以阻止其他对象实例化单例对象的副本，从而确保所有对象都访问唯一实例</li>
</ul>
<p>缺点</p>
<ul>
<li>单例对象一旦建立，对象指针是保存在静态区的，单例对象在堆中分配的内存空间，会在应用程序终止后才会被释放</li>
</ul>
<p>提示</p>
<ul>
<li>只有确实需要唯一使用的对象才需要考虑单例模式，不要滥用单例</li>
</ul>
<h2 id="7-NSThread"><a href="#7-NSThread" class="headerlink" title="7 NSThread"></a>7 NSThread</h2><h3 id="7-1-NSObject的多线程方法"><a href="#7-1-NSObject的多线程方法" class="headerlink" title="7.1 NSObject的多线程方法"></a>7.1 NSObject的多线程方法</h3><p>开启后台执行任务的方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)performSelectorInBackground:(SEL)aSelector withObject:(<span class="keyword">id</span>)arg</span><br></pre></td></tr></table></figure>
<p>在后台线程中通知主线程执行任务的方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)performSelectorOnMainThread:(SEL)aSelector withObject:(<span class="keyword">id</span>)arg waitUntilDone:(<span class="built_in">BOOL</span>)wait</span><br></pre></td></tr></table></figure>
<p>获取线程信息<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">NSThread</span> currentThread]</span><br></pre></td></tr></table></figure></p>
<p>线程休眠</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2.0</span>f];</span><br></pre></td></tr></table></figure>
<p>特点</p>
<ul>
<li>使用简单，量级轻</li>
<li>不能控制线程的数量以及执行顺序</li>
</ul>
<h3 id="7-2-NSObject的多线程方法注意事项"><a href="#7-2-NSObject的多线程方法注意事项" class="headerlink" title="7.2 NSObject的多线程方法注意事项"></a>7.2 NSObject的多线程方法注意事项</h3><p>NSObject的多线程方法使用的是NSThread的多线程技术</p>
<p>而NSThread的多线程技术不会自动使用@autoreleasepool</p>
<p>在使用NSObject或NSThread的多线程技术时，如果涉及到对象分配，需要手动添加@autoreleasepool</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"ViewController.h"</span></span></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> 需求分析</span><br><span class="line"> </span><br><span class="line"> 1. UIImageView显示图片</span><br><span class="line"> 2. UIImage模拟从网络上下载</span><br><span class="line"> 3. NSString记录图片路径</span><br><span class="line"> </span><br><span class="line"> 小结</span><br><span class="line"> </span><br><span class="line"> 方法，看起来很简单，</span><br><span class="line"> </span><br><span class="line"> 1&gt; 不能够自动回收线程，如果并发数量多，会建立大量的子线程！</span><br><span class="line"> 2&gt; 使用NSThread的线程，不会自动添加autoreleasepool</span><br><span class="line"> </span><br><span class="line">    意味着，如果在后台线程方法中，</span><br><span class="line"> </span><br><span class="line"> @autoreleasepool &#123;&#125; 自动释放池</span><br><span class="line"> </span><br><span class="line"> 主线程中是有自动释放池的，使用GCD和NSOperation也会自动添加自动释放池</span><br><span class="line"> </span><br><span class="line"> NSThread和NSObject不会，如果在后台线程中创建了autorelease的对象，需要使用自动释放池，否则会出现内存泄漏！</span><br><span class="line"> </span><br><span class="line"> 工作原理：</span><br><span class="line"> </span><br><span class="line"> 1. 当自动释放池被销毁或者“耗尽”时，对池中的所有对象发送release消息，清空自动释放池</span><br><span class="line"> 2. 所有autorelease的对象，在出了作用域之后，会自动添加到【最近一次创建的自动释放池中】自动释放池中</span><br><span class="line"> </span><br><span class="line"> 在ARC中，编译器在编译过程中，会自动根据代码结构，添加retain和release。</span><br><span class="line"> */</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIImageView</span> *imageView;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIImage</span> *image;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSString</span> *imagePath;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 0. 模拟使用图像路径加载图片</span></span><br><span class="line">- (<span class="keyword">void</span>)setImagePath:(<span class="built_in">NSString</span> *)imagePath</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1&gt; 模拟下载，延时</span></span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">1.0</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2&gt; 设置图像，苹果底层允许使用performSelectorInBackground方法</span></span><br><span class="line">        <span class="comment">// 在后台线程更新UI，强烈不建议大家这么做！</span></span><br><span class="line">        <span class="comment">// YES会阻塞住线程，直到调用方法完成</span></span><br><span class="line">        <span class="comment">// NO不会阻塞线程，会继续执行</span></span><br><span class="line">        [<span class="keyword">self</span> performSelectorOnMainThread:<span class="keyword">@selector</span>(setImage:) withObject:[<span class="built_in">UIImage</span> imageNamed:imagePath] waitUntilDone:<span class="literal">NO</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 图像</span></span><br><span class="line">- (<span class="keyword">void</span>)setImage:(<span class="built_in">UIImage</span> *)image</span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.imageView.image = image;</span><br><span class="line">    </span><br><span class="line"><span class="comment">//    [NSThread sleepForTimeInterval:1.0];</span></span><br><span class="line">    <span class="comment">// 根据图片自动调整大小</span></span><br><span class="line">    [<span class="keyword">self</span>.imageView sizeToFit];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 创建imageView</span></span><br><span class="line">- (<span class="built_in">UIImageView</span> *)imageView</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!_imageView) &#123;</span><br><span class="line">        _imageView = [[<span class="built_in">UIImageView</span> alloc] init];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> _imageView;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:<span class="keyword">self</span>.imageView];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 在后台线程执行这段代码即可</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">50</span>; ++i) &#123;</span><br><span class="line">        [<span class="keyword">self</span> performSelectorInBackground:<span class="keyword">@selector</span>(setImagePath:) withObject:<span class="string">@"头像1.png"</span>];</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//    [self setImagePath: @"头像1.png"];</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)demo</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 提问：代码存在什么问题？如果循环次数非常大，会出现什么问题？应该如何修改？</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 解决办法1：如果i比较大，可以</span></span><br><span class="line">    <span class="comment">// 解决方法2：如果非常大，一次循环都会造成自动释放池被填满</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000000</span>; ++i) &#123;</span><br><span class="line">        <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">            <span class="comment">// *</span></span><br><span class="line">            <span class="built_in">NSString</span> *str = <span class="string">@"Hello World!"</span>;</span><br><span class="line">            <span class="comment">// new *</span></span><br><span class="line">            str = [str uppercaseString];</span><br><span class="line">            <span class="comment">// new *</span></span><br><span class="line">            str = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@ %d"</span>, str, i];</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, str);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>参考文章：<br><a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/Multithreading/Introduction/Introduction.html#//apple_ref/doc/uid/10000057i-CH1-SW1" target="_blank" rel="external">Threading Programming Guide</a><br><a href="https://developer.apple.com/library/ios/documentation/General/Conceptual/ConcurrencyProgrammingGuide/Introduction/Introduction.html#//apple_ref/doc/uid/TP40008091-CH1-SW1" target="_blank" rel="external">Concurrency Programming Guide</a></p>
<p>新博客文章地址：<a href="http://yoferzhang.com/post/20160830ConcurrencyProgrammingGuide/">iOS并发编程对比总结,NSThread,NSOperation,GCD</a><br>CSDN文章地址：<a href="http://blog.csdn.net/zyq522376829/article/details/52373154" target="_blank" rel="external">iOS并发编程对比总结,NSThread,NSOperation,GCD</a></p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoferzhang.com/post/20160829Quartz2D/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Yofer Zhang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="http://ww2.sinaimg.cn/mw690/a9c4d5f6jw1e3siexaeopj.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="YoferZhang 的博客">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="YoferZhang 的博客" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/20160829Quartz2D/" itemprop="url">
                  【iOS】Quartz2D
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-08-29T19:40:06+08:00">
                2016-08-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/post/20160829Quartz2D/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="post/20160829Quartz2D/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoferzhang.com/post/20160825property/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Yofer Zhang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="http://ww2.sinaimg.cn/mw690/a9c4d5f6jw1e3siexaeopj.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="YoferZhang 的博客">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="YoferZhang 的博客" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/20160825property/" itemprop="url">
                  【iOS】property属性的weak,strong,copy,assign
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-08-25T16:55:48+08:00">
                2016-08-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/post/20160825property/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="post/20160825property/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>@property属性的用法</p>
<ul>
<li>weak(assign) :  代理\UI控件</li>
<li>strong(retain) : 其他对象(除代理\UI控件\字符串以外的对象)</li>
<li>copy : 字符串</li>
<li>assign : 非对象类型(基本数据类型int\float\BOOL\枚举\结构体)</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoferzhang.com/post/20160824Contacts/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Yofer Zhang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="http://ww2.sinaimg.cn/mw690/a9c4d5f6jw1e3siexaeopj.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="YoferZhang 的博客">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="YoferZhang 的博客" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/20160824Contacts/" itemprop="url">
                  【iOS】私人通讯录Demo
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-08-24T16:14:59+08:00">
                2016-08-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/post/20160824Contacts/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="post/20160824Contacts/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Github地址：<a href="https://github.com/yoferzhang/PersonalContacts-" target="_blank" rel="external">PersonalContacts</a></p>
<h2 id="私人通讯录"><a href="#私人通讯录" class="headerlink" title="私人通讯录"></a>私人通讯录</h2><h3 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h3><p>本 Demo 简单演示了一些小控件的应用。</p>
<ul>
<li>比如导航栏的设置；</li>
<li>界面全部是代码写的，没有用stroyboard。</li>
<li>UITextField，UILabel，UIButton等小控件的精确控制；</li>
<li>页面之间的数据传输；</li>
<li>数据的本地化存储；</li>
<li>UITableView 的添加删除Cell</li>
<li>在系统提供样式的Cell中代码添加自定义View</li>
<li>利用第三方控件模拟网络请求等待，就是转菊花</li>
</ul>
<h3 id="简单演示"><a href="#简单演示" class="headerlink" title="简单演示"></a>简单演示</h3><center><br><img src="http://ww1.sinaimg.cn/mw690/a9c4d5f6gw1f74wg7775tg20dc0o54qs.gif" alt=""><br></center>

<center><br><img src="http://ww2.sinaimg.cn/mw690/a9c4d5f6gw1f74wg3rbw8g20dc0o5e82.gif" alt=""><br></center>

<center><br><img src="http://ww4.sinaimg.cn/mw690/a9c4d5f6gw1f74wg1374dg20dc0o5qv7.gif" alt=""><br></center>

<center><br><img src="http://ww2.sinaimg.cn/mw690/a9c4d5f6gw1f74wfxumj5g20dc0o57wj.gif" alt=""><br></center>


<h3 id="运行环境"><a href="#运行环境" class="headerlink" title="运行环境"></a>运行环境</h3><p>运行环境为 Xcode 7.3，iOS 9.3</p>
<p>工程中用了cocoapods，工程入口为根目录下：PersonalContacts02.xcworkspace</p>
<h3 id="流水账"><a href="#流水账" class="headerlink" title="流水账"></a>流水账</h3><p>下面只是简单记录了一些代码生成的过程和思想：</p>
<p>AppDelegate.m</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"AppDelegate.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"HomeViewController.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AppDelegate</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">AppDelegate</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)application:(<span class="built_in">UIApplication</span> *)application didFinishLaunchingWithOptions:(<span class="built_in">NSDictionary</span> *)launchOptions &#123;</span><br><span class="line">    <span class="comment">// Override point for customization after application launch.</span></span><br><span class="line">    </span><br><span class="line">    HomeViewController *homeViewController = [[HomeViewController alloc] init];</span><br><span class="line">    <span class="built_in">UINavigationController</span> *mainNavigationController = [[<span class="built_in">UINavigationController</span> alloc] initWithRootViewController:homeViewController];</span><br><span class="line">    <span class="keyword">self</span>.window = [[<span class="built_in">UIWindow</span> alloc] initWithFrame:[[<span class="built_in">UIScreen</span> mainScreen] bounds]];</span><br><span class="line">    <span class="keyword">self</span>.window.rootViewController = mainNavigationController;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.window.backgroundColor = [<span class="built_in">UIColor</span> whiteColor];</span><br><span class="line">    [<span class="keyword">self</span>.window makeKeyAndVisible];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>HomeViewController.m</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    <span class="comment">// Do any additional setup after loading the view.</span></span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span> setNavigationBar];</span><br><span class="line">    [<span class="keyword">self</span> drawLabelAndText];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - 设置导航栏</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setNavigationBar</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">self</span>.navigationItem.title = <span class="string">@"私人通讯录"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - 绘制登录界面</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)drawLabelAndText</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">CGFloat</span> accountLabelX = <span class="keyword">self</span>.view.bounds.size.width / <span class="number">10.0</span>;</span><br><span class="line">    <span class="built_in">CGFloat</span> accountLabelY = <span class="number">64</span> + <span class="keyword">self</span>.view.bounds.size.width / <span class="number">10.0</span>;</span><br><span class="line">    <span class="built_in">CGFloat</span> accountLabelW = accountLabelX;</span><br><span class="line">    <span class="built_in">CGFloat</span> accountLabelH = <span class="number">20</span>;</span><br><span class="line">    <span class="built_in">UILabel</span> *accountLabel = [[<span class="built_in">UILabel</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(accountLabelX, accountLabelY, accountLabelW, accountLabelH)];</span><br><span class="line">    accountLabel.text = <span class="string">@"账号"</span>;</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:accountLabel];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGFloat</span> passwordLabelX = accountLabelX;</span><br><span class="line">    <span class="built_in">CGFloat</span> passwordLabelY = accountLabelY + accountLabelH + <span class="number">20</span>;</span><br><span class="line">    <span class="built_in">CGFloat</span> passwordLabelW = accountLabelW;</span><br><span class="line">    <span class="built_in">CGFloat</span> passwordLabelH = accountLabelH;</span><br><span class="line">    <span class="built_in">UILabel</span> *passwordLabel = [[<span class="built_in">UILabel</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(passwordLabelX, passwordLabelY, passwordLabelW, passwordLabelH)];</span><br><span class="line">    passwordLabel.text = <span class="string">@"密码"</span>;</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:passwordLabel];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGFloat</span> accountTextFieldX = accountLabelX + accountLabelW + <span class="number">40</span>;</span><br><span class="line">    <span class="built_in">CGFloat</span> accountTextFieldY = accountLabelY;</span><br><span class="line">    <span class="built_in">CGFloat</span> accountTextFieldW = <span class="keyword">self</span>.view.bounds.size.width / <span class="number">2.0</span>;</span><br><span class="line">    <span class="built_in">CGFloat</span> accountTextFieldH = accountLabelH;</span><br><span class="line">    <span class="built_in">UITextField</span> *accountTextField = [[<span class="built_in">UITextField</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(accountTextFieldX, accountTextFieldY, accountTextFieldW, accountTextFieldH)];</span><br><span class="line">    accountTextField.placeholder = <span class="string">@"请输入账号(*)"</span>;</span><br><span class="line">    <span class="comment">// 监听通知</span></span><br><span class="line">    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(textChange) name:<span class="built_in">UITextFieldTextDidChangeNotification</span> object:accountTextField];</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:accountTextField];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGFloat</span> passwordTextFieldX = accountTextFieldX;</span><br><span class="line">    <span class="built_in">CGFloat</span> passwordTextFieldY = passwordLabelY;</span><br><span class="line">    <span class="built_in">CGFloat</span> passwordTextFieldW = accountTextFieldW;</span><br><span class="line">    <span class="built_in">CGFloat</span> passwordTextFieldH = accountLabelH;</span><br><span class="line">    <span class="built_in">UITextField</span> *passwordTextField = [[<span class="built_in">UITextField</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(passwordTextFieldX, passwordTextFieldY, passwordTextFieldW, passwordTextFieldH)];</span><br><span class="line">    passwordTextField.placeholder = <span class="string">@"请输入密码(*)"</span>;</span><br><span class="line">    <span class="comment">// 监听通知</span></span><br><span class="line">    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(textChange) name:<span class="built_in">UITextFieldTextDidChangeNotification</span> object:passwordTextField];</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:passwordTextField];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGFloat</span> remeberPasswordLabelX = accountLabelX;</span><br><span class="line">    <span class="built_in">CGFloat</span> remeberPasswordLabelY = passwordLabelY + passwordLabelH + <span class="number">25</span>;</span><br><span class="line">    <span class="built_in">CGFloat</span> remeberPasswordLabelW = passwordLabelW + <span class="number">40</span>;</span><br><span class="line">    <span class="built_in">CGFloat</span> remeberPasswordLabelH = accountLabelH;</span><br><span class="line">    <span class="built_in">UILabel</span> *remeberPasswordLabel = [[<span class="built_in">UILabel</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(remeberPasswordLabelX, remeberPasswordLabelY, remeberPasswordLabelW, remeberPasswordLabelH)];</span><br><span class="line">    remeberPasswordLabel.text = <span class="string">@"记住密码"</span>;</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:remeberPasswordLabel];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGFloat</span> remeberPasswordSwitchX = remeberPasswordLabelX + remeberPasswordLabelW;</span><br><span class="line">    <span class="built_in">CGFloat</span> remeberPasswordSwitchY = passwordLabelY + passwordLabelH + <span class="number">20</span>;</span><br><span class="line">    <span class="built_in">CGFloat</span> remeberPasswordSwitchW = remeberPasswordLabelW;</span><br><span class="line">    <span class="built_in">CGFloat</span> remeberPasswordSwitchH = accountLabelH;</span><br><span class="line">    <span class="built_in">UISwitch</span> *remeberPasswordSwitch = [[<span class="built_in">UISwitch</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(remeberPasswordSwitchX, remeberPasswordSwitchY, remeberPasswordSwitchW, remeberPasswordSwitchH)];</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:remeberPasswordSwitch];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGFloat</span> automaticLogonLabelX = remeberPasswordSwitchX + remeberPasswordSwitchW;</span><br><span class="line">    <span class="built_in">CGFloat</span> automaticLogonLabelY = passwordLabelY + passwordLabelH + <span class="number">25</span>;</span><br><span class="line">    <span class="built_in">CGFloat</span> automaticLogonLabelW = passwordLabelW + <span class="number">40</span>;</span><br><span class="line">    <span class="built_in">CGFloat</span> automaticLogonLabelH = accountLabelH;</span><br><span class="line">    <span class="built_in">UILabel</span> *automaticLogonLabel = [[<span class="built_in">UILabel</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(automaticLogonLabelX, automaticLogonLabelY, automaticLogonLabelW, automaticLogonLabelH)];</span><br><span class="line">    automaticLogonLabel.text = <span class="string">@"自动登录"</span>;</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:automaticLogonLabel];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGFloat</span> automaticLogonSwitchX = automaticLogonLabelX + automaticLogonLabelW;</span><br><span class="line">    <span class="built_in">CGFloat</span> automaticLogonSwitchY = passwordLabelY + passwordLabelH + <span class="number">20</span>;</span><br><span class="line">    <span class="built_in">CGFloat</span> automaticLogonSwitchW = remeberPasswordLabelW;</span><br><span class="line">    <span class="built_in">CGFloat</span> automaticLogonSwitchH = accountLabelH;</span><br><span class="line">    <span class="built_in">UISwitch</span> *automaticLogonSwitch = [[<span class="built_in">UISwitch</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(automaticLogonSwitchX, automaticLogonSwitchY, automaticLogonSwitchW, automaticLogonSwitchH)];</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:automaticLogonSwitch];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGFloat</span> logButtonX = <span class="keyword">self</span>.view.bounds.size.width / <span class="number">2.0</span> - <span class="number">40</span>;</span><br><span class="line">    <span class="built_in">CGFloat</span> logButtonY = remeberPasswordLabelY + <span class="number">40</span>;</span><br><span class="line">    <span class="built_in">CGFloat</span> logButtonW = <span class="number">80</span>;</span><br><span class="line">    <span class="built_in">CGFloat</span> logButtonH = accountLabelH;</span><br><span class="line">    <span class="built_in">UIButton</span> *logButton = [[<span class="built_in">UIButton</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(logButtonX, logButtonY, logButtonW, logButtonH)];</span><br><span class="line">    [logButton setTitle:<span class="string">@"登录"</span> forState:<span class="built_in">UIControlStateNormal</span>];</span><br><span class="line">    [logButton setTitleColor:[<span class="built_in">UIColor</span> blueColor] forState:<span class="built_in">UIControlStateNormal</span>];</span><br><span class="line">    [logButton setTitleShadowColor:[<span class="built_in">UIColor</span> grayColor] forState:<span class="built_in">UIControlStateNormal</span>];</span><br><span class="line">    [logButton addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(pushToContactsViewController) forControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>];</span><br><span class="line">    [logButton setEnabled:<span class="literal">YES</span>];</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:logButton];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - 登录按钮响应事件方法</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)pushToContactsViewController</span><br><span class="line">&#123;</span><br><span class="line">    ContactsViewController *contactsViewController = [[ContactsViewController alloc] init];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.navigationController pushViewController:contactsViewController animated:<span class="literal">YES</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 记得移除监听</span></span><br><span class="line">- (<span class="keyword">void</span>)dealloc &#123;</span><br><span class="line">    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] removeObserver:<span class="keyword">self</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>添加属性：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HomeViewController</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="built_in">UIButton</span> *logButton;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>记得将button赋值</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">    [<span class="keyword">self</span>.view addSubview:logButton];</span><br><span class="line">    <span class="keyword">self</span>.logButton = logButton;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line"> * 文本框的文字发生改变的时候调用</span><br><span class="line"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)textChange</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">self</span>.logButton.enabled = (<span class="keyword">self</span>.accountTextField.text.length &amp;&amp; <span class="keyword">self</span>.passwordTextField.text.length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将添加事件响应拿出来放到单独的方法中：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#pragma mark - 添加文本框和按钮的响应事件，或者通知</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)addTarget</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 监听通知</span></span><br><span class="line">    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(textChange) name:<span class="built_in">UITextFieldTextDidChangeNotification</span> object:<span class="keyword">self</span>.accountTextField];</span><br><span class="line">    <span class="comment">// 监听通知</span></span><br><span class="line">    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(textChange) name:<span class="built_in">UITextFieldTextDidChangeNotification</span> object:<span class="keyword">self</span>.passwordTextField];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 登录按钮添加响应事件</span></span><br><span class="line">    [<span class="keyword">self</span>.logButton addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(pushToContactsViewController) forControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 给开关添加响应方法</span></span><br><span class="line">    [<span class="keyword">self</span>.remeberPasswordSwitch addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(remeberPasswordChange) forControlEvents:<span class="built_in">UIControlEventValueChanged</span>];</span><br><span class="line">    [<span class="keyword">self</span>.automaticLogonSwitch addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(automaticLogonChange) forControlEvents:<span class="built_in">UIControlEventValueChanged</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完成两个方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)remeberPasswordChange</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.remeberPasswordSwitch.isOn == <span class="literal">NO</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.automaticLogonSwitch.on = <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)automaticLogonChange</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.automaticLogonSwitch.isOn) &#123;</span><br><span class="line">        <span class="keyword">self</span>.remeberPasswordSwitch.on = <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ContactsViewController.m</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> *  点击注销是弹出警告窗口</span><br><span class="line"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)logout:(<span class="keyword">id</span>)sender</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">UIAlertController</span> *alert = [<span class="built_in">UIAlertController</span> alertControllerWithTitle:<span class="string">@"确定要注销？"</span> message:<span class="string">@"注销将无法查看您的联系人"</span> preferredStyle:<span class="built_in">UIAlertControllerStyleActionSheet</span>];</span><br><span class="line">    <span class="built_in">UIAlertAction</span>* okAction = [<span class="built_in">UIAlertAction</span> actionWithTitle:<span class="string">@"确定"</span> style:<span class="built_in">UIAlertActionStyleDestructive</span></span><br><span class="line">                                                          handler:^(<span class="built_in">UIAlertAction</span> * action) &#123;</span><br><span class="line">                                                              [<span class="keyword">self</span>.navigationController popViewControllerAnimated:<span class="literal">YES</span>];</span><br><span class="line">                                                          &#125;];</span><br><span class="line">    <span class="built_in">UIAlertAction</span>* cancelAction = [<span class="built_in">UIAlertAction</span> actionWithTitle:<span class="string">@"取消"</span> style:<span class="built_in">UIAlertActionStyleCancel</span></span><br><span class="line">                                                         handler:^(<span class="built_in">UIAlertAction</span> * action) &#123;&#125;];</span><br><span class="line">    [alert addAction:okAction];</span><br><span class="line">    [alert addAction:cancelAction];</span><br><span class="line">    [<span class="keyword">self</span> presentViewController:alert animated:<span class="literal">YES</span> completion:<span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>HomeViewController.m</p>
<p>使用第三方库 SVProgressHUD</p>
<p>然后重新写登录按钮的响应方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)pushToContactsViewController</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (![<span class="keyword">self</span>.accountTextField.text isEqualToString:<span class="string">@"yofer"</span>]) &#123;</span><br><span class="line">        <span class="comment">// 账号不存在</span></span><br><span class="line">        [SVProgressHUD showErrorWithStatus:<span class="string">@"账号不存在"</span>];</span><br><span class="line">        dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="number">0.7</span> * <span class="built_in">NSEC_PER_SEC</span>)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">            [SVProgressHUD dismiss];</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (![<span class="keyword">self</span>.passwordTextField.text isEqualToString:<span class="string">@"666"</span>]) &#123;</span><br><span class="line">        <span class="comment">// 密码错误</span></span><br><span class="line">        [SVProgressHUD showErrorWithStatus:<span class="string">@"密码错误"</span>];</span><br><span class="line">        dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="number">0.7</span> * <span class="built_in">NSEC_PER_SEC</span>)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">            [SVProgressHUD dismiss];</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    [SVProgressHUD showWithStatus:<span class="string">@"正在加载..."</span>]; <span class="comment">// 这是转菊花的样式</span></span><br><span class="line">    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="number">1.5</span> * <span class="built_in">NSEC_PER_SEC</span>)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        [SVProgressHUD dismiss];</span><br><span class="line">        ContactsViewController *contactsViewController = [[ContactsViewController alloc] init];</span><br><span class="line">        contactsViewController.title = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@的联系人列表"</span>, <span class="keyword">self</span>.accountTextField.text];</span><br><span class="line">        [<span class="keyword">self</span>.navigationController pushViewController:contactsViewController animated:<span class="literal">YES</span>];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>更改一下开关的关闭打开，设置动画</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)remeberPasswordChange</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.remeberPasswordSwitch.isOn == <span class="literal">NO</span>) &#123;</span><br><span class="line"><span class="comment">//        self.automaticLogonSwitch.on = NO;</span></span><br><span class="line">        [<span class="keyword">self</span>.automaticLogonSwitch setOn:<span class="literal">NO</span> animated:<span class="literal">YES</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)automaticLogonChange</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.automaticLogonSwitch.isOn) &#123;</span><br><span class="line"><span class="comment">//        self.remeberPasswordSwitch.on = YES;</span></span><br><span class="line">        [<span class="keyword">self</span>.remeberPasswordSwitch setOn:<span class="literal">YES</span> animated:<span class="literal">YES</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AddViewController.m</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"AddViewController.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AddViewController</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">AddViewController</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    <span class="comment">// Do any additional setup after loading the view.</span></span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span> setNavigation];</span><br><span class="line">    [<span class="keyword">self</span> drawLabel];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setNavigation</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">self</span>.view.backgroundColor = [<span class="built_in">UIColor</span> whiteColor];</span><br><span class="line">    <span class="keyword">self</span>.navigationItem.title = <span class="string">@"添加联系人"</span>;</span><br><span class="line"><span class="comment">//    [self.navigationItem.leftBarButtonItem setTitle:@"返回"];</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)drawLabel</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">CGFloat</span> nameLabelX = <span class="keyword">self</span>.view.bounds.size.width / <span class="number">10.0</span>;</span><br><span class="line">    <span class="built_in">CGFloat</span> nameLabelY = <span class="number">64</span> + <span class="keyword">self</span>.view.bounds.size.width / <span class="number">10.0</span>;</span><br><span class="line">    <span class="built_in">CGFloat</span> nameLabelW = nameLabelX;</span><br><span class="line">    <span class="built_in">CGFloat</span> nameLabelH = <span class="number">20</span>;</span><br><span class="line">    <span class="built_in">UILabel</span> *nameLabel = [[<span class="built_in">UILabel</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(nameLabelX, nameLabelY, nameLabelW, nameLabelH)];</span><br><span class="line">    nameLabel.text = <span class="string">@"姓名"</span>;</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:nameLabel];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGFloat</span> numberLabelX = nameLabelX;</span><br><span class="line">    <span class="built_in">CGFloat</span> numberLabelY = nameLabelY + nameLabelH + <span class="number">20</span>;</span><br><span class="line">    <span class="built_in">CGFloat</span> numberLabelW = nameLabelW;</span><br><span class="line">    <span class="built_in">CGFloat</span> numberLabelH = nameLabelH;</span><br><span class="line">    <span class="built_in">UILabel</span> *numberLabel = [[<span class="built_in">UILabel</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(numberLabelX, numberLabelY, numberLabelW, numberLabelH)];</span><br><span class="line">    numberLabel.text = <span class="string">@"电话"</span>;</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:numberLabel];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGFloat</span> nameTextFieldX = nameLabelX + nameLabelW + <span class="number">40</span>;</span><br><span class="line">    <span class="built_in">CGFloat</span> nameTextFieldY = nameLabelY;</span><br><span class="line">    <span class="built_in">CGFloat</span> nameTextFieldW = <span class="keyword">self</span>.view.bounds.size.width / <span class="number">2.0</span>;</span><br><span class="line">    <span class="built_in">CGFloat</span> nameTextFieldH = nameLabelH;</span><br><span class="line">    <span class="built_in">UITextField</span> *nameTextField = [[<span class="built_in">UITextField</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(nameTextFieldX, nameTextFieldY, nameTextFieldW, nameTextFieldH)];</span><br><span class="line">    nameTextField.placeholder = <span class="string">@"请输入姓名(*)"</span>;</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:nameTextField];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGFloat</span> numberTextFieldX = nameTextFieldX;</span><br><span class="line">    <span class="built_in">CGFloat</span> numberTextFieldY = numberLabelY;</span><br><span class="line">    <span class="built_in">CGFloat</span> numberTextFieldW = nameTextFieldW;</span><br><span class="line">    <span class="built_in">CGFloat</span> numberTextFieldH = nameLabelH;</span><br><span class="line">    <span class="built_in">UITextField</span> *numberTextField = [[<span class="built_in">UITextField</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(numberTextFieldX, numberTextFieldY, numberTextFieldW, numberTextFieldH)];</span><br><span class="line">    numberTextField.placeholder = <span class="string">@"请输入电话(*)"</span>;</span><br><span class="line">    numberTextField.keyboardType = <span class="built_in">UIKeyboardTypeNumberPad</span>;</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:numberTextField];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">CGFloat</span> addButtonX = <span class="keyword">self</span>.view.bounds.size.width / <span class="number">2.0</span> - <span class="number">60</span>;</span><br><span class="line">    <span class="built_in">CGFloat</span> addButtonY = numberTextFieldY + <span class="number">40</span>;</span><br><span class="line">    <span class="built_in">CGFloat</span> addButtonW = <span class="number">120</span>;</span><br><span class="line">    <span class="built_in">CGFloat</span> addButtonH = nameLabelH;</span><br><span class="line">    <span class="built_in">UIButton</span> *addButton = [[<span class="built_in">UIButton</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(addButtonX, addButtonY, addButtonW, addButtonH)];</span><br><span class="line">    [addButton setTitle:<span class="string">@"登录"</span> forState:<span class="built_in">UIControlStateNormal</span>];</span><br><span class="line">    [addButton setTitleColor:[<span class="built_in">UIColor</span> blueColor] forState:<span class="built_in">UIControlStateNormal</span>];</span><br><span class="line">    [addButton setEnabled:<span class="literal">NO</span>];</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:addButton];</span><br><span class="line">    <span class="keyword">self</span>.addButton = addButton;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>修改 ContactsViewController.m 中的方法，将下一个视图的左上角按钮设置为返回</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)pushToAddViewController</span><br><span class="line">&#123;</span><br><span class="line">    AddViewController *addViewController = [[AddViewController alloc] init];</span><br><span class="line">    <span class="built_in">UIBarButtonItem</span> *backItem = [[<span class="built_in">UIBarButtonItem</span> alloc] initWithTitle:<span class="string">@"返回"</span> style:<span class="built_in">UIBarButtonItemStylePlain</span> target:<span class="literal">nil</span> action:<span class="literal">nil</span>];</span><br><span class="line">    <span class="keyword">self</span>.navigationItem.backBarButtonItem = backItem;</span><br><span class="line">    [<span class="keyword">self</span>.navigationController pushViewController:addViewController animated:<span class="literal">YES</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了已进入添加界面，就弹出键盘，在 AddViewController.m 中</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewWillAppear:(<span class="built_in">BOOL</span>)animated &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewWillAppear:<span class="literal">YES</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 让文本框成为第一响应者</span></span><br><span class="line">    [<span class="keyword">self</span>.nameTextField becomeFirstResponder];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>添加代理，回传值</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;UIKit/UIKit.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@class</span> <span class="title">Contact</span>, <span class="title">AddViewController</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">AddViewControllerDelegate</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@optional</span></span><br><span class="line">- (<span class="keyword">void</span>)addViewController:(AddViewController *)addViewController addContact:(Contact *)contact;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AddViewController</span> : <span class="title">UIViewController</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="keyword">id</span>&lt;AddViewControllerDelegate&gt; delegate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>AddViewController.m 中</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#pragma mark - 调用 AddViewControllerDelegate 代理方法</span></span><br><span class="line">- (<span class="keyword">void</span>)addContacts</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 回传数据</span></span><br><span class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span>.delegate respondsToSelector:<span class="keyword">@selector</span>(addViewController:addContact:)]) &#123;</span><br><span class="line">        Contact *contact = [[Contact alloc] init];</span><br><span class="line">        contact.name = <span class="keyword">self</span>.nameTextField.text;</span><br><span class="line">        contact.number = <span class="keyword">self</span>.numberTextField.text;</span><br><span class="line">        [<span class="keyword">self</span>.delegate addViewController:<span class="keyword">self</span> addContact:contact];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.navigationController popViewControllerAnimated:<span class="literal">YES</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ContactsViewController.m</p>
<p>添加代理</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ContactsViewController</span> () &lt;<span class="title">UIActionSheetDelegate</span>, <span class="title">AddViewControllerDelegate</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableArray</span> *contacts;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>设置代理</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)pushToAddViewController</span><br><span class="line">&#123;</span><br><span class="line">    AddViewController *addViewController = [[AddViewController alloc] init];</span><br><span class="line">    addViewController.delegate = <span class="keyword">self</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置addViewController页面左上角的返回按钮文字</span></span><br><span class="line">    <span class="built_in">UIBarButtonItem</span> *backItem = [[<span class="built_in">UIBarButtonItem</span> alloc] initWithTitle:<span class="string">@"返回"</span> style:<span class="built_in">UIBarButtonItemStylePlain</span> target:<span class="literal">nil</span> action:<span class="literal">nil</span>];</span><br><span class="line">    <span class="keyword">self</span>.navigationItem.backBarButtonItem = backItem;</span><br><span class="line">    [<span class="keyword">self</span>.navigationController pushViewController:addViewController animated:<span class="literal">YES</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#pragma mark - 实现 AddViewControllerDelegate 代理方法</span></span><br><span class="line">- (<span class="keyword">void</span>)addViewController:(AddViewController *)addViewController addContact:(Contact *)contact</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">self</span>.contacts addObject:contact];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.tableView reloadData];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - TableView 数据源和代理方法</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSInteger</span>)tableView:(<span class="built_in">UITableView</span> *)tableView numberOfRowsInSection:(<span class="built_in">NSInteger</span>)section &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.contacts.count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">UITableViewCell</span> *)tableView:(<span class="built_in">UITableView</span> *)tableView cellForRowAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">NSString</span> *identifier = <span class="string">@"cell"</span>;</span><br><span class="line">    <span class="built_in">UITableViewCell</span> *cell = [tableView dequeueReusableCellWithIdentifier:identifier];</span><br><span class="line">    <span class="keyword">if</span> (!cell) &#123;</span><br><span class="line">        cell = [[<span class="built_in">UITableViewCell</span> alloc] initWithStyle:<span class="built_in">UITableViewCellStyleValue1</span> reuseIdentifier:identifier];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置Cell数据</span></span><br><span class="line">    Contact *contact = <span class="keyword">self</span>.contacts[indexPath.row];</span><br><span class="line">    cell.textLabel.text = contact.name;</span><br><span class="line">    cell.detailTextLabel.text = contact.number;</span><br><span class="line">    cell.accessoryType = <span class="built_in">UITableViewCellAccessoryDisclosureIndicator</span>;</span><br><span class="line">    <span class="keyword">return</span> cell;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>EditViewController.h</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;UIKit/UIKit.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@class</span> <span class="title">Contact</span>, <span class="title">EditViewController</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">EditViewControllerDelegate</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@optional</span></span><br><span class="line">- (<span class="keyword">void</span>)editViewController:(EditViewController *)editViewController addContact:(Contact *)contact;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">EditViewController</span> : <span class="title">UIViewController</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) Contact *contact;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="keyword">id</span>&lt;EditViewControllerDelegate&gt; delegate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>EditViewController.m</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"EditViewController.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"Contact.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">EditViewController</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UITextField</span> *nameTextField;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UITextField</span> *numberTextField;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIButton</span> *saveButton;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">EditViewController</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    <span class="comment">// Do any additional setup after loading the view.</span></span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span> setNavigation];</span><br><span class="line">    [<span class="keyword">self</span> drawLabel];</span><br><span class="line">    [<span class="keyword">self</span> addTarget];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//- (void)viewWillAppear:(BOOL)animated &#123;</span></span><br><span class="line"><span class="comment">//    [super viewWillAppear:YES];</span></span><br><span class="line"><span class="comment">//    </span></span><br><span class="line"><span class="comment">//    // 让文本框成为第一响应者</span></span><br><span class="line"><span class="comment">//    [self.nameTextField becomeFirstResponder];</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setNavigation</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">self</span>.view.backgroundColor = [<span class="built_in">UIColor</span> whiteColor];</span><br><span class="line">    <span class="keyword">self</span>.navigationItem.title = <span class="string">@"查看联系人"</span>;</span><br><span class="line">    <span class="comment">//    [self.navigationItem.leftBarButtonItem setTitle:@"返回"];</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置右上角的按钮</span></span><br><span class="line">    <span class="built_in">UIBarButtonItem</span> *rightBar = [[<span class="built_in">UIBarButtonItem</span> alloc] initWithTitle:<span class="string">@"编辑"</span> style:<span class="built_in">UIBarButtonItemStylePlain</span> target:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(editContact)];</span><br><span class="line">    [<span class="keyword">self</span>.navigationItem setRightBarButtonItem:rightBar];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - 右上角编辑按钮的响应方法</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)editContact</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.nameTextField.enabled) &#123; <span class="comment">// 点击的是“取消”</span></span><br><span class="line">        <span class="keyword">self</span>.nameTextField.enabled = <span class="literal">NO</span>;</span><br><span class="line">        <span class="keyword">self</span>.numberTextField.enabled = <span class="literal">NO</span>;</span><br><span class="line">        <span class="keyword">self</span>.nameTextField.text = <span class="keyword">self</span>.contact.name;</span><br><span class="line">        <span class="keyword">self</span>.numberTextField.text = <span class="keyword">self</span>.contact.number;</span><br><span class="line">        [<span class="keyword">self</span>.saveButton setHidden:<span class="literal">YES</span>];</span><br><span class="line">        <span class="keyword">self</span>.navigationItem.rightBarButtonItem.title = <span class="string">@"编辑"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// 点击的是 "编辑"</span></span><br><span class="line">        <span class="keyword">self</span>.nameTextField.enabled = <span class="literal">YES</span>;</span><br><span class="line">        <span class="keyword">self</span>.numberTextField.enabled = <span class="literal">YES</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 让文本框成为第一响应者</span></span><br><span class="line">        [<span class="keyword">self</span>.numberTextField becomeFirstResponder];</span><br><span class="line">        [<span class="keyword">self</span>.saveButton setHidden:<span class="literal">NO</span>];</span><br><span class="line">        <span class="keyword">self</span>.navigationItem.rightBarButtonItem.title = <span class="string">@"取消"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - 添加label和button</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)drawLabel</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">CGFloat</span> nameLabelX = <span class="keyword">self</span>.view.bounds.size.width / <span class="number">10.0</span>;</span><br><span class="line">    <span class="built_in">CGFloat</span> nameLabelY = <span class="number">64</span> + <span class="keyword">self</span>.view.bounds.size.width / <span class="number">10.0</span>;</span><br><span class="line">    <span class="built_in">CGFloat</span> nameLabelW = nameLabelX;</span><br><span class="line">    <span class="built_in">CGFloat</span> nameLabelH = <span class="number">20</span>;</span><br><span class="line">    <span class="built_in">UILabel</span> *nameLabel = [[<span class="built_in">UILabel</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(nameLabelX, nameLabelY, nameLabelW, nameLabelH)];</span><br><span class="line">    nameLabel.text = <span class="string">@"姓名"</span>;</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:nameLabel];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGFloat</span> numberLabelX = nameLabelX;</span><br><span class="line">    <span class="built_in">CGFloat</span> numberLabelY = nameLabelY + nameLabelH + <span class="number">20</span>;</span><br><span class="line">    <span class="built_in">CGFloat</span> numberLabelW = nameLabelW;</span><br><span class="line">    <span class="built_in">CGFloat</span> numberLabelH = nameLabelH;</span><br><span class="line">    <span class="built_in">UILabel</span> *numberLabel = [[<span class="built_in">UILabel</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(numberLabelX, numberLabelY, numberLabelW, numberLabelH)];</span><br><span class="line">    numberLabel.text = <span class="string">@"电话"</span>;</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:numberLabel];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGFloat</span> nameTextFieldX = nameLabelX + nameLabelW + <span class="number">40</span>;</span><br><span class="line">    <span class="built_in">CGFloat</span> nameTextFieldY = nameLabelY;</span><br><span class="line">    <span class="built_in">CGFloat</span> nameTextFieldW = <span class="keyword">self</span>.view.bounds.size.width / <span class="number">2.0</span>;</span><br><span class="line">    <span class="built_in">CGFloat</span> nameTextFieldH = nameLabelH;</span><br><span class="line">    <span class="built_in">UITextField</span> *nameTextField = [[<span class="built_in">UITextField</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(nameTextFieldX, nameTextFieldY, nameTextFieldW, nameTextFieldH)];</span><br><span class="line">    nameTextField.placeholder = <span class="string">@"请输入姓名(*)"</span>;</span><br><span class="line">    nameTextField.text = <span class="keyword">self</span>.contact.name;</span><br><span class="line">    nameTextField.enabled = <span class="literal">NO</span>;</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:nameTextField];</span><br><span class="line">    <span class="keyword">self</span>.nameTextField = nameTextField;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGFloat</span> numberTextFieldX = nameTextFieldX;</span><br><span class="line">    <span class="built_in">CGFloat</span> numberTextFieldY = numberLabelY;</span><br><span class="line">    <span class="built_in">CGFloat</span> numberTextFieldW = nameTextFieldW;</span><br><span class="line">    <span class="built_in">CGFloat</span> numberTextFieldH = nameLabelH;</span><br><span class="line">    <span class="built_in">UITextField</span> *numberTextField = [[<span class="built_in">UITextField</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(numberTextFieldX, numberTextFieldY, numberTextFieldW, numberTextFieldH)];</span><br><span class="line">    numberTextField.placeholder = <span class="string">@"请输入电话(*)"</span>;</span><br><span class="line">    numberTextField.text = <span class="keyword">self</span>.contact.number;</span><br><span class="line">    numberTextField.enabled = <span class="literal">NO</span>;</span><br><span class="line">    numberTextField.keyboardType = <span class="built_in">UIKeyboardTypePhonePad</span>;</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:numberTextField];</span><br><span class="line">    <span class="keyword">self</span>.numberTextField = numberTextField;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGFloat</span> saveButtonX = <span class="keyword">self</span>.view.bounds.size.width / <span class="number">2.0</span> - <span class="number">60</span>;</span><br><span class="line">    <span class="built_in">CGFloat</span> saveButtonY = numberTextFieldY + <span class="number">40</span>;</span><br><span class="line">    <span class="built_in">CGFloat</span> saveButtonW = <span class="number">120</span>;</span><br><span class="line">    <span class="built_in">CGFloat</span> saveButtonH = nameLabelH;</span><br><span class="line">    <span class="built_in">UIButton</span> *saveButton = [[<span class="built_in">UIButton</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(saveButtonX, saveButtonY, saveButtonW, saveButtonH)];</span><br><span class="line">    [saveButton setTitle:<span class="string">@"保存"</span> forState:<span class="built_in">UIControlStateNormal</span>];</span><br><span class="line">    [saveButton setTitleColor:[<span class="built_in">UIColor</span> blueColor] forState:<span class="built_in">UIControlStateNormal</span>];</span><br><span class="line">    [saveButton setEnabled:<span class="literal">NO</span>];</span><br><span class="line">    [saveButton setHidden:<span class="literal">YES</span>];</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:saveButton];</span><br><span class="line">    <span class="keyword">self</span>.saveButton = saveButton;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - 添加响应事件</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)addTarget</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 监听通知</span></span><br><span class="line">    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(textChange) name:<span class="built_in">UITextFieldTextDidChangeNotification</span> object:<span class="keyword">self</span>.nameTextField];</span><br><span class="line">    <span class="comment">// 监听通知</span></span><br><span class="line">    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(textChange) name:<span class="built_in">UITextFieldTextDidChangeNotification</span> object:<span class="keyword">self</span>.numberTextField];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 登录按钮添加响应事件</span></span><br><span class="line">    [<span class="keyword">self</span>.saveButton addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(saveContact) forControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>];</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - 调用 AddViewControllerDelegate 代理方法</span></span><br><span class="line">- (<span class="keyword">void</span>)saveContact</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 回传数据</span></span><br><span class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span>.delegate respondsToSelector:<span class="keyword">@selector</span>(editViewController:addContact:)]) &#123;</span><br><span class="line">        <span class="keyword">self</span>.contact.name = <span class="keyword">self</span>.nameTextField.text;</span><br><span class="line">        <span class="keyword">self</span>.contact.number = <span class="keyword">self</span>.numberTextField.text;</span><br><span class="line">        [<span class="keyword">self</span>.delegate editViewController:<span class="keyword">self</span> addContact:<span class="keyword">self</span>.contact];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.navigationController popViewControllerAnimated:<span class="literal">YES</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * 文本框的文字发生改变的时候调用</span><br><span class="line"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)textChange</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">self</span>.saveButton.enabled = (<span class="keyword">self</span>.nameTextField.text.length &amp;&amp; <span class="keyword">self</span>.numberTextField.text.length);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>ContactsViewController.m</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#pragma mark - 实现 editViewControllerDelegate 代理方法</span></span><br><span class="line">- (<span class="keyword">void</span>)editViewController:(EditViewController *)editViewController addContact:(Contact *)contact</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">self</span>.tableView reloadData];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实现数据存储 Contact.h</p>
<p>记得必须遵守 NSCoding 协议</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Contact</span> : <span class="title">NSObject</span> &lt;<span class="title">NSCoding</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *number;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>然后实现下面两个方法</p>
<p>Contact.m</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"Contact.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Contact</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)encodeWithCoder:(<span class="built_in">NSCoder</span> *)encoder &#123;</span><br><span class="line">    [encoder encodeObject:<span class="keyword">self</span>.name forKey:<span class="string">@"name"</span>];</span><br><span class="line">    [encoder encodeObject:<span class="keyword">self</span>.number forKey:<span class="string">@"number"</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)initWithCoder:(<span class="built_in">NSCoder</span> *)decoder &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">        <span class="keyword">self</span>.name = [decoder decodeObjectForKey:<span class="string">@"name"</span>];</span><br><span class="line">        <span class="keyword">self</span>.number = [decoder decodeObjectForKey:<span class="string">@"number"</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>数据存放的地方<br>ContactsViewController.m</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 数据存放路径</span></span><br><span class="line"><span class="meta">#define ContactsFilepath [[NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES) lastObject] stringByAppendingPathComponent:@<span class="meta-string">"contacts.data"</span>]</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    <span class="comment">// Do any additional setup after loading the view.</span></span><br><span class="line">    [<span class="keyword">self</span> loadContactData];</span><br><span class="line">    [<span class="keyword">self</span> setNavigationBar];</span><br><span class="line">    [<span class="keyword">self</span> setTableViewLine];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#pragma mark - 实现 AddViewControllerDelegate 代理方法</span></span><br><span class="line">- (<span class="keyword">void</span>)addViewController:(AddViewController *)addViewController addContact:(Contact *)contact</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">self</span>.contacts addObject:contact];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.tableView reloadData];</span><br><span class="line">    [<span class="keyword">self</span> archiverContactData];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - 实现 editViewControllerDelegate 代理方法</span></span><br><span class="line">- (<span class="keyword">void</span>)editViewController:(EditViewController *)editViewController addContact:(Contact *)contact</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">self</span>.tableView reloadData];</span><br><span class="line">    [<span class="keyword">self</span> archiverContactData];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#pragma mark - 归档数据</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)archiverContactData</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="built_in">NSKeyedArchiver</span> archiveRootObject:<span class="keyword">self</span>.contacts toFile:ContactsFilepath];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - 启动时读取数据</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)loadContactData</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">self</span>.contacts = [<span class="built_in">NSKeyedUnarchiver</span> unarchiveObjectWithFile:ContactsFilepath];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>语言调整为中文，虽然把模拟器设置成中文，可还要把工程中添加中文配置才可以</p>
<center><br><img src="http://ww2.sinaimg.cn/mw690/a9c4d5f6gw1f74tjx41xgj218y0nujv9.jpg" alt=""><br></center>

<p>更换一下删除操作后刷新表格的方式，不需要全部刷新，只要删掉一行就行</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)tableView:(<span class="built_in">UITableView</span> *)tableView commitEditingStyle:(<span class="built_in">UITableViewCellEditingStyle</span>)editingStyle forRowAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath &#123;</span><br><span class="line">    <span class="keyword">if</span> (editingStyle == <span class="built_in">UITableViewCellEditingStyleDelete</span>) &#123;</span><br><span class="line">        <span class="comment">// 1.删除数据</span></span><br><span class="line">        [<span class="keyword">self</span>.contacts removeObjectAtIndex:indexPath.row];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2.刷新表格</span></span><br><span class="line"><span class="comment">//        [self.tableView reloadData];</span></span><br><span class="line">        [<span class="keyword">self</span>.tableView deleteRowsAtIndexPaths:@[indexPath] withRowAnimation:<span class="built_in">UITableViewRowAnimationTop</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3.归档</span></span><br><span class="line">        [<span class="keyword">self</span> archiverContactData];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>


          
          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://ww2.sinaimg.cn/mw690/a9c4d5f6jw1e3siexaeopj.jpg"
               alt="Yofer Zhang" />
          <p class="site-author-name" itemprop="name">Yofer Zhang</p>
          <p class="site-description motion-element" itemprop="description">接下来自己能够坚持写博客，记录是一个好习惯</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">66</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">8</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">18</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Yofer Zhang</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"yoferzhang"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
      
      <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
      <script src="/js/src/hook-duoshuo.js?v=5.1.0"></script>
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  













  
  

  

  

  

  


</body>
</html>
